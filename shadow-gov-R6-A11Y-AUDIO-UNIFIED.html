<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Shadow Government - ULTIMATE HUMOR Edition</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script>
/* === R4-FIX PACK: Options Enhancements (H2P + Expansions) === */
(function(){
  // helper: read saved flags
  function getSavedFlags(){
    try{ return JSON.parse(localStorage.getItem('sg_selected_packs')||'{}'); }catch(e){ return {}; }
  }
  function setSavedFlags(flags){
    try{ localStorage.setItem('sg_selected_packs', JSON.stringify(flags||{})); }catch(e){}
  }
  // helper: collect packs from globals + inline JSON scripts
  function collectPacks(){
    const packs = [];
    const add = (p)=>{ if(p && p.name && !packs.find(x=>x.name===p.name)) packs.push(p); };
    // from a global registry if present
    if(Array.isArray(window.availableExpansions)) window.availableExpansions.forEach(add);
    if(Array.isArray(window.EXPANSION_REGISTRY)) window.EXPANSION_REGISTRY.forEach(add);
    if(Array.isArray(window.expansions)) window.expansions.forEach(add);
    // inline scripts (id must be known)
    ['govOpsJson','oppJson','floridaManJson','coldWarJson','probingTimeJson'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      try{ add(JSON.parse(el.textContent||'{}')); }catch(e){}
    });
    return packs;
  }
  // expose builder used when options open
  window.buildOptionsMenu = function buildOptionsMenu(){
    const menu = document.getElementById('optionsMenu');
    if(!menu) return;
    const packs = collectPacks();
    const flags = getSavedFlags();

    // current HTML (keep existing structure if it exists)
    // If menu is empty, create a minimal frame; otherwise, just append/replace sections.
    if(!menu._r4fixed){
      // leave previous content if author had custom items
      // ensure we can append to the end
      menu._r4fixed = true;
    }

    // --- Expansions section (rebuild cleanly each time) ---
    let expHolder = menu.querySelector('#optExpansionsList');
    if(!expHolder){
      const wrap = document.createElement('div');
      wrap.className = 'option-item';
      wrap.innerHTML = `<span class="option-label">Expansions</span>
        <div id="optExpansionsList"></div>`;
      menu.appendChild(wrap);
      expHolder = wrap.querySelector('#optExpansionsList');
    }
    if(!packs.length){
      expHolder.innerHTML = `<div class="no-expansions">No expansions found</div>`;
    }else{
      expHolder.innerHTML = packs.map(p=>{
        const count = (Array.isArray(p.cards) ? p.cards.length : (p.cardCount||0));
        const ic = p.icon || 'üÉè';
        const checked = flags[p.name] !== false; // default ON
        return `<label class="expansion-item" style="display:block;cursor:pointer;">
          <input type="checkbox" class="expansion-checkbox" data-pack="${p.name}" ${checked?'checked':''}>
          <span class="expansion-name">${ic} ${p.name}</span>
          <div class="expansion-description">${count} cards</div>
        </label>`;
      }).join('');
      expHolder.addEventListener('change', (e)=>{
        const t = e.target;
        if(!t || !t.matches('.expansion-checkbox')) return;
        const name = t.getAttribute('data-pack');
        flags[name] = !!t.checked;
        setSavedFlags(flags);
        if(typeof window.setExpansionEnabled === 'function'){
          window.setExpansionEnabled(name, !!t.checked);
        }
      }, { once:false });
    }

    // --- How To Play button at bottom (once) ---
    if(!menu.querySelector('#optHowToPlayBtn')){
      const div = document.createElement('div');
      div.className = 'option-item';
      div.style.textAlign = 'center';
      div.innerHTML = `<button id="optHowToPlayBtn" class="expansion-button" type="button">How to Play</button>`;
      menu.appendChild(div);
      div.querySelector('#optHowToPlayBtn').addEventListener('click', function(){
        if(typeof window.openH2PModal === 'function'){ window.openH2PModal(); }
        else{
          const btn = document.querySelector('.start-button.h2p-btn,#btnHowToPlay,[data-action="how-to-play"]');
          if(btn) btn.click();
        }
      });
    }
  };

  // hook into toggleOptions to refresh menu each open
  const prevToggle = window.toggleOptions;
  window.toggleOptions = function(){
    const menu = document.getElementById('optionsMenu');
    if(menu) window.buildOptionsMenu();
    if(typeof prevToggle === 'function') return prevToggle.apply(this, arguments);
    // fallback: toggle visibility if no previous impl
    if(menu) menu.classList.toggle('active');
  };
})();


/* === R4-FIX: AI panel visibility helper === */
window.setAIPanelVisible = function(v){
  const p = document.getElementById('aiPanel');
  if(p){
    p.style.display = v ? 'block' : 'none';
    document.body.classList.toggle('ai-visible', !!v);
  }
};
// Initialize class based on current panel state on load
(function(){
  const p = document.getElementById('aiPanel');
  const vis = p && p.style.display !== 'none';
  document.body.classList.toggle('ai-visible', !!vis);
})();


/* === R4-FIX: Rename Opposition label in UI === */
document.addEventListener('DOMContentLoaded', function(){
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
  const targets = [];
  while(walker.nextNode()){
    const n = walker.currentNode;
    if(n.nodeValue && n.nodeValue.includes('OPPOSITION OPERATIVE')) targets.push(n);
  }
  targets.forEach(n=>{ n.nodeValue = n.nodeValue.replaceAll('OPPOSITION OPERATIVE','TRUTH SEEKERS'); });
});


/* === R4-FIX: Secret Agenda PERFECT CONTROL normalization === */
(function(){
  try{
    if(Array.isArray(CONFIG?.secretAgendas)){
      const i = CONFIG.secretAgendas.findIndex(a => /PERFECT CONTROL/i.test(a.name));
      if(i>=0){
        const goal = (CONFIG?.victory?.states) || 10;
        CONFIG.secretAgendas[i].checkStateCount = goal;
        CONFIG.secretAgendas[i].requirement = `Control ${goal} states`;
      }
    }
  }catch(e){}
})();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Anton&family=Oswald:wght@700&family=Roboto+Condensed:wght@400,700&family=Courier+Prime:wght@400;700&family=Playfair+Display:wght@900&display=swap');
        
        :root {
            --ui-scale: 1;
            --font-scale: 1;
            --spacing-scale: 1;
            --color-player: #0066cc;
            --color-ai: #cc0000;
            --color-warning: #ffff00;
            --color-dark: #000;
            --color-light: #f8f8f8;
            --color-government: #1a237e;
            --color-opposition: #b71c1c;
            --color-combo: #ff00ff;
            --color-special: #00ff00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: #d4d4d4;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.03) 2px,
                    rgba(0,0,0,0.03) 4px
                );
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Screen shake animation */
        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5px, 5px); }
            20% { transform: translate(5px, -5px); }
            30% { transform: translate(-3px, 3px); }
            40% { transform: translate(3px, -3px); }
            50% { transform: translate(-2px, 2px); }
            60% { transform: translate(2px, -2px); }
            70% { transform: translate(-4px, 4px); }
            80% { transform: translate(4px, -4px); }
            90% { transform: translate(-1px, 1px); }
        }
        
        .screen-shake {
            animation: screenShake 0.5s;
        }
        
        /* Flying numbers animation */
        .flying-number {
            position: absolute;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10000;
            animation: flyUp 2s ease-out forwards;
        }
        
        .flying-number.damage {
            color: #ff0000;
        }
        
        @keyframes flyUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }
        
        /* Particle effects */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffff00;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: particle 1s ease-out forwards;
        }
        
        @keyframes particle {
            0% {
                opacity: 1;
                transform: scale(1) translate(0, 0);
            }
            100% {
                opacity: 0;
                transform: scale(0) translate(var(--x), var(--y));
            }
        }
        
        /* Combo indicator */
        .combo-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Anton', sans-serif;
            font-size: 48px;
            color: var(--color-combo);
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            z-index: 10001;
            animation: comboFlash 1s ease-out forwards;
        }
        
        @keyframes comboFlash {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.5);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(2);
            }
        }
        
        /* Phase indicator */
        .phase-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 40px;
            font-family: 'Anton', sans-serif;
            font-size: 32px;
            text-transform: uppercase;
            border: 5px solid var(--color-warning);
            z-index: 15000;
            animation: phaseSlam 0.5s ease-out;
        }
        
        @keyframes phaseSlam {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(180deg);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        /* Random event overlay */
        .random-event-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s;
        }
        
        .random-event-card {
            background: linear-gradient(135deg, #8B0000, #FF4500);
            color: white;
            padding: 40px;
            border: 5px solid #FFD700;
            max-width: 500px;
            text-align: center;
            animation: eventSlam 0.5s ease-out;
        }
        
        @keyframes eventSlam {
            0% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .random-event-title {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .random-event-text {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        /* Deck tracker */
        .deck-tracker {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border: 2px solid var(--color-warning);
            z-index: 100;
        }
        
        .deck-tracker-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .deck-tracker-item {
            font-size: 11px;
            opacity: 0.7;
        }
        
        /* State bonus indicator */
        .state-bonus-icon {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--color-special);
            border: 2px solid var(--color-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Upgrade panel */
        .upgrade-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-light);
            border: 5px solid var(--color-dark);
            padding: 30px;
            z-index: 15000;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .upgrade-title {
            font-family: 'Anton', sans-serif;
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .upgrade-option {
            background: white;
            border: 2px solid var(--color-dark);
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upgrade-option:hover {
            background: var(--color-warning);
            transform: scale(1.05);
        }
        
        .upgrade-cost {
            float: right;
            background: var(--color-ai);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        
        /* Statistics screen */
        .stats-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 25000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .stats-container {
            background: var(--color-light);
            border: 5px solid var(--color-dark);
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .stats-title {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border: 2px solid var(--color-dark);
            padding: 15px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
        }
        
        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            font-weight: bold;
        }
        
        /* Replay viewer */
        .replay-viewer {
            position: fixed;
            top: 10px;
            right: 280px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border: 3px solid var(--color-special);
            z-index: 101;
            max-width: 200px;
        }
        
        .replay-title {
            font-family: 'Oswald', sans-serif;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            color: var(--color-special);
        }
        
        .replay-entry {
            font-size: 11px;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Secret agenda card */
        .secret-agenda {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: linear-gradient(135deg, #4B0082, #8A2BE2);
            color: white;
            padding: 10px;
            border: 3px solid #FFD700;
            max-width: 200px;
            z-index: 100;
        }
        
        .secret-agenda-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .secret-agenda-text {
            font-size: 11px;
        }
        
        .secret-agenda-progress {
            margin-top: 5px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid white;
        }
        
        .secret-agenda-fill {
            height: 100%;
            background: #FFD700;
            transition: width 0.5s;
        }

        /* UI Scaling Classes */
        body.scale-small {
            --ui-scale: 0.75;
            --font-scale: 0.8;
            --spacing-scale: 0.7;
        }

        body.scale-medium {
            --ui-scale: 1;
            --font-scale: 1;
            --spacing-scale: 1;
        }

        body.scale-large {
            --ui-scale: 1.25;
            --font-scale: 1.2;
            --spacing-scale: 1.1;
        }

        /* EXPANSION SELECTION SCREEN */
        .expansion-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 25000;
        }

        .expansion-container {
            background: var(--color-light);
            border: calc(5px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(30px * var(--spacing-scale));
            max-width: calc(700px * var(--ui-scale));
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .expansion-title {
            font-family: 'Anton', sans-serif;
            font-size: calc(36px * var(--font-scale));
            text-align: center;
            margin-bottom: calc(20px * var(--spacing-scale));
            text-transform: uppercase;
        }

        .expansion-list {
            margin-bottom: calc(20px * var(--spacing-scale));
        }

        .expansion-item {
            background: white;
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(15px * var(--spacing-scale));
            margin-bottom: calc(10px * var(--spacing-scale));
            cursor: pointer;
            transition: all 0.3s;
        }

        .expansion-item:hover {
            background: var(--color-warning);
        }

        .expansion-item.selected {
            background: #90EE90;
            border-width: calc(3px * var(--ui-scale));
        }

        .expansion-checkbox {
            margin-right: calc(10px * var(--spacing-scale));
            transform: scale(calc(1.5 * var(--ui-scale)));
        }

        .expansion-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(20px * var(--font-scale));
            display: inline-block;
        }

        .expansion-description {
            font-size: calc(12px * var(--font-scale));
            color: #666;
            margin-top: calc(5px * var(--spacing-scale));
            margin-left: calc(35px * var(--spacing-scale));
        }

        .no-expansions {
            text-align: center;
            padding: calc(40px * var(--spacing-scale));
            color: #666;
            font-style: italic;
        }

        .expansion-buttons {
            display: flex;
            gap: calc(10px * var(--spacing-scale));
            justify-content: center;
        }

        .expansion-button {
            background: var(--color-dark);
            color: var(--color-light);
            border: none;
            padding: calc(15px * var(--spacing-scale)) calc(30px * var(--spacing-scale));
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(20px * var(--font-scale));
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expansion-button:hover {
            background: var(--color-ai);
            transform: scale(1.05);
        }

        /* FACTION SELECTION SCREEN */
        .faction-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30000;
        }

        .faction-container {
            display: flex;
            gap: calc(40px * var(--spacing-scale));
            padding: calc(40px * var(--spacing-scale));
            background: var(--color-light);
            border: calc(5px * var(--ui-scale)) solid var(--color-dark);
        }

        .faction-choice {
            text-align: center;
            padding: calc(30px * var(--spacing-scale));
            background: white;
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            cursor: pointer;
            transition: all 0.3s;
            min-width: calc(250px * var(--ui-scale));
        }

        .faction-choice:hover {
            transform: scale(1.05);
            box-shadow: 0 calc(20px * var(--ui-scale)) calc(40px * var(--ui-scale)) rgba(0,0,0,0.3);
        }

        .faction-choice.government {
            border-color: var(--color-government);
        }

        .faction-choice.government:hover {
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
        }

        .faction-choice.opposition {
            border-color: var(--color-opposition);
        }

        .faction-choice.opposition:hover {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .faction-icon {
            font-size: calc(64px * var(--font-scale));
            margin-bottom: calc(20px * var(--spacing-scale));
        }

        .faction-name {
            font-family: 'Anton', sans-serif;
            font-size: calc(32px * var(--font-scale));
            margin-bottom: calc(15px * var(--spacing-scale));
            text-transform: uppercase;
        }

        .faction-description {
            font-size: calc(14px * var(--font-scale));
            color: #666;
            line-height: 1.4;
        }

        .faction-bonus {
            margin-top: calc(15px * var(--spacing-scale));
            padding: calc(10px * var(--spacing-scale));
            background: var(--color-warning);
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
            font-weight: bold;
            font-size: calc(12px * var(--font-scale));
        }

        /* CARD DRAFT SCREEN */
        .draft-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 25000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .draft-container {
            background: var(--color-light);
            border: calc(5px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(30px * var(--spacing-scale));
            max-width: calc(900px * var(--ui-scale));
            width: 90%;
        }

        .draft-title {
            font-family: 'Anton', sans-serif;
            font-size: calc(36px * var(--font-scale));
            text-align: center;
            margin-bottom: calc(20px * var(--spacing-scale));
            text-transform: uppercase;
        }

        .draft-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(180px * var(--ui-scale)), 1fr));
            gap: calc(15px * var(--spacing-scale));
            margin-bottom: calc(20px * var(--spacing-scale));
        }

        .draft-card {
            background: white;
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(15px * var(--spacing-scale));
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .draft-card:hover {
            transform: translateY(calc(-10px * var(--ui-scale)));
            box-shadow: 0 calc(15px * var(--ui-scale)) calc(30px * var(--ui-scale)) rgba(0,0,0,0.3);
        }

        .draft-card.selected {
            background: var(--color-warning);
            transform: scale(1.05);
        }

        .draft-card.legendary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            animation: legendaryGlow 2s infinite;
        }

        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.9); }
        }

        .draft-card.rare {
            background: linear-gradient(135deg, #9370DB, #DDA0DD);
        }

        .draft-card.uncommon {
            background: linear-gradient(135deg, #87CEEB, #ADD8E6);
        }

        .draft-confirm {
            text-align: center;
        }

        .draft-button {
            background: var(--color-dark);
            color: var(--color-light);
            border: none;
            padding: calc(15px * var(--spacing-scale)) calc(30px * var(--spacing-scale));
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(24px * var(--font-scale));
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .draft-button:hover:not(:disabled) {
            background: var(--color-ai);
            transform: scale(1.05);
        }

        .draft-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* AI OPPONENT VISUALIZATION - MOVED TO TOP-RIGHT */
        .ai-panel {
            position: fixed;
            top: calc(60px * var(--ui-scale));
            right: calc(10px * var(--ui-scale));
            background: rgba(0,0,0,0.9);
            color: white;
            border: calc(3px * var(--ui-scale)) solid var(--color-ai);
            padding: calc(15px * var(--spacing-scale));
            z-index: 100;
            max-width: calc(250px * var(--ui-scale));
        }

        .ai-title {
            font-family: 'Oswald', sans-serif;
            font-size: calc(18px * var(--font-scale));
            margin-bottom: calc(10px * var(--spacing-scale));
            text-transform: uppercase;
            color: var(--color-ai);
        }

        .ai-hand-indicator {
            display: flex;
            gap: calc(5px * var(--spacing-scale));
            margin-bottom: calc(10px * var(--spacing-scale));
        }

        .ai-card-back {
            width: calc(30px * var(--ui-scale));
            height: calc(40px * var(--ui-scale));
            background: linear-gradient(135deg, #333, #666);
            border: calc(2px * var(--ui-scale)) solid var(--color-ai);
            border-radius: calc(3px * var(--ui-scale));
            position: relative;
        }

        .ai-card-back::after {
            content: "?";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
        }

        .ai-thinking {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* START SCREEN */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        .start-content {
            background: var(--color-light);
            border: calc(10px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(40px * var(--spacing-scale));
            text-align: center;
            max-width: calc(600px * var(--ui-scale));
            transform: rotate(-2deg);
            box-shadow: 0 calc(20px * var(--ui-scale)) calc(40px * var(--ui-scale)) rgba(0,0,0,0.5);
        }

        .start-title {
            font-family: 'Anton', sans-serif;
            font-size: calc(72px * var(--font-scale));
            text-transform: uppercase;
            letter-spacing: -4px;
            margin-bottom: calc(20px * var(--spacing-scale));
            color: var(--color-dark);
        }

        .start-subtitle {
            background: var(--color-warning);
            color: var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
            display: inline-block;
            font-weight: bold;
            font-size: calc(18px * var(--font-scale));
            transform: rotate(2deg);
            margin-bottom: calc(30px * var(--spacing-scale));
        }

        .start-button {
            background: var(--color-dark);
            color: var(--color-light);
            border: none;
            padding: calc(20px * var(--spacing-scale)) calc(40px * var(--spacing-scale));
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(28px * var(--font-scale));
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            margin: calc(10px * var(--spacing-scale));
        }

        .start-button:hover {
            background: var(--color-ai);
            transform: scale(1.1) rotate(-2deg);
        }

        /* OPTIONS MENU */
        .options-button {
            position: fixed;
            top: calc(10px * var(--ui-scale));
            right: calc(10px * var(--ui-scale));
            background: var(--color-dark);
            color: var(--color-light);
            border: calc(3px * var(--ui-scale)) solid var(--color-warning);
            padding: calc(8px * var(--spacing-scale)) calc(16px * var(--spacing-scale));
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(16px * var(--font-scale));
            cursor: pointer;
            z-index: 1000;
            text-transform: uppercase;
        }

        .options-menu {
            position: fixed;
            top: calc(50px * var(--ui-scale));
            right: calc(10px * var(--ui-scale));
            background: var(--color-light);
            border: calc(5px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(20px * var(--spacing-scale));
            z-index: 1001;
            display: none;
            box-shadow: 0 calc(10px * var(--ui-scale)) calc(30px * var(--ui-scale)) rgba(0,0,0,0.5);
            max-height: calc(500px * var(--ui-scale));
            overflow-y: auto;
            min-width: calc(250px * var(--ui-scale));
        }

        .options-menu.active {
            display: block;
        }

        .option-item {
            margin-bottom: calc(15px * var(--spacing-scale));
        }

        .option-label {
            font-weight: bold;
            margin-bottom: calc(5px * var(--spacing-scale));
            display: block;
        }

        .option-select {
            width: 100%;
            padding: calc(5px * var(--spacing-scale));
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
        }

        .option-checkbox {
            margin-right: calc(10px * var(--spacing-scale));
        }

        /* MAIN GAME CONTAINER */
        .game-container {
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
            background: var(--color-light);
        }

        .game-newspaper {
            display: grid;
            grid-template-rows: auto auto 1fr auto auto;
            height: 100%;
            overflow: hidden;
            border: calc(4px * var(--ui-scale)) solid var(--color-dark);
            background: var(--color-light);
        }

        /* Compact Header */
        .newspaper-header {
            background: var(--color-light);
            border-bottom: calc(3px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
        }

        .newspaper-logo {
            font-family: 'Anton', sans-serif;
            font-size: calc(42px * var(--font-scale));
            text-align: center;
            letter-spacing: calc(-3px * var(--font-scale));
            line-height: 1;
            text-transform: uppercase;
            color: var(--color-dark);
        }

        .newspaper-tagline {
            text-align: center;
            font-style: italic;
            font-size: calc(12px * var(--font-scale));
            margin-top: calc(5px * var(--spacing-scale));
            color: var(--color-dark);
        }

        .faction-indicator {
            text-align: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(16px * var(--font-scale));
            padding: calc(5px * var(--spacing-scale));
            margin-top: calc(5px * var(--spacing-scale));
        }

        .faction-indicator.government {
            background: var(--color-government);
            color: white;
        }

        .faction-indicator.opposition {
            background: var(--color-opposition);
            color: white;
        }

        /* Compact Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: var(--color-dark);
            color: var(--color-light);
            padding: calc(8px * var(--spacing-scale));
            border-bottom: calc(3px * var(--ui-scale)) solid var(--color-warning);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-label {
            font-size: calc(10px * var(--font-scale));
            text-transform: uppercase;
            opacity: 0.8;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(24px * var(--font-scale));
            font-weight: bold;
        }

        /* Main Content Area */
        .game-content {
            display: grid;
            grid-template-columns: 2fr 3fr 2fr;
            gap: calc(10px * var(--spacing-scale));
            padding: calc(10px * var(--spacing-scale));
            overflow: hidden;
        }

        /* Left Panel - Victory & Log */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: calc(10px * var(--spacing-scale));
            overflow: hidden;
        }

        .victory-box {
            background: var(--color-warning);
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
            color: var(--color-dark);
        }

        .victory-title {
            font-family: 'Oswald', sans-serif;
            font-size: calc(16px * var(--font-scale));
            text-transform: uppercase;
            margin-bottom: calc(8px * var(--spacing-scale));
            text-align: center;
            border-bottom: 2px solid var(--color-dark);
            padding-bottom: calc(5px * var(--spacing-scale));
        }

        .victory-item {
            margin: calc(8px * var(--spacing-scale)) 0;
            font-size: calc(12px * var(--font-scale));
        }

        .victory-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            height: calc(10px * var(--ui-scale));
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--color-dark);
            flex: 1;
            margin-left: calc(10px * var(--spacing-scale));
        }

        .progress-fill {
            height: 100%;
            background: var(--color-dark);
            transition: width 0.5s;
        }

        .log-box {
            flex: 1;
            background: var(--color-light);
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
            overflow-y: auto;
        }

        .log-title {
            font-family: 'Oswald', sans-serif;
            font-size: calc(14px * var(--font-scale));
            text-transform: uppercase;
            margin-bottom: calc(8px * var(--spacing-scale));
            border-bottom: 2px solid var(--color-dark);
            color: var(--color-dark);
        }

        .log-entry {
            font-size: calc(11px * var(--font-scale));
            padding: calc(4px * var(--spacing-scale));
            margin: calc(2px * var(--spacing-scale)) 0;
            border-left: calc(3px * var(--ui-scale)) solid #ccc;
        }

        .log-entry.player {
            border-left-color: var(--color-player);
            background: rgba(0,102,204,0.1);
        }

        .log-entry.ai {
            border-left-color: var(--color-ai);
            background: rgba(204,0,0,0.1);
        }

        .log-entry.warning {
            border-left-color: var(--color-warning);
            background: rgba(255,255,0,0.1);
            font-weight: bold;
        }
        
        .log-entry.combo {
            border-left-color: var(--color-combo);
            background: rgba(255,0,255,0.1);
            font-weight: bold;
        }
        
        .log-entry.special {
            border-left-color: var(--color-special);
            background: rgba(0,255,0,0.1);
            font-weight: bold;
        }

        /* Center Panel - Map */
        .center-panel {
            display: flex;
            flex-direction: column;
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            background: white;
        }

        .map-header {
            background: var(--color-dark);
            color: var(--color-light);
            padding: calc(8px * var(--spacing-scale));
            text-align: center;
        }

        .map-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(20px * var(--font-scale));
            text-transform: uppercase;
        }

        #usa-map {
            flex: 1;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .state {
            stroke: #333;
            stroke-width: 0.5;
            fill: #e8e8e8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .state:hover {
            stroke: var(--color-dark);
            stroke-width: 2;
        }
        
        .state.selected-state {
            fill: var(--color-warning) !important;
            stroke: var(--color-dark);
            stroke-width: 3;
        }

        .state.player-controlled {
            fill: var(--color-player);
        }

        .state.ai-controlled {
            fill: var(--color-ai);
        }

        .state.contested {
            fill: #ffa500;
            animation: contestedPulse 1s infinite;
        }
        
        .state.special-state {
            stroke: var(--color-special);
            stroke-width: 2;
        }

        @keyframes contestedPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .state-pressure-indicator {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--color-dark);
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            pointer-events: none;
        }

        /* Right Panel - Cards */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: calc(10px * var(--spacing-scale));
            overflow: hidden;
        }

        .cards-box {
            flex: 1;
            background: var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
            overflow-y: auto;
        }

        .cards-title {
            color: var(--color-light);
            font-family: 'Oswald', sans-serif;
            font-size: calc(16px * var(--font-scale));
            text-transform: uppercase;
            text-align: center;
            margin-bottom: calc(10px * var(--spacing-scale));
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(calc(140px * var(--ui-scale)), 1fr));
            gap: calc(10px * var(--spacing-scale));
        }

        .card-item {
            background: var(--color-light);
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(10px * var(--spacing-scale));
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .card-item:hover {
            transform: translateY(calc(-5px * var(--ui-scale)));
            box-shadow: 0 calc(10px * var(--ui-scale)) calc(20px * var(--ui-scale)) rgba(0,0,0,0.3);
        }

        .card-item.selected {
            background: var(--color-warning);
            transform: scale(1.05);
        }
        
        .card-item.upgraded {
            border-color: var(--color-special);
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }

        .card-item.legendary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .card-item.rare {
            background: linear-gradient(135deg, #9370DB, #DDA0DD);
        }

        .card-item.uncommon {
            background: linear-gradient(135deg, #87CEEB, #ADD8E6);
        }

        .card-cost {
            position: absolute;
            top: calc(-10px * var(--ui-scale));
            right: calc(-10px * var(--ui-scale));
            background: var(--color-ai);
            color: white;
            width: calc(28px * var(--ui-scale));
            height: calc(28px * var(--ui-scale));
            border-radius: 50%;
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: calc(14px * var(--font-scale));
        }

        .card-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(14px * var(--font-scale));
            text-transform: uppercase;
            margin-bottom: calc(5px * var(--spacing-scale));
            color: var(--color-dark);
        }

        .card-type {
            font-size: calc(9px * var(--font-scale));
            text-transform: uppercase;
            color: #666;
            margin-bottom: calc(5px * var(--spacing-scale));
        }

        .card-effect {
            font-size: calc(10px * var(--font-scale));
            line-height: 1.2;
            color: var(--color-dark);
        }
        
        .card-humor {
            font-size: calc(9px * var(--font-scale));
            font-style: italic;
            color: #666;
            margin-top: calc(5px * var(--spacing-scale));
        }
        
        .card-upgrade-indicator {
            position: absolute;
            top: calc(-10px * var(--ui-scale));
            left: calc(-10px * var(--ui-scale));
            background: var(--color-special);
            color: var(--color-dark);
            width: calc(20px * var(--ui-scale));
            height: calc(20px * var(--ui-scale));
            border-radius: 50%;
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: calc(10px * var(--font-scale));
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: calc(10px * var(--spacing-scale));
            padding: calc(15px * var(--spacing-scale));
            background: var(--color-warning);
            border-top: calc(3px * var(--ui-scale)) solid var(--color-dark);
        }

        .action-btn {
            flex: 1;
            background: var(--color-dark);
            color: var(--color-light);
            border: none;
            padding: calc(15px * var(--spacing-scale));
            font-family: 'Bebas Neue', sans-serif;
            font-size: calc(20px * var(--font-scale));
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover:not(:disabled) {
            background: var(--color-ai);
            transform: scale(1.05);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* News Ticker */
        .news-ticker {
            background: var(--color-dark);
            color: var(--color-warning);
            padding: calc(8px * var(--spacing-scale));
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            border-top: calc(2px * var(--ui-scale)) solid var(--color-warning);
        }

        .ticker-content {
            display: inline-block;
            animation: scroll 30s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* ENHANCED NEWSPAPER POPUP */
        .newspaper-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .newspaper {
            background: linear-gradient(135deg, #f4e8d0, #e8dcc0);
            color: #000;
            width: 90%;
            max-width: calc(800px * var(--ui-scale));
            max-height: 90vh;
            overflow-y: auto;
            padding: calc(30px * var(--spacing-scale));
            border: calc(5px * var(--ui-scale)) solid #000;
            position: relative;
            transform: rotate(-1deg);
            box-shadow: 0 calc(20px * var(--ui-scale)) calc(60px * var(--ui-scale)) rgba(0, 0, 0, 0.5);
            animation: newspaperSlam 0.5s ease-out;
        }

        @keyframes newspaperSlam {
            from {
                transform: scale(0.3) rotate(-180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(-1deg);
                opacity: 1;
            }
        }

        .newspaper-title {
            font-family: 'Playfair Display', serif;
            font-size: calc(48px * var(--font-scale));
            font-weight: 900;
            letter-spacing: calc(-2px * var(--font-scale));
            text-align: center;
        }

        .newspaper-subtitle {
            font-size: calc(14px * var(--font-scale));
            margin-top: calc(5px * var(--spacing-scale));
            font-style: italic;
            text-align: center;
        }

        .newspaper-date {
            font-size: calc(12px * var(--font-scale));
            margin-top: calc(10px * var(--spacing-scale));
        }

        .newspaper-price {
            position: absolute;
            top: calc(20px * var(--ui-scale));
            right: calc(30px * var(--ui-scale));
            font-size: calc(18px * var(--font-scale));
            font-weight: bold;
        }

        .headlines {
            column-count: 2;
            column-gap: calc(30px * var(--spacing-scale));
            column-rule: calc(2px * var(--ui-scale)) solid #000;
            margin-top: calc(20px * var(--spacing-scale));
        }

        .headline {
            margin-bottom: calc(20px * var(--spacing-scale));
            break-inside: avoid;
        }

        .headline-title {
            font-family: 'Playfair Display', serif;
            font-size: calc(24px * var(--font-scale));
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: calc(10px * var(--spacing-scale));
        }

        .headline-text {
            font-size: calc(13px * var(--font-scale));
            text-align: justify;
            line-height: 1.4;
        }

        .headline.breaking {
            column-span: all;
            background: #000;
            color: #fff;
            padding: calc(15px * var(--spacing-scale));
            margin: calc(20px * var(--spacing-scale)) 0;
        }

        .headline.breaking .headline-title {
            color: #fff;
            font-size: calc(32px * var(--font-scale));
        }

        .newspaper-ad {
            border: calc(2px * var(--ui-scale)) dashed #000;
            padding: calc(15px * var(--spacing-scale));
            margin: calc(20px * var(--spacing-scale)) 0;
            text-align: center;
            column-span: all;
        }

        .newspaper-ad-title {
            font-size: calc(20px * var(--font-scale));
            font-weight: bold;
            margin-bottom: calc(10px * var(--spacing-scale));
        }

        .newspaper-close {
            position: absolute;
            top: calc(20px * var(--ui-scale));
            left: calc(30px * var(--ui-scale));
            background: #ff0000;
            color: #fff;
            border: none;
            padding: calc(10px * var(--spacing-scale)) calc(20px * var(--spacing-scale));
            cursor: pointer;
            font-weight: bold;
            font-size: calc(16px * var(--font-scale));
            transform: rotate(-5deg);
            font-family: 'Courier Prime', monospace;
            transition: all 0.3s;
        }

        .newspaper-close:hover {
            transform: rotate(0deg) scale(1.1);
            box-shadow: 0 calc(5px * var(--ui-scale)) calc(20px * var(--ui-scale)) rgba(255, 0, 0, 0.5);
        }

        .state-tooltip {
            position: absolute;
            background: var(--color-warning);
            color: var(--color-dark);
            padding: calc(8px * var(--spacing-scale));
            border: calc(2px * var(--ui-scale)) solid var(--color-dark);
            font-weight: bold;
            pointer-events: none;
            z-index: 5000;
            font-size: calc(11px * var(--font-scale));
        }
        
        /* CARD PLAY ANIMATION */
        .card-play-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
        }
        
        .played-card {
            width: calc(200px * var(--ui-scale));
            background: var(--color-light);
            border: calc(5px * var(--ui-scale)) solid var(--color-dark);
            padding: calc(20px * var(--spacing-scale));
            box-shadow: 0 calc(20px * var(--ui-scale)) calc(60px * var(--ui-scale)) rgba(0,0,0,0.7);
            animation: cardSlam 1s ease-out forwards;
            position: relative;
        }
        
        @keyframes cardSlam {
            0% {
                transform: scale(0.1) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.5) rotate(5deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .played-card.legendary {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            animation: cardSlam 1s ease-out forwards, legendaryGlow 2s infinite;
        }
        
        .played-card.rare {
            background: linear-gradient(135deg, #9370DB, #DDA0DD);
        }
        
        .played-card.uncommon {
            background: linear-gradient(135deg, #87CEEB, #ADD8E6);
        }
        
        .played-card-cost {
            position: absolute;
            top: calc(-15px * var(--ui-scale));
            right: calc(-15px * var(--ui-scale));
            background: var(--color-ai);
            color: white;
            width: calc(40px * var(--ui-scale));
            height: calc(40px * var(--ui-scale));
            border-radius: 50%;
            border: calc(3px * var(--ui-scale)) solid var(--color-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: calc(18px * var(--font-scale));
        }
        
        .played-card-name {
            font-family: 'Anton', sans-serif;
            font-size: calc(24px * var(--font-scale));
            text-transform: uppercase;
            margin-bottom: calc(10px * var(--spacing-scale));
            text-align: center;
        }
        
        .played-card-effect {
            font-size: calc(14px * var(--font-scale));
            text-align: center;
            margin-bottom: calc(10px * var(--spacing-scale));
        }
        
        .played-card-flavor {
            font-style: italic;
            font-size: calc(12px * var(--font-scale));
            text-align: center;
            color: #666;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .game-content {
                grid-template-columns: 1.5fr 3fr 1.5fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .headlines {
                column-count: 1;
            }
        }
    
/* redacted effect */
.redacted{
  background:#000;color:#fff;
  font-family:'Courier Prime',monospace;font-weight:700;
  letter-spacing:2px;padding:2px 4px;display:inline-block;transform:rotate(-1deg);
}

@media (max-width:768px){
  body.scale-medium{--ui-scale:.85;--font-scale:.9;--spacing-scale:.85;}
  .start-title{font-size:calc(48px * var(--font-scale,1));}
}
@media (max-width:480px){
  body.scale-medium{--ui-scale:.7;--font-scale:.8;--spacing-scale:.7;}
  .start-title{font-size:calc(36px * var(--font-scale,1));}
}
@media (max-height:600px){
  .start-title{margin-bottom:calc(10px * var(--spacing-scale,1));}
  .start-button{padding:calc(12px * var(--spacing-scale,1)) calc(24px * var(--spacing-scale,1));}
}

/* --- Start Screen Responsive Enhancements (non-destructive) --- */
:root{ --start-zoom: 1; }

/* Override transform to include zoom, keep original rotate */
.start-screen .start-content{
  transform: rotate(-2deg) scale(var(--start-zoom,1));
  transform-origin: top center;
  width: min(92vw, calc(600px * var(--ui-scale)));
}

/* Typographic clamps to fit small screens */
.start-screen .start-title{
  font-size: clamp(32px, 9vw, 72px);
}
.start-screen .start-subtitle{
  font-size: clamp(14px, 4.2vw, 28px);
}

.start-screen .start-button{
  font-size: clamp(16px, 5vw, 28px);
  padding: calc(14px * var(--spacing-scale)) calc(26px * var(--spacing-scale));
}

/* Tighten spacing on short viewports */
@media (max-height: 640px){
  .start-screen .start-title{ margin-bottom: calc(10px * var(--spacing-scale)); }
  .start-screen .start-content{ padding: calc(24px * var(--spacing-scale)); }
}


/* --- Start Screen Centering Patch --- */
.start-screen{ padding: clamp(8px, 2vw, 24px); }
.start-screen .start-content{
  transform-origin: center center !important;
  margin: 0 auto;
}


/* --- How To Play Modal --- */
.h2p-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
.h2p-backdrop.h2p-active{ display:flex; }
.h2p-modal{
  background:#111; color:#eee; width:min(900px,92vw); max-height:86vh; overflow:auto;
  border:3px solid #fff; padding:24px; box-shadow:0 0 40px rgba(0,0,0,.6);
  transform: rotate(-1deg);
}
.h2p-modal h2{ margin:0 0 10px 0; letter-spacing:1px; }
.h2p-modal .subtitle{ color:#ff0; margin-bottom:12px; font-weight:bold; }
.h2p-hr{ border-top:2px solid #444; margin:12px 0; }
.h2p-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
.h2p-kbd{ display:inline-block; border:2px solid #fff; padding:2px 6px; margin:0 2px; background:#000; color:#fff; }
.h2p-close{
  display:inline-block; margin-top:12px; padding:10px 16px; background:#222; color:#fff; border:2px solid #fff;
  cursor:pointer; font-weight:bold;
}
.h2p-close:hover{ background:#333; }
.start-button.h2p-btn{ margin-top:10px; }


/* R4-FIX: Prevent AI panel overlap */
body.ai-visible .right-panel { margin-right: 270px; }
@media (max-width: 1200px){ body.ai-visible .right-panel { margin-right: 220px; } }
@media (max-width: 860px){ body.ai-visible .right-panel { margin-right: 190px; } }

</style>
<script>
// ==== R4 FIXED3: H2P + Options (hard override) ====
(function(){
  // --- H2P modal ensure ---
  function ensureH2P(){
    if(document.getElementById('h2pBackdrop')) return;
    const tpl = `<div class="h2p-backdrop" id="h2pBackdrop" aria-hidden="true">
      <div class="h2p-modal" role="dialog" aria-modal="true" aria-labelledby="h2pTitle">
        <h2 id="h2pTitle">HOW TO PLAY</h2>
        <div class="subtitle">A quick primer for new operatives</div>
        <div class="h2p-grid">
          <div><strong>Goal</strong><br/>Control ${ (window.CONFIG && window.CONFIG.victory && window.CONFIG.victory.states) || 10 } states, reach 200 IP, Truth ‚â• 90%, Truth ‚â§ 10% (opponent), or complete your Secret Agenda.
          <div class="h2p-hr"></div><strong>Turn Flow</strong><br/>Income ‚Üí Draw/Play ‚Üí Resolve ‚Üí Event ‚Üí End.
          <div class="h2p-hr"></div><strong>Resources</strong><br/>IP = budget, Truth = public belief, Pressure = state capture.</div>
          <div><strong>States</strong><br/>Add pressure to meet defense threshold and flip control.
          <div class="h2p-hr"></div><strong>Factions</strong><br/>Government vs Truth Seekers (Opposition).</div>
        </div>
        <button class="h2p-close" id="h2pCloseBtn">CLOSE</button>
      </div></div>`;
    document.body.insertAdjacentHTML('beforeend', tpl);
  }
  window.openH2PModal = function(){ ensureH2P(); const bd=document.getElementById('h2pBackdrop'); bd.classList.add('h2p-active'); bd.setAttribute('aria-hidden','false'); };
  window.closeH2PModal = function(){ const bd=document.getElementById('h2pBackdrop'); if(bd){ bd.classList.remove('h2p-active'); bd.setAttribute('aria-hidden','true'); } };
  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='h2pCloseBtn'){ window.closeH2PModal(); }
    if(e.target && e.target.id==='h2pBackdrop'){ window.closeH2PModal(); }
  });

  // Any button/link that *looks* like How To Play triggers immediately (text-based + ids/classes)
  document.addEventListener('click', function(e){
    const t = e.target;
    if(!t) return;
    const txt = (t.textContent||'').trim().toLowerCase();
    if (t.id==='btnH2P' || t.id==='btnHowToPlay' || t.classList.contains('h2p-btn') || /how\s*to\s*play/.test(txt)){
      e.preventDefault(); window.openH2PModal(); return false;
    }
  }, {capture:true});

  // --- Options builder (hard override) ---
  function getPacks(){
    const packs=[]; const seen=new Set();
    function add(p){ if(p && p.name && !seen.has(p.name)){ seen.add(p.name); packs.push(p);} }
    if(Array.isArray(window.availableExpansions)) window.availableExpansions.forEach(add);
    if(Array.isArray(window.EXPANSION_REGISTRY)) window.EXPANSION_REGISTRY.forEach(add);
    if(Array.isArray(window.expansions)) window.expansions.forEach(add);
    ['govOpsJson','oppJson','floridaManJson','coldWarJson','probingTimeJson'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      try{ add(JSON.parse(el.textContent||'{}')); }catch(_){}
    });
    return packs;
  }
  function getSavedFlags(){ try{ return JSON.parse(localStorage.getItem('sg_selected_packs')||'{}'); }catch(_){ return {}; } }
  function setSavedFlags(x){ try{ localStorage.setItem('sg_selected_packs', JSON.stringify(x||{})); }catch(_){ } }

  window.toggleOptionsPatched = function(){
    const menu = document.getElementById('optionsMenu'); if(!menu) return;
    // wipe and rebuild fresh every time to avoid old template (${exp.name})
    menu.innerHTML = '';
    const packs = getPacks();
    const flags = getSavedFlags();
    // Difficulty (keep simple passthrough ‚Äì actual binding is elsewhere)
    const diff = document.createElement('div'); diff.className='option-item';
    diff.innerHTML = '<span class="option-label">Difficulty</span><select class="option-select" id="optDiff"><option>Normal</option><option>Hard</option></select>';
    menu.appendChild(diff);
    // Expansions
    const exWrap = document.createElement('div'); exWrap.className='option-item';
    exWrap.innerHTML = '<span class="option-label">Expansions</span><div id="optExpansionsList"></div>';
    const list = exWrap.querySelector('#optExpansionsList');
    if(!packs.length){
      list.innerHTML = '<div class="no-expansions">No expansions found</div>';
    }else{
      list.innerHTML = packs.map(p=>{
        const count = Array.isArray(p.cards) ? p.cards.length : (p.cardCount||0);
        const ic = p.icon || 'üÉè';
        const checked = flags[p.name] !== false;
        return `<label class="expansion-item"><input type="checkbox" class="expansion-checkbox" data-pack="${p.name}" ${checked?'checked':''}><span class="expansion-name">${ic} ${p.name}</span><div class="expansion-description">${count} cards</div></label>`;
      }).join('');
      list.onchange = function(ev){
        const t = ev.target; if(!t.matches('.expansion-checkbox')) return;
        flags[t.getAttribute('data-pack')] = !!t.checked; setSavedFlags(flags);
        if(typeof window.setExpansionEnabled==='function') window.setExpansionEnabled(t.getAttribute('data-pack'), !!t.checked);
      };
    }
    menu.appendChild(exWrap);
    // H2P button
    const h2p = document.createElement('div'); h2p.className='option-item'; h2p.style.textAlign='center';
    h2p.innerHTML = '<button class="expansion-button" id="optHowToPlay">How to Play</button>';
    h2p.querySelector('#optHowToPlay').onclick = () => window.openH2PModal();
    menu.appendChild(h2p);
    // Show
    menu.classList.add('active');
  };
})();
</script>

<style>
#optionsMenu, .options-menu { display:none !important; visibility:hidden !important; }
</style>


<style>
.options-button{
  position:fixed;
  top:12px; right:12px;
  padding:10px 16px;
  font-family:'Bebas Neue', system-ui, sans-serif;
  font-size:16px; letter-spacing:1.2px; text-transform:uppercase;
  color:#eaffea;
  background:
    linear-gradient(180deg,#121518 0%, #0a0c0f 100%),
    repeating-linear-gradient(-45deg, rgba(0,255,156,0.06) 0 2px, rgba(0,0,0,0) 2px 6px);
  border:2px solid #00ff9c;
  border-radius:8px;
  text-shadow:0 0 8px rgba(0,255,156,.6);
  box-shadow:
    0 0 14px rgba(0,255,156,.25),
    inset 0 0 0 1px rgba(255,255,255,.06);
  overflow:hidden;
  z-index:1000;
}
.options-button::before{
  content:"";
  position:absolute; inset:0;
  background:radial-gradient(120% 140% at 10% 10%, rgba(0,255,156,.08), transparent 60%);
  pointer-events:none;
}
.options-button::after{
  content:"";
  position:absolute;
  left:-8%; top:45%;
  width:120%; height:38%;
  background:linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.75));
  transform:rotate(-3deg);
  border-top:1px solid rgba(0,255,156,.15);
  border-bottom:1px solid rgba(0,255,156,.15);
  pointer-events:none;
  filter:drop-shadow(0 1px 1px rgba(0,0,0,.5));
}
.options-button:hover,
.options-button:focus-visible{
  outline:none;
  box-shadow:
    0 0 22px rgba(0,255,156,.45),
    0 0 4px rgba(0,255,156,.8) inset;
  transform:translateY(-1px);
}
@keyframes crtFlicker { 0%,100%{filter:brightness(1);} 50%{filter:brightness(1.06);} }
.options-button{ animation: crtFlicker 1.8s infinite ease-in-out; }
</style>

</head>
<body class="scale-medium">
<button class="options-button" onclick="toggleOptionsPatched()">‚öôÔ∏è OPTIONS</button>

<div class="ai-panel" id="aiPanel" style="display: none;">
<div class="ai-title">AI Opponent</div>
<div>Faction: <span id="aiFaction">Unknown</span></div>
<div>Hand Size: <span id="aiHandSize">0</span></div>
<div class="ai-hand-indicator" id="aiHandIndicator"></div>
<div id="aiStatus">Waiting...</div>
<div id="aiStrategy" style="margin-top: 10px; font-size: 11px; opacity: 0.7;"></div>
</div>
<div class="deck-tracker" id="deckTracker" style="display: none;">
<div class="deck-tracker-title">DECK TRACKER</div>
<div id="deckTrackerContent"></div>
</div>
<div class="secret-agenda" id="secretAgenda" style="display: none;">
<div class="secret-agenda-title">SECRET AGENDA</div>
<div class="secret-agenda-text" id="secretAgendaText"></div>
<div class="secret-agenda-progress">
<div class="secret-agenda-fill" id="secretAgendaFill" style="width: 0%"></div>
</div>
</div>
<div class="replay-viewer" id="replayViewer" style="display: none;">
<div class="replay-title">LAST AI TURN</div>
<div id="replayContent"></div>
</div>
<div id="root"></div>
<script>
        // Global configuration - COMPLETE VERSION WITH HUMOR ENHANCEMENTS
        const CONFIG = {
            startingIP: 30,
            baseIncome: 8,
            incomePerState: 2,
            maxHandSize: 7,
            cardsPerDraft: 3,
            draftChoices: 5,
            
            statePressure: {
                required: {
                    1: 2,
                    2: 3,
                    3: 4
                }
            },
            
            factionBonuses: {
                government: {
                    startingIP: 10,
                    incomeBonus: 2,
                    description: "The Illuminati sends their regards"
                },
                opposition: {
                    truthBonus: 10,
                    cardDrawBonus: 1,
                    description: "The truth is out there (on Reddit)"
                }
            },
            
            truthEffects: {
                low: { threshold: 30, bonus: "+3 attack damage" },
                high: { threshold: 70, bonus: "+1 card draw" },
                critical: { threshold: 90, turnsToWin: 3 },
                suppressed: { threshold: 10, instant: true }
            },
            
            victory: {
                states: 10,
                ip: 200,
                truthHigh: 90,
                truthLow: 10,
                secretAgenda: true
            },
            
            stateDefense: {
                "California": 3, "Texas": 3, "Florida": 2, "New York": 3,
                "Pennsylvania": 2, "Illinois": 2, "Ohio": 1, "Georgia": 2,
                "North Carolina": 1, "Michigan": 2, "Nevada": 2, "Colorado": 1,
                "Virginia": 2, "Washington": 2, "Arizona": 1, "New Jersey": 2,
                "Tennessee": 1, "Massachusetts": 2, "Indiana": 1, "Missouri": 1,
                "Wisconsin": 1, "Minnesota": 1, "South Carolina": 1, "Alabama": 1,
                "Louisiana": 1, "Kentucky": 1, "Oregon": 1, "Oklahoma": 1,
                "Connecticut": 1, "Utah": 1, "Iowa": 1, "Arkansas": 1,
                "Mississippi": 1, "Kansas": 1, "New Mexico": 1, "Nebraska": 1,
                "West Virginia": 1, "Idaho": 1, "Hawaii": 2, "New Hampshire": 1,
                "Maine": 1, "Montana": 1, "Rhode Island": 1, "Delaware": 1,
                "South Dakota": 1, "North Dakota": 1, "Alaska": 2, "Vermont": 1,
                "Wyoming": 1
            },
            
            stateIncome: {
                3: 4,
                2: 3,
                1: 2
            },
            
            // State special effects
            specialStates: {
                "California": { type: "tech", bonus: "Draw extra card when playing tech cards" },
                "Texas": { type: "oil", bonus: "+2 IP per turn" },
                "New York": { type: "media", bonus: "Media cards cost 2 less" },
                "Florida": { type: "defense", bonus: "Immune to first attack each round" },
                "Nevada": { type: "zone", bonus: "Zone cards add +1 pressure" },
                "Washington D.C.": { type: "control", bonus: "+5 Truth manipulation" }
            },
            
            // Random events - ENHANCED WITH HUMOR
            randomEvents: [
                {
                    name: "ALIEN INVASION PANIC",
                    effect: "All zone cards cost 50% more this round",
                    type: "global"
                },
                {
                    name: "ECONOMIC CRASH",
                    effect: "Both players lose 20 IP",
                    type: "economic"
                },
                {
                    name: "MEDIA BLACKOUT",
                    effect: "Truth cannot change this round",
                    type: "media"
                },
                {
                    name: "WHISTLEBLOWER",
                    effect: "Truth +30 immediately",
                    type: "truth"
                },
                {
                    name: "GOVERNMENT SHUTDOWN",
                    effect: "No income this turn",
                    type: "economic"
                },
                {
                    name: "BIRDS AREN'T REAL REVELATION",
                    effect: "All surveillance exposed, both players draw 2 cards",
                    type: "special"
                },
                {
                    name: "5G TOWER MALFUNCTION",
                    effect: "Mind control offline, no control cards this round",
                    type: "control"
                }
            ],
            
            // Secret agendas
            secretAgendas: [
                {
                    name: "REGIONAL DOMINANCE",
                    requirement: "Control all West Coast states",
                    checkStates: ["California", "Oregon", "Washington", "Nevada", "Arizona"]
                },
                {
                    name: "ECONOMIC SUPREMACY",
                    requirement: "Have 300+ IP",
                    checkIP: 300
                },
                {
                    name: "MEDIA MONOPOLY",
                    requirement: "Play 10 media cards",
                    checkCards: { type: "media", count: 10 }
                },
                {
                    name: "PERFECT CONTROL",
                    requirement: "Control 15 states",
                    checkStateCount: 15
                },
                {
                    name: "TRUTH MANIPULATOR",
                    requirement: "Change truth by 100+ total",
                    checkTruthChange: 100
                },
                {
                    name: "LIZARD PEOPLE ALLIANCE",
                    requirement: "Control New York, California, and Texas simultaneously",
                    checkStates: ["New York", "California", "Texas"]
                }
            ]
        };

        // ENHANCED Faction-specific cards with HUMOR
        const FACTION_CARDS = {
            government: {
                legendary: [
                    { id: "GL001", name: "LIZARD PEOPLE SUMMIT", cost: 25, type: "instant",
                      effect: "All world leaders shed their skin. Gain 3 states.",
                      humor: "Finally, a legitimate reason for those weird handshakes" },
                    { id: "GL002", name: "BLACK HELICOPTER PARADE", cost: 22, type: "zone",
                      effect: "Intimidate 2 states into submission. They join you.",
                      humor: "*Fortunate Son plays menacingly in the distance*" }
                ],
                rare: [
                    { id: "GR001", name: "Weather Machine", cost: 15, type: "attack",
                      effect: "Create a hurricane. Opposition loses 20 IP.",
                      humor: "It's just a coincidence it hit during election season" },
                    { id: "GR002", name: "UFO False Flag", cost: 18, type: "media",
                      effect: "Stage alien landing. Truth -25.",
                      humor: "The aliens looked suspiciously like Dave from Props Dept" },
                    { id: "GR003", name: "MK-ULTRA 2.0", cost: 16, type: "control",
                      effect: "WiFi mind control. Steal 1 opponent card.",
                      humor: "Now with 5G compatibility!" }
                ],
                common: [
                    { id: "GC001", name: "Fluoride Delivery", cost: 5, type: "attack",
                      effect: "Pacify population. -8 IP to opponent.",
                      humor: "For dental health, we swear" },
                    { id: "GC002", name: "Redacted Document", cost: 4, type: "defensive",
                      effect: "‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà. Block next attack.",
                      humor: "The black bars are a design choice" },
                    { id: "GC003", name: "Crisis Actor Auditions", cost: 6, type: "media",
                      effect: "Hire performers. Truth -10.",
                      humor: "Method acting at its finest" }
                ]
            },
            opposition: {
                legendary: [
                    { id: "OL001", name: "TINFOIL HAT REVOLUTION", cost: 25, type: "instant",
                      effect: "Mass awakening! Gain 30 IP and 2 states.",
                      humor: "Reynolds Wrap stock price soars 500%" },
                    { id: "OL002", name: "YOUTUBE UNIVERSITY PHD", cost: 22, type: "media",
                      effect: "10-hour documentary drops. Truth +40.",
                      humor: "Comments section more toxic than Chernobyl" }
                ],
                rare: [
                    { id: "OR001", name: "Essential Oil Defense", cost: 15, type: "defensive",
                      effect: "Natural immunity to all attacks this round.",
                      humor: "Lavender blocks chemtrails, everyone knows that" },
                    { id: "OR002", name: "Flat Earth Conference", cost: 18, type: "zone",
                      effect: "Confuse everyone. Add 3 pressure to any state.",
                      humor: "Globe manufacturers hate this one trick" },
                    { id: "OR003", name: "Karen Speaks to Manager", cost: 16, type: "attack",
                      effect: "Demand to see who's in charge. Steal 15 IP.",
                      humor: "The final boss of customer service" }
                ],
                common: [
                    { id: "OC001", name: "Facebook Research", cost: 5, type: "media",
                      effect: "Share without reading. Truth +8.",
                      humor: "My aunt's friend's doctor said..." },
                    { id: "OC002", name: "Crystal Healing", cost: 4, type: "development",
                      effect: "Align chakras. +8 IP next turn.",
                      humor: "The amethyst is working, you can feel it" },
                    { id: "OC003", name: "5G Tower Protest", cost: 6, type: "attack",
                      effect: "Burn it down! Opponent -10 IP.",
                      humor: "Posted from iPhone via 5G" }
                ]
            }
        };

        // Core card database - KEPT ORIGINAL WITH HUMOR ADDITIONS
        const CARDS = {
            legendary: [
                { id: "L001", name: "ROSWELL FILES", cost: 25, type: "instant", 
                  effect: "Gain 30 IP and capture 2 random states", 
                  flavor: "The truth about 1947 finally revealed...",
                  humor: "Turns out it WAS a weather balloon... from Venus" },
                { id: "L002", name: "MK-ULTRA DOCUMENTS", cost: 22, type: "control", 
                  effect: "Control opponent's next 2 turns", 
                  flavor: "Mind control was just the beginning.",
                  humor: "Side effects may include believing birds are real" },
                { id: "L003", name: "OPERATION NORTHWOODS", cost: 28, type: "zone", 
                  effect: "Instantly capture Florida + all adjacent states", 
                  flavor: "The false flag that never flew.",
                  humor: "Florida Man was an inside job" },
                { id: "L004", name: "DEEP WEB ACCESS", cost: 24, type: "tech",
                  effect: "Draw 3 cards and reduce all costs by 5",
                  flavor: "The real internet begins here.",
                  humor: "90% of the internet is just cat videos... OR IS IT?" }
            ],
            rare: [
                { id: "R001", name: "JFK FILES", cost: 15, type: "attack", 
                  effect: "Steal 20 IP from opponent", 
                  flavor: "What really happened in Dallas?",
                  humor: "Spoiler alert: It wasn't the book depository" },
                { id: "R002", name: "AREA 51 BREACH", cost: 18, type: "zone", 
                  effect: "Add 4 pressure to Nevada instantly", 
                  flavor: "They can't stop all of us!",
                  humor: "Naruto run for +1 extra pressure" },
                { id: "R003", name: "WIKILEAKS", cost: 12, type: "media", 
                  effect: "Truth +20, opponent loses 1 card", 
                  flavor: "You've got mail... lots of it.",
                  humor: "Password was still 'password123'" },
                { id: "R004", name: "DEEP STATE CONTACT", cost: 14, type: "development", 
                  effect: "+5 IP per turn permanently", 
                  flavor: "Friends in dark places.",
                  humor: "They meet at the Applebee's on Thursdays" },
                { id: "R005", name: "COUNTER-STRIKE", cost: 10, type: "counter",
                  effect: "Counter and steal opponent's next card",
                  flavor: "Uno reverse card, government edition.",
                  humor: "No U, but with official letterhead" }
            ],
            uncommon: [
                { id: "U001", name: "Chemtrails", cost: 8, type: "attack", 
                  effect: "All opponents lose 10 IP", 
                  flavor: "Look up!",
                  humor: "They're turning the frogs gay!" },
                { id: "U002", name: "5G Control", cost: 10, type: "zone", 
                  effect: "Add 2 pressure to any state", 
                  flavor: "The towers are everywhere.",
                  humor: "Your microwave is judging you" },
                { id: "U003", name: "Birds Fake", cost: 6, type: "defensive", 
                  effect: "Hide actions for 1 round", 
                  flavor: "If it flies, it spies.",
                  humor: "Pigeons are just drones with attitude" },
                { id: "U004", name: "Moon Landing", cost: 9, type: "media", 
                  effect: "Truth changes by 15", 
                  flavor: "One small lie...",
                  humor: "Stanley Kubrick's best work" },
                { id: "U005", name: "Crisis Actors", cost: 11, type: "counter", 
                  effect: "Counter next opponent card", 
                  flavor: "Same guy, different crisis.",
                  humor: "He was also in that other thing!" }
            ],
            common: [
                { id: "C001", name: "Leaked Docs", cost: 5, type: "attack", 
                  effect: "Target loses 8 IP", 
                  flavor: "Oops, classified!",
                  humor: "Found in a Minecraft server" },
                { id: "C002", name: "Blackout", cost: 7, type: "attack", 
                  effect: "Block income next turn", 
                  flavor: "Nothing to see here.",
                  humor: "Definitely not aliens" },
                { id: "C003", name: "Bunker", cost: 4, type: "defensive", 
                  effect: "Immune this round", 
                  flavor: "Off the grid.",
                  humor: "WiFi password is 'doomsday123'" },
                { id: "C004", name: "Black Budget", cost: 3, type: "development", 
                  effect: "+10 IP next round", 
                  flavor: "Where does it go?",
                  humor: "$600 hammers and $1200 toilet seats" },
                { id: "C005", name: "Local Influence", cost: 6, type: "zone", 
                  effect: "Add 1 pressure to state", 
                  flavor: "Every town has secrets.",
                  humor: "The mayor is definitely a lizard" },
                { id: "C006", name: "False Flag", cost: 8, type: "attack", 
                  effect: "Steal 1 random state", 
                  flavor: "Problem, reaction, solution.",
                  humor: "Works every time, 60% of the time" },
                { id: "C007", name: "Disinformation", cost: 5, type: "media", 
                  effect: "Truth -10", 
                  flavor: "Repeat a lie often enough...",
                  humor: "Source: Trust me bro" }
            ]
        };

        // News headline templates - ENHANCED HUMOR
        const NEWS_TEMPLATES = {
            stateCapture: [
                "{state} Falls to {faction} After Mysterious {event}",
                "Citizens of {state} Report Strange {object} Before Takeover",
                "{state} Governor Caught {action}, State Changes Hands",
                "Breaking: {state} Now Believes {belief}"
            ],
            events: {
                government: {
                    event: ["Chemical Spill", "Power Outage", "Internet Blackout", "Mass Hypnosis"],
                    object: ["Black Helicopters", "Unmarked Vans", "Glowing Orbs", "Reptilian Sightings"],
                    action: ["Shapeshifting on Zoom", "Speaking in Binary", "Eating Live Mice", "Installing 5G"],
                    belief: ["Birds Work for the Bourgeoisie", "Sleep is Optional", "Money Isn't Real", "We Live in a Simulation"]
                },
                opposition: {
                    event: ["Mass Awakening", "Tinfoil Shortage", "WiFi Boycott", "Crystal Fair"],
                    object: ["Truth Bombs", "Red Pills", "Sacred Geometry", "Healing Crystals"],
                    action: ["Burning 5G Towers", "Drinking Raw Water", "Astral Projecting", "Fact-Checking Memes"],
                    belief: ["Everything is a Psyop", "Nature is the Only Medicine", "Math is a Conspiracy", "History Started Last Thursday"]
                }
            },
            random: [
                "Local Man Discovers {discovery}, Nobody Surprised",
                "Scientists Baffled by {phenomenon}, YouTube Experts Explain",
                "{celebrity} Reveals They're Actually {revelation}",
                "Breaking: {food} Causes {effect}, Says {source}"
            ],
            fillers: {
                discovery: ["Tap Water Tastes Weird", "Clouds Look Suspicious", "His Neighbor is a Robot", "The Earth is Actually Flat-ish"],
                phenomenon: ["People Reading Articles", "Rational Discourse", "Critical Thinking", "Agreeing to Disagree"],
                celebrity: ["Your Favorite Actor", "That One Singer", "Famous Influencer", "Reality TV Star"],
                revelation: ["Three Kids in a Trenchcoat", "A Hologram", "From Canada", "Just Very Tired"],
                food: ["Kale", "Bacon", "Gluten", "Air"],
                effect: ["Enlightenment", "Time Travel", "Spontaneous Dancing", "Temporary Immortality"],
                source: ["Facebook Mom Group", "Guy at Gas Station", "Fortune Cookie", "Dream Journal"]
            }
        };

        // Expansion pack system
        let EXPANSION_PACKS = {};
        let availableExpansions = [];
        
        // Function to load expansion pack
        function loadExpansionPack(packName, packData) {
            EXPANSION_PACKS[packName] = packData;
        }
        
        // Check for available expansion packs
        async function checkForExpansions() {
            availableExpansions = [];
            const expansionFiles = ['tech-uprising.json', 'alien-agenda.json', 'deep-state.json'];
            
            for (const file of expansionFiles) {
                try {
                    const response = await fetch(`./expansions/${file}`);
                    if (response.ok) {
                        const packData = await response.json();
                        availableExpansions.push({
                            file: file,
                            name: packData.name,
                            description: packData.description,
                            cardCount: packData.cards.length
                        });
                    }
                } catch (error) {
                }
            }
        }
        
        // Show expansion selection screen
        function showExpansionSelection() {
            const root = document.getElementById('root');
            
            let expansionHTML = '';
            if (availableExpansions.length > 0) {
                expansionHTML = availableExpansions.map((exp, i) => `
                    <div class="expansion-item" onclick="toggleExpansion(${i})" id="expansion-${i}">
                        <input type="checkbox" class="expansion-checkbox" id="exp-check-${i}" onclick="event.stopPropagation(); toggleExpansion(${i})">
                        <span class="expansion-name">${exp.name}</span>
                        <div class="expansion-description">${exp.description} (${exp.cardCount} cards)</div>
                    </div>
                `).join('');
            } else {
                expansionHTML = '<div class="no-expansions">No expansion packs found in ./expansions/ folder</div>';
            }
            
            root.innerHTML = `
                <div class="expansion-screen">
                    <div class="expansion-container">
                        <div class="expansion-title">SELECT EXPANSIONS</div>
                        <div class="expansion-list">
                            ${expansionHTML}
                        </div>
                        <div class="expansion-buttons">
                            <button class="expansion-button" onclick="skipExpansions()">PLAY WITHOUT</button>
                            ${availableExpansions.length > 0 ? 
                                '<button class="expansion-button" onclick="confirmExpansions()">CONFIRM SELECTION</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Toggle expansion selection
        function toggleExpansion(index) {
            const checkbox = document.getElementById(`exp-check-${index}`);
            const item = document.getElementById(`expansion-${index}`);
            checkbox.checked = !checkbox.checked;
            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }
        
        // Skip expansions and continue
        function skipExpansions() {
            settings.expansionsEnabled = [];
            showFactionSelection();
        }
        
        // Show How to Play guide
        function showHowToPlay() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="how-to-play-modal">
                    <div class="how-to-play-content">
                        <div class="how-to-play-title">HOW TO PLAY SHADOW GOVERNMENT</div>
                        
                        <div class="how-to-play-section">
                            <h3>üéØ OBJECTIVE</h3>
                            <p>Control America through conspiracy and propaganda! Win by:</p>
                            <ul>
                                <li><strong>State Control:</strong> Capture 10 states</li>
                                <li><strong>Economic Victory:</strong> Reach 200 IP (Influence Points)</li>
                                <li><strong>Truth Manipulation:</strong> Push truth below 10% (Government) or above 90% (Opposition)</li>
                                <li><strong>Secret Agenda:</strong> Complete your hidden objective</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üéÆ GAMEPLAY</h3>
                            <p><strong>1. Choose Your Faction:</strong></p>
                            <ul>
                                <li><strong>Government/Deep State:</strong> Control the narrative with black helicopters and lizard people. +10 starting IP.</li>
                                <li><strong>Opposition/Truth Seekers:</strong> Wake the sheeple with essential oils and YouTube. +10% starting truth.</li>
                            </ul>
                            <p><strong>2. Draft Cards:</strong> Pick 3 cards to start your conspiracy deck.</p>
                            <p><strong>3. Each Turn:</strong></p>
                            <ul>
                                <li>Play cards from your hand (costs IP)</li>
                                <li>Target states for control (zone cards)</li>
                                <li>Attack opponent or manipulate truth</li>
                                <li>End turn to draw cards and gain income</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üé¥ CARD TYPES</h3>
                            <ul>
                                <li><strong>Attack:</strong> Damage opponent's IP</li>
                                <li><strong>Zone:</strong> Add pressure to capture states</li>
                                <li><strong>Media:</strong> Change the truth level</li>
                                <li><strong>Development:</strong> Gain IP or ongoing benefits</li>
                                <li><strong>Defensive:</strong> Block attacks</li>
                                <li><strong>Control:</strong> Special manipulation effects</li>
                                <li><strong>Instant:</strong> Powerful one-time effects</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üó∫Ô∏è STATE CONTROL</h3>
                            <ul>
                                <li>Each state has a defense value (1-3)</li>
                                <li>Zone cards add pressure to states</li>
                                <li>Capture states when pressure meets defense requirement</li>
                                <li>Controlled states provide income each turn</li>
                                <li>Special states (‚òÖ) give unique bonuses</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üí∞ ECONOMY</h3>
                            <ul>
                                <li><strong>IP (Influence Points):</strong> Currency to play cards</li>
                                <li><strong>Base Income:</strong> 8 IP per turn</li>
                                <li><strong>State Income:</strong> +2-4 IP per controlled state</li>
                                <li><strong>Card Costs:</strong> Common (3-6), Uncommon (7-11), Rare (12-18), Legendary (20+)</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üî• COMBOS & UPGRADES</h3>
                            <ul>
                                <li><strong>Combo System:</strong> Play same card types in sequence for bonus damage/effects</li>
                                <li><strong>Card Upgrades:</strong> Spend 20 IP to reduce card cost by 25% (Press U)</li>
                                <li><strong>Regional Control:</strong> Control 3+ states in same region for +20 IP bonus</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>‚å®Ô∏è HOTKEYS</h3>
                            <ul>
                                <li><strong>SPACE:</strong> End turn</li>
                                <li><strong>1-7:</strong> Select card from hand</li>
                                <li><strong>U:</strong> Open upgrade menu</li>
                                <li><strong>S:</strong> View statistics</li>
                                <li><strong>Q:</strong> Quick save</li>
                                <li><strong>L:</strong> Quick load</li>
                                <li><strong>ESC:</strong> Options menu</li>
                            </ul>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üì∞ THE NEWSPAPER</h3>
                            <p>After each round, a satirical newspaper shows the consequences of your actions with humorous headlines and ads. The more absurd the better!</p>
                        </div>
                        
                        <div class="how-to-play-section">
                            <h3>üí° TIPS</h3>
                            <ul>
                                <li>Focus on low-defense states early (1 defense)</li>
                                <li>Build combos with same card types</li>
                                <li>Watch your opponent's IP and hand size</li>
                                <li>Balance offense with economy</li>
                                <li>Special states (California, Texas, New York) give powerful bonuses</li>
                                <li>Random events every 3 rounds can change the game!</li>
                                <li>Truth level affects card effectiveness</li>
                                <li>Don't forget your secret agenda for instant win!</li>
                            </ul>
                        </div>
                        
                        <button class="how-to-play-close" onclick="showStartScreen()">BACK TO MENU</button>
                    </div>
                </div>
            `;
        }
        
        // Confirm selected expansions - FIXED FOR .js FILES
        async function confirmExpansions() {
            settings.expansionsEnabled = [];
            
            for (let i = 0; i < availableExpansions.length; i++) {
                const checkbox = document.getElementById(`exp-check-${i}`);
                if (checkbox && checkbox.checked) {
                    const exp = availableExpansions[i];
                    try {
                        if (exp.isJS) {
                            // For JS files, evaluate the script
                            eval(exp.scriptText);
                            // Assume it creates a global variable with the expansion data
                            const varName = exp.name.replace(/-/g, '_').toUpperCase() + '_EXPANSION';
                            if (window[varName]) {
                                loadExpansionPack(exp.name, window[varName]);
                                settings.expansionsEnabled.push(exp.name);
                            }
                        } else {
                            // For JSON files
                            const response = await fetch(`./expansions/${exp.file}`);
                            if (!response.ok) {
                                const response2 = await fetch(`./Expansions/${exp.file}`);
                                if (response2.ok) {
                                    const packData = await response2.json();
                                    loadExpansionPack(packData.name, packData);
                                    settings.expansionsEnabled.push(packData.name);
                                }
                            } else {
                                const packData = await response.json();
                                loadExpansionPack(packData.name, packData);
                                settings.expansionsEnabled.push(packData.name);
                            }
                        }
                    } catch (error) {
                        console.error(`Failed to load ${exp.file}:`, error);
                    }
                }
            }
            
            showFactionSelection();
        }

        // Game State - COMPLETE VERSION
        let gameState = {
            phase: 'player', // player, ai, resolution, newspaper
            round: 1,
            playerFaction: null,
            aiFaction: null,
            playerIP: CONFIG.startingIP,
            aiIP: CONFIG.startingIP,
            truthLevel: 50,
            playerHand: [],
            aiHand: [],
            playerStates: [],
            aiStates: [],
            contestedStates: {},
            gameLog: [],
            selectedCard: null,
            selectedState: null,
            isGameOver: false,
            winner: null,
            mapData: null,
            roundEvents: [],
            truthCountdown: null,
            bonuses: {
                player: { attackBonus: 0, cardDraw: 0, incomeBonus: 0 },
                ai: { attackBonus: 0, cardDraw: 0, incomeBonus: 0 }
            },
            gameStarted: false,
            totalWins: 0,
            totalLosses: 0,
            cardPool: [],
            isDrafting: false,
            draftChoices: [],
            aiThinking: false,
            persistentEffects: {
                player: [],
                ai: []
            },
            winStreak: 0,
            currentTooltipTimer: null,
            
            // Enhanced features
            combo: {
                chain: 0,
                lastType: null,
                bonus: 0
            },
            deckTracker: {
                played: [],
                discarded: []
            },
            secretAgenda: null,
            secretAgendaProgress: 0,
            upgradedCards: [],
            aiPersonality: "balanced",
            currentEvent: null,
            replayBuffer: [],
            statistics: {
                cardsPlayed: 0,
                ipGained: 0,
                ipLost: 0,
                statesCaptured: 0,
                statesLost: 0,
                truthChanged: 0,
                combosAchieved: 0,
                maxCombo: 0,
                turnTime: []
            },
            savedGames: [],
            playerActions: [],
            aiActions: []
        };

        // Settings - COMPLETE VERSION
        const settings = {
            uiScale: 'medium',
            soundEnabled: false,
            animSpeed: 'normal',
            autoEndTurn: false,
            difficulty: 'normal',
            showAIPanel: true,
            expansionsEnabled: [],
            showDeckTracker: true,
            showReplay: true,
            showSecretAgenda: true,
            particlesEnabled: true,
            screenShakeEnabled: true
        };
        
        // HOTKEYS - ALL ORIGINAL FUNCTIONALITY
        document.addEventListener('keydown', function(e) {
            if (gameState.isGameOver || !gameState.gameStarted) return;
            
            switch(e.key) {
                case ' ': // Spacebar - End turn
                    e.preventDefault();
                    endPlayerTurn();
                    break;
                case 'Escape': // ESC - Toggle options
                    toggleOptions();
                    break;
                case 'u': // U - Open upgrades
                    showUpgradeMenu();
                    break;
                case 's': // S - Show stats
                    showStatistics();
                    break;
                case 'q': // Q - Quick save
                    quickSave();
                    break;
                case 'l': // L - Quick load
                    quickLoad();
                    break;
                default:
                    // Number keys 1-7 for card selection
                    const num = parseInt(e.key);
                    if (num >= 1 && num <= 7 && gameState.playerHand[num - 1]) {
                        selectCard(num - 1);
                    }
                    break;
            }
        });
        
        // Quick save/load functions
        function quickSave() {
            const saveData = JSON.stringify(gameState);
            localStorage.setItem('shadowGovQuickSave', saveData);
            addLog("Game saved!", "special");
            showFlyingText(document.body, "+SAVED", false);
        }
        
        function quickLoad() {
            const saveData = localStorage.getItem('shadowGovQuickSave');
            if (saveData) {
                gameState = JSON.parse(saveData);
                renderGame();
                addLog("Game loaded!", "special");
                showFlyingText(document.body, "+LOADED", false);
            }
        }
        
        // Show phase indicator
        function showPhaseIndicator(phase) {
            const existing = document.querySelector('.phase-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'phase-indicator';
            indicator.textContent = phase;
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 1500);
        }
        
        // Show flying text/numbers
        function showFlyingText(element, text, isDamage = false) {
            if (!settings.particlesEnabled) return;
            
            const flyingNum = document.createElement('div');
            flyingNum.className = `flying-number ${isDamage ? 'damage' : ''}`;
            flyingNum.textContent = text;
            
            const rect = element.getBoundingClientRect();
            flyingNum.style.left = rect.left + rect.width / 2 + 'px';
            flyingNum.style.top = rect.top + rect.height / 2 + 'px';
            
            document.body.appendChild(flyingNum);
            
            setTimeout(() => flyingNum.remove(), 2000);
        }
        
        // Create particle effects
        function createParticles(x, y, count = 10) {
            if (!settings.particlesEnabled) return;
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.setProperty('--x', (Math.random() - 0.5) * 100 + 'px');
                particle.style.setProperty('--y', (Math.random() - 0.5) * 100 + 'px');
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }
        
        // Screen shake effect
        function screenShake() {
            if (!settings.screenShakeEnabled) return;
            
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 500);
        }
        
        // Show combo indicator
        function showCombo(comboLevel) {
            const indicator = document.createElement('div');
            indicator.className = 'combo-indicator';
            indicator.textContent = `${comboLevel}X COMBO!`;
            
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 1000);
        }
        
        // Initialize card pool - ENHANCED WITH FACTION CARDS
        function initializeCardPool() {
            gameState.cardPool = [
                ...CARDS.legendary,
                ...CARDS.rare,
                ...CARDS.uncommon,
                ...CARDS.common
            ];
            
            // Add faction-specific cards
            if (gameState.playerFaction === 'government') {
                gameState.cardPool.push(
                    ...FACTION_CARDS.government.legendary,
                    ...FACTION_CARDS.government.rare,
                    ...FACTION_CARDS.government.common
                );
            } else {
                gameState.cardPool.push(
                    ...FACTION_CARDS.opposition.legendary,
                    ...FACTION_CARDS.opposition.rare,
                    ...FACTION_CARDS.opposition.common
                );
            }
            
            // Add expansions
            settings.expansionsEnabled.forEach(packName => {
                if (EXPANSION_PACKS[packName]) {
                    gameState.cardPool.push(...EXPANSION_PACKS[packName].cards);
                }
            });
        }

        // Draw random card from pool - ENHANCED FOR FACTIONS
        function drawCard(forAI = false) {
            const faction = forAI ? gameState.aiFaction : gameState.playerFaction;
            const pool = [];
            
            // Add base cards
            pool.push(...CARDS.legendary, ...CARDS.rare, ...CARDS.uncommon, ...CARDS.common);
            
            // Add faction-specific cards
            if (faction === 'government') {
                pool.push(...FACTION_CARDS.government.legendary);
                pool.push(...FACTION_CARDS.government.rare);
                pool.push(...FACTION_CARDS.government.common);
            } else {
                pool.push(...FACTION_CARDS.opposition.legendary);
                pool.push(...FACTION_CARDS.opposition.rare);
                pool.push(...FACTION_CARDS.opposition.common);
            }
            
            const rand = Math.random() * 100;
            let rarity;
            
            if (rand < 2) rarity = 'legendary';
            else if (rand < 10) rarity = 'rare';
            else if (rand < 30) rarity = 'uncommon';
            else rarity = 'common';
            
            const eligibleCards = pool.filter(card => {
                const cardRarity = getCardRarity(card);
                return cardRarity === rarity;
            });
            
            if (eligibleCards.length === 0) {
                return pool[Math.floor(Math.random() * pool.length)];
            }
            
            return {...eligibleCards[Math.floor(Math.random() * eligibleCards.length)]};
        }

        // Get card rarity
        function getCardRarity(card) {
            if (card.id.startsWith('L') || card.id.startsWith('GL') || card.id.startsWith('OL')) return 'legendary';
            if (card.id.startsWith('R') || card.id.startsWith('GR') || card.id.startsWith('OR')) return 'rare';
            if (card.id.startsWith('U')) return 'uncommon';
            return 'common';
        }

        // Show faction selection - ENHANCED WITH HUMOR
        function showFactionSelection() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="faction-screen">
                    <div class="faction-container">
                        <div class="faction-choice government" onclick="selectFaction('government')">
                            <div class="faction-icon">ü¶é</div>
                            <div class="faction-name">Deep State</div>
                            <div class="faction-description">
                                Control the narrative with black helicopters,
                                weather machines, and surprisingly comfortable
                                underground bunkers. The Illuminati has dental.
                            </div>
                            <div class="faction-bonus">
                                +10 Starting IP<br>
                                +2 Income Bonus<br>
                                Access to Lizard People
                            </div>
                        </div>
                        <div class="faction-choice opposition" onclick="selectFaction('opposition')">
                            <div class="faction-icon">üëÅÔ∏è</div>
                            <div class="faction-name">Truth Seekers</div>
                            <div class="faction-description">
                                Wake up the sheeple with essential oils,
                                healing crystals, and really long YouTube videos.
                                Your aunt on Facebook was right all along.
                            </div>
                            <div class="faction-bonus">
                                +10% Starting Truth<br>
                                +1 Card Draw Bonus<br>
                                Tinfoil Hat Immunity
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Select faction
        function selectFaction(faction) {
            gameState.playerFaction = faction;
            gameState.aiFaction = faction === 'government' ? 'opposition' : 'government';
            
            if (faction === 'government') {
                gameState.playerIP += CONFIG.factionBonuses.government.startingIP;
                gameState.bonuses.player.incomeBonus = CONFIG.factionBonuses.government.incomeBonus;
            } else {
                gameState.truthLevel += CONFIG.factionBonuses.opposition.truthBonus;
                gameState.bonuses.player.cardDraw = CONFIG.factionBonuses.opposition.cardDrawBonus;
            }
            
            if (gameState.aiFaction === 'government') {
                gameState.aiIP += CONFIG.factionBonuses.government.startingIP;
                gameState.bonuses.ai.incomeBonus = CONFIG.factionBonuses.government.incomeBonus;
            } else {
                gameState.bonuses.ai.cardDraw = CONFIG.factionBonuses.opposition.cardDrawBonus;
            }
            
            // Select secret agenda
            gameState.secretAgenda = CONFIG.secretAgendas[Math.floor(Math.random() * CONFIG.secretAgendas.length)];
            
            // Set AI personality based on difficulty
            if (settings.difficulty === 'easy') {
                gameState.aiPersonality = 'passive';
            } else if (settings.difficulty === 'hard') {
                gameState.aiPersonality = 'aggressive';
            } else {
                gameState.aiPersonality = 'balanced';
            }
            
            initializeCardPool();
            startDraft();
        }

        // Start card draft
        function startDraft() {
            gameState.isDrafting = true;
            gameState.draftChoices = [];
            
            for (let i = 0; i < CONFIG.draftChoices; i++) {
                gameState.draftChoices.push(drawCard());
            }
            
            showDraftScreen();
        }

        // Show draft screen
        function showDraftScreen() {
            const root = document.getElementById('root');
            const selectedCards = gameState.playerHand.length;
            const cardsNeeded = CONFIG.cardsPerDraft - selectedCards;
            
            root.innerHTML = `
                <div class="draft-overlay">
                    <div class="draft-container">
                        <div class="draft-title">
                            Draft Your Arsenal - Pick ${cardsNeeded} More
                        </div>
                        <div class="draft-cards">
                            ${gameState.draftChoices.map((card, i) => `
                                <div class="draft-card ${getCardRarity(card)} ${gameState.selectedCard === i ? 'selected' : ''}"
                                     onclick="selectDraftCard(${i})">
                                    <div class="card-cost">${card.cost}</div>
                                    <div class="card-name">${card.name}</div>
                                    <div class="card-type">[${card.type.toUpperCase()}]</div>
                                    <div class="card-effect">${card.effect}</div>
                                    ${card.humor ? `<div class="card-humor">"${card.humor}"</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="draft-confirm">
                            <button class="draft-button" onclick="confirmDraftPick()"
                                    ${gameState.selectedCard === null ? 'disabled' : ''}>
                                Confirm Selection
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Select draft card
        function selectDraftCard(index) {
            gameState.selectedCard = index;
            showDraftScreen();
        }

        // Confirm draft pick
        function confirmDraftPick() {
            if (gameState.selectedCard === null) return;
            
            const card = gameState.draftChoices[gameState.selectedCard];
            gameState.playerHand.push(card);
            
            const aiChoice = Math.floor(Math.random() * gameState.draftChoices.length);
            if (aiChoice !== gameState.selectedCard) {
                gameState.aiHand.push(gameState.draftChoices[aiChoice]);
            }
            
            gameState.selectedCard = null;
            
            if (gameState.playerHand.length >= CONFIG.cardsPerDraft) {
                gameState.isDrafting = false;
                
                while (gameState.playerHand.length < CONFIG.maxHandSize) {
                    gameState.playerHand.push(drawCard());
                }
                while (gameState.aiHand.length < CONFIG.maxHandSize) {
                    gameState.aiHand.push(drawCard(true));
                }
                
                initGame();
            } else {
                startDraft();
            }
        }

        // Initialize game
        function initGame() {
            gameState.gameStarted = true;
            gameState.phase = 'player';
            
            const easyStates = Object.entries(CONFIG.stateDefense)
                .filter(([name, def]) => def === 1)
                .map(([name]) => name);
            
            if (easyStates.length >= 2) {
                gameState.playerStates.push(easyStates[0]);
                gameState.aiStates.push(easyStates[1]);
            }
            
            updateTruthEffects();
            addLog("SHADOW GOVERNMENT ACTIVATED!", "system");
            addLog(`You are the ${gameState.playerFaction.toUpperCase()}`, "warning");
            addLog(`The ${gameState.aiFaction} opposes you`, "system");
            addLog(`Secret Agenda: ${gameState.secretAgenda.requirement}`, "special");
            addLog("Control 10 states or reach 200 IP to win!", "warning");
            
            if (settings.showAIPanel) {
                showAIPanel();
            }
            
            if (settings.showDeckTracker) {
                showDeckTracker();
            }
            
            if (settings.showSecretAgenda) {
                showSecretAgendaPanel();
            }
            
            if (settings.showReplay) {
                document.getElementById('replayViewer').style.display = 'block';
            }
            
            updateOptionsMenu();
            renderGame();
            
            if (!gameState.mapData) {
                loadMapData();
            } else {
                initMap();
            }
        }

        // Update options menu - COMPLETE VERSION
        function updateOptionsMenu() {
            const menu = document.getElementById('optionsMenu');
            
    // Build expansion list for options
    let expansionListHTML = '';
    if (Array.isArray(availableExpansions) && availableExpansions.length > 0) {
        expansionListHTML = `
        <div class="option-item">
            <label class="option-label">Expansions</label>
            ${availableExpansions.map(exp => `
                <label class="option-label" style="font-weight: normal;">
                    <input type="checkbox" class="option-checkbox" 
                           ${settings.expansionsEnabled.includes(exp.name) ? 'checked' : ''}
                           onchange="toggleExpansionInOptions('${'${'}exp.name{'}'}', this.checked)">
                    ${'${'}exp.name{'}'} <small>(${''}${'${'}exp.cardCount || 0{'}'} cards)</small>
                </label>
            `).join('')}
            <div class="option-item">
                <button class="expansion-button" onclick="applyExpansionSettings()">
                    APPLY & RESTART
                </button>
            </div>
        </div>`;
    } else {
        expansionListHTML = `
        <div class="option-item">
            <label class="option-label">Expansions</label>
            <div class="no-expansions" style="font-style: italic;">
                No expansions detected. Open Expansion Manager or load files manually.
            </div>
        </div>`;
    }
    
    menu.innerHTML = `
                <div class="option-item">
                    <label class="option-label">UI Scale</label>
                    <select class="option-select" onchange="changeUIScale(this.value)">
                        <option value="small" ${settings.uiScale === 'small' ? 'selected' : ''}>Small</option>
                        <option value="medium" ${settings.uiScale === 'medium' ? 'selected' : ''}>Medium</option>
                        <option value="large" ${settings.uiScale === 'large' ? 'selected' : ''}>Large</option>
                    </select>
                </div>
                <div class="option-item">
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" 
                               ${settings.showAIPanel ? 'checked' : ''}
                               onchange="toggleAIPanel(this.checked)">
                        Show AI Panel
                    </label>
                </div>
                <div class="option-item">
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" 
                               ${settings.showDeckTracker ? 'checked' : ''}
                               onchange="toggleDeckTracker(this.checked)">
                        Show Deck Tracker
                    </label>
                </div>
                <div class="option-item">
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" 
                               ${settings.particlesEnabled ? 'checked' : ''}
                               onchange="toggleParticles(this.checked)">
                        Particle Effects
                    </label>
                </div>
                <div class="option-item">
                    <label class="option-label">
                        <input type="checkbox" class="option-checkbox" 
                               ${settings.screenShakeEnabled ? 'checked' : ''}
                               onchange="toggleScreenShake(this.checked)">
                        Screen Shake
                    </label>
                </div>
                <div class="option-item">
                    <label class="option-label">Animation Speed</label>
                    <select class="option-select" onchange="changeAnimSpeed(this.value)">
                        <option value="instant" ${settings.animSpeed === 'instant' ? 'selected' : ''}>Instant</option>
                        <option value="fast" ${settings.animSpeed === 'fast' ? 'selected' : ''}>Fast</option>
                        <option value="normal" ${settings.animSpeed === 'normal' ? 'selected' : ''}>Normal</option>
                    </select>
                </div>
                <div class="option-item">
                    <label class="option-label">Difficulty</label>
                    <select class="option-select" onchange="changeDifficulty(this.value)">
                        <option value="easy" ${settings.difficulty === 'easy' ? 'selected' : ''}>Easy</option>
                        <option value="normal" ${settings.difficulty === 'normal' ? 'selected' : ''}>Normal</option>
                        <option value="hard" ${settings.difficulty === 'hard' ? 'selected' : ''}>Hard</option>
                    </select>
                </div>
                ${expansionListHTML}
                <div class="option-item">
                    <button class="expansion-button" onclick="showStatistics()">
                        VIEW STATS
                    </button>
                </div>
                <div class="option-item">
                    <button class="expansion-button" onclick="quickSave()">
                        QUICK SAVE
                    </button>
                </div>
                <div class="option-item">
                    <button class="expansion-button" onclick="quickLoad()">
                        QUICK LOAD
                    </button>
                </div>
            
                <div class="option-item" style="border-top: 2px solid var(--color-dark); padding-top: 15px;">
                    <button class="expansion-button" style="background: var(--color-ai); width: 100%;" 
                            onclick="returnToMainMenu()">
                        üè† MAIN MENU
                    </button>
                </div>
        `;
        }
        
        // Options menu functions - ALL ORIGINAL
        function changeUIScale(scale) {
            settings.uiScale = scale;
            document.body.className = `scale-${scale}`;
            if (gameState.mapData) {
                setTimeout(() => initMap(), 100);
            }
        }
        
        function toggleAIPanel(show) {
            settings.showAIPanel = show;
            document.getElementById('aiPanel').style.display = show ? 'block' : 'none';
        }
        
        function toggleDeckTracker(show) {
            settings.showDeckTracker = show;
            document.getElementById('deckTracker').style.display = show ? 'block' : 'none';
        }
        
        function toggleParticles(enabled) {
            settings.particlesEnabled = enabled;
        }
        
        function toggleScreenShake(enabled) {
            settings.screenShakeEnabled = enabled;
        }
        
        function changeAnimSpeed(speed) {
            settings.animSpeed = speed;
        }
        
        function changeDifficulty(diff) {
            settings.difficulty = diff;
            // Update AI personality
            if (diff === 'easy') {
                gameState.aiPersonality = 'passive';
            } else if (diff === 'hard') {
                gameState.aiPersonality = 'aggressive';
            } else {
                gameState.aiPersonality = 'balanced';
            }
        }

        // Show AI panel
        function showAIPanel() {
            const panel = document.getElementById('aiPanel');
            panel.style.display = 'block';
            updateAIPanel();
        }

        // Update AI panel - ENHANCED
        function updateAIPanel() {
            document.getElementById('aiFaction').textContent = gameState.aiFaction;
            document.getElementById('aiHandSize').textContent = gameState.aiHand.length;
            
            const handIndicator = document.getElementById('aiHandIndicator');
            handIndicator.innerHTML = '';
            
            for (let i = 0; i < gameState.aiHand.length; i++) {
                const cardBack = document.createElement('div');
                cardBack.className = 'ai-card-back';
                if (gameState.aiThinking) {
                    cardBack.classList.add('ai-thinking');
                }
                handIndicator.appendChild(cardBack);
            }
            
            document.getElementById('aiStatus').textContent = 
                gameState.aiThinking ? 'PLOTTING...' : `IP: ${gameState.aiIP}`;
                
            // Show AI strategy
            document.getElementById('aiStrategy').textContent = 
                `Strategy: ${gameState.aiPersonality.toUpperCase()}`;
        }
        
        // Show deck tracker
        function showDeckTracker() {
            const tracker = document.getElementById('deckTracker');
            tracker.style.display = 'block';
            updateDeckTracker();
        }
        
        // Update deck tracker
        function updateDeckTracker() {
            const content = document.getElementById('deckTrackerContent');
            const played = gameState.deckTracker.played.slice(-5);
            
            content.innerHTML = `
                <div class="deck-tracker-item">Cards Played: ${gameState.deckTracker.played.length}</div>
                ${played.map(card => `
                    <div class="deck-tracker-item">‚Ä¢ ${card.name}</div>
                `).join('')}
            `;
        }
        
        // Show secret agenda panel
        function showSecretAgendaPanel() {
            const panel = document.getElementById('secretAgenda');
            panel.style.display = 'block';
            updateSecretAgenda();
        }
        
        // Update secret agenda
        function updateSecretAgenda() {
            const text = document.getElementById('secretAgendaText');
            const fill = document.getElementById('secretAgendaFill');
            
            text.textContent = gameState.secretAgenda.requirement;
            
            // Check progress
            let progress = 0;
            if (gameState.secretAgenda.checkStates) {
                const controlled = gameState.secretAgenda.checkStates.filter(s => 
                    gameState.playerStates.includes(s)).length;
                progress = (controlled / gameState.secretAgenda.checkStates.length) * 100;
            } else if (gameState.secretAgenda.checkIP) {
                progress = (gameState.playerIP / gameState.secretAgenda.checkIP) * 100;
            } else if (gameState.secretAgenda.checkStateCount) {
                progress = (gameState.playerStates.length / gameState.secretAgenda.checkStateCount) * 100;
            }
            
            gameState.secretAgendaProgress = Math.min(100, progress);
            fill.style.width = gameState.secretAgendaProgress + '%';
            
            if (gameState.secretAgendaProgress >= 100) {
                endGame("SECRET AGENDA COMPLETE!", true);
            }
        }
        
        // Show upgrade menu
        function showUpgradeMenu() {
            if (gameState.playerIP < 20) {
                addLog("Need 20+ IP for upgrades!", "warning");
                return;
            }
            
            const upgradeHTML = `
                <div class="upgrade-panel">
                    <div class="upgrade-title">CARD UPGRADES</div>
                    ${gameState.playerHand.map((card, i) => {
                        const isUpgraded = gameState.upgradedCards.includes(card.id);
                        return `
                            <div class="upgrade-option ${isUpgraded ? 'upgraded' : ''}" 
                                 onclick="upgradeCard(${i})">
                                <div>${card.name}</div>
                                <div>${isUpgraded ? 'UPGRADED' : card.effect}</div>
                                <div class="upgrade-cost">${isUpgraded ? '‚úì' : '20 IP'}</div>
                            </div>
                        `;
                    }).join('')}
                    <button class="expansion-button" onclick="closeUpgradeMenu()">CLOSE</button>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.className = 'random-event-overlay';
            overlay.id = 'upgradeOverlay';
            overlay.innerHTML = upgradeHTML;
            document.body.appendChild(overlay);
        }
        
        function closeUpgradeMenu() {
            const overlay = document.getElementById('upgradeOverlay');
            if (overlay) overlay.remove();
        }
        
        function upgradeCard(index) {
            const card = gameState.playerHand[index];
            if (gameState.upgradedCards.includes(card.id)) return;
            if (gameState.playerIP < 20) return;
            
            gameState.playerIP -= 20;
            gameState.upgradedCards.push(card.id);
            
            // Enhance card effect
            card.cost = Math.max(1, Math.floor(card.cost * 0.75));
            card.name += " +";
            
            addLog(`Upgraded ${card.name}!`, "special");
            showFlyingText(event.target, "UPGRADED!", false);
            closeUpgradeMenu();
            renderGame();
        }
        
        // Show statistics
        function showStatistics() {
            const statsHTML = `
                <div class="stats-screen">
                    <div class="stats-container">
                        <div class="stats-title">GAME STATISTICS</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Wins</div>
                                <div class="stat-value">${gameState.totalWins}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Losses</div>
                                <div class="stat-value">${gameState.totalLosses}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Win Streak</div>
                                <div class="stat-value">${gameState.winStreak}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Cards Played</div>
                                <div class="stat-value">${gameState.statistics.cardsPlayed}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">States Captured</div>
                                <div class="stat-value">${gameState.statistics.statesCaptured}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Max Combo</div>
                                <div class="stat-value">${gameState.statistics.maxCombo}x</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">IP Gained</div>
                                <div class="stat-value">${gameState.statistics.ipGained}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Truth Changed</div>
                                <div class="stat-value">${Math.abs(gameState.statistics.truthChanged)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Current Round</div>
                                <div class="stat-value">${gameState.round}</div>
                            </div>
                        </div>
                        <button class="expansion-button" onclick="closeStatistics()">CLOSE</button>
                    </div>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.id = 'statsOverlay';
            overlay.innerHTML = statsHTML;
            document.body.appendChild(overlay);
        }
        
        function closeStatistics() {
            const overlay = document.getElementById('statsOverlay');
            if (overlay) overlay.remove();
        }
        
        // Random event system - ENHANCED WITH HUMOR
        function triggerRandomEvent() {
            if (gameState.round % 3 !== 0) return; // Every 3 rounds
            
            const event = CONFIG.randomEvents[Math.floor(Math.random() * CONFIG.randomEvents.length)];
            gameState.currentEvent = event;
            
            const eventHTML = `
                <div class="random-event-overlay" id="randomEventOverlay">
                    <div class="random-event-card">
                        <div class="random-event-title">‚ö†Ô∏è BREAKING NEWS ‚ö†Ô∏è</div>
                        <div class="random-event-title">${event.name}</div>
                        <div class="random-event-text">${event.effect}</div>
                        <button class="expansion-button" onclick="applyRandomEvent()">CONTINUE</button>
                    </div>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.innerHTML = eventHTML;
            document.body.appendChild(overlay.firstChild);
            
            screenShake();
        }
        
        function applyRandomEvent() {
            const event = gameState.currentEvent;
            
            switch(event.type) {
                case 'economic':
                    gameState.playerIP = Math.max(0, gameState.playerIP - 20);
                    gameState.aiIP = Math.max(0, gameState.aiIP - 20);
                    showFlyingText(document.body, "-20 IP", true);
                    break;
                case 'truth':
                    gameState.truthLevel = Math.min(100, gameState.truthLevel + 30);
                    break;
                case 'media':
                    // Block truth changes for a round
                    gameState.bonuses.player.truthBlocked = true;
                    gameState.bonuses.ai.truthBlocked = true;
                    break;
                case 'global':
                    // Increase card costs
                    gameState.bonuses.player.costIncrease = 0.5;
                    gameState.bonuses.ai.costIncrease = 0.5;
                    break;
                case 'special':
                    // Draw cards
                    gameState.playerHand.push(drawCard());
                    gameState.playerHand.push(drawCard());
                    gameState.aiHand.push(drawCard(true));
                    gameState.aiHand.push(drawCard(true));
                    break;
                case 'control':
                    // Block control cards
                    gameState.bonuses.player.controlBlocked = true;
                    gameState.bonuses.ai.controlBlocked = true;
                    break;
            }
            
            addLog(`EVENT: ${event.name}!`, "warning");
            document.getElementById('randomEventOverlay').remove();
        }

        // Update truth effects
        function updateTruthEffects() {
            const truth = gameState.truthLevel;
            
            gameState.bonuses.player.attackBonus = 0;
            
            if (truth <= CONFIG.truthEffects.low.threshold) {
                gameState.bonuses.player.attackBonus = 3;
                addLog("TRUTH SUPPRESSED: +3 attack!", "warning");
            }
            
            if (truth >= CONFIG.truthEffects.high.threshold) {
                gameState.bonuses.player.cardDraw += 1;
                addLog("TRUTH EMERGING: +1 card!", "warning");
            }
            
            if (truth >= CONFIG.truthEffects.critical.threshold && !gameState.truthCountdown) {
                gameState.truthCountdown = CONFIG.truthEffects.critical.turnsToWin;
                addLog(`CRITICAL! Win in ${gameState.truthCountdown} turns!`, "warning");
            }
            
            if (truth <= CONFIG.truthEffects.suppressed.threshold && CONFIG.truthEffects.suppressed.instant) {
                endGame("TOTAL SUPPRESSION ACHIEVED!", true);
            }
        }

        // Add to game log
        function addLog(message, type = "system") {
            gameState.gameLog.unshift({ 
                message, 
                type, 
                round: gameState.round,
                timestamp: new Date().toLocaleTimeString()
            });
            if (gameState.gameLog.length > 50) {
                gameState.gameLog = gameState.gameLog.slice(0, 50);
            }
        }

        // Select card
        function selectCard(index) {
            const card = gameState.playerHand[index];
            const cost = gameState.upgradedCards.includes(card.id) ? 
                Math.floor(card.cost * 0.75) : card.cost;
                
            if (gameState.playerIP < cost) {
                addLog(`Need ${cost} IP!`, "warning");
                return;
            }
            gameState.selectedCard = index;
            renderGame();
        }

        // Select state on map
        function selectState(stateName) {
            const states = Object.keys(CONFIG.stateDefense);
            if (!states.includes(stateName)) return;
            
            // Toggle selection
            if (gameState.selectedState === stateName) {
                gameState.selectedState = null;
                addLog(`Deselected ${stateName}`, "system");
            } else {
                gameState.selectedState = stateName;
                const defense = CONFIG.stateDefense[stateName];
                
                // Check for special state bonuses
                if (CONFIG.specialStates[stateName]) {
                    const special = CONFIG.specialStates[stateName];
                    addLog(`${stateName}: ${special.bonus}`, "special");
                }
                
                addLog(`Selected ${stateName} (Defense: ${defense})`, "system");
            }
            
            // Update map highlighting
            if (gameState.mapData) {
                d3.selectAll(".state").classed("selected-state", function(d) {
                    return d.properties.name === gameState.selectedState;
                });
            }
            
            renderGame();
        }

        // Play selected card - ENHANCED WITH COMBOS AND HUMOR
        function playCard() {
            if (gameState.selectedCard === null || gameState.phase !== 'player') return;
            
            const card = gameState.playerHand[gameState.selectedCard];
            const isUpgraded = gameState.upgradedCards.includes(card.id);
            const cost = isUpgraded ? Math.floor(card.cost * 0.75) : card.cost;
            
            if (gameState.playerIP < cost) {
                addLog("Not enough IP!", "warning");
                return;
            }
            
            if (card.type === 'zone' && !gameState.selectedState) {
                addLog("Select a state first!", "warning");
                return;
            }
            
            // Check for combo
            if (gameState.combo.lastType === card.type) {
                gameState.combo.chain++;
                gameState.combo.bonus = gameState.combo.chain * 5;
                showCombo(gameState.combo.chain);
                addLog(`${gameState.combo.chain}X COMBO! +${gameState.combo.bonus} bonus!`, "combo");
                gameState.statistics.combosAchieved++;
                gameState.statistics.maxCombo = Math.max(gameState.statistics.maxCombo, gameState.combo.chain);
            } else {
                gameState.combo.chain = 1;
                gameState.combo.bonus = 0;
            }
            gameState.combo.lastType = card.type;
            
            // Show card animation
            showCardPlayAnimation(card, 'player');
            
            // Screen shake for legendary cards
            if (getCardRarity(card) === 'legendary') {
                screenShake();
            }
            
            gameState.playerIP -= cost;
            applyCardEffect(card, 'player');
            
            // Track statistics
            gameState.statistics.cardsPlayed++;
            gameState.deckTracker.played.push(card);
            updateDeckTracker();
            
            gameState.roundEvents.push({
                cardName: card.name,
                player: 'player',
                flavor: card.humor || card.flavor,
                effect: card.effect
            });
            gameState.playerActions.push(card);
            
            gameState.playerHand.splice(gameState.selectedCard, 1);
            gameState.selectedCard = null;
            
            addLog(`Played ${card.name}!`, "player");
            checkWinConditions();
            updateSecretAgenda();
            renderGame();
        }
        
        // Show card play animation
        function showCardPlayAnimation(card, player) {
            const overlay = document.createElement('div');
            overlay.className = 'card-play-overlay';
            
            const rarity = getCardRarity(card);
            const cardEl = document.createElement('div');
            cardEl.className = `played-card ${rarity}`;
            cardEl.innerHTML = `
                <div class="played-card-cost">${card.cost}</div>
                <div class="played-card-name">${card.name}</div>
                <div class="played-card-effect">${card.effect}</div>
                ${card.humor ? `<div class="played-card-flavor">"${card.humor}"</div>` : 
                  card.flavor ? `<div class="played-card-flavor">"${card.flavor}"</div>` : ''}
            `;
            
            overlay.appendChild(cardEl);
            document.body.appendChild(overlay);
            
            // Create particles around the card
            const rect = cardEl.getBoundingClientRect();
            createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, 20);
            
            // Remove after animation
            setTimeout(() => {
                overlay.remove();
            }, 2000);
        }

        // Apply card effects - ENHANCED WITH HUMOR
        function applyCardEffect(card, player) {
            const isPlayer = player === 'player';
            const bonus = isPlayer ? gameState.bonuses.player : gameState.bonuses.ai;
            const comboBonus = isPlayer ? gameState.combo.bonus : 0;
            
            switch(card.type) {
                case 'attack':
                    const damage = parseInt(card.effect.match(/\d+/)?.[0] || 10) + bonus.attackBonus + comboBonus;
                    if (isPlayer) {
                        gameState.aiIP = Math.max(0, gameState.aiIP - damage);
                        showFlyingText(document.querySelector('.ai-panel'), `-${damage}`, true);
                        addLog(`AI -${damage} IP!`, "player");
                        gameState.statistics.ipLost += damage;
                    } else {
                        gameState.playerIP = Math.max(0, gameState.playerIP - damage);
                        addLog(`You -${damage} IP!`, "ai");
                    }
                    break;
                    
                case 'zone':
                    if (gameState.selectedState || !isPlayer) {
                        const state = isPlayer ? gameState.selectedState : 
                            Object.keys(CONFIG.stateDefense).filter(s => 
                                !gameState.playerStates.includes(s) && !gameState.aiStates.includes(s)
                            )[Math.floor(Math.random() * 10)];
                        
                        if (!state) break;
                        
                        const defense = CONFIG.stateDefense[state];
                        
                        if (gameState.playerStates.includes(state) || gameState.aiStates.includes(state)) {
                            addLog(`${state} already controlled!`, "warning");
                            return;
                        }
                        
                        if (!gameState.contestedStates[state]) {
                            gameState.contestedStates[state] = {
                                attacker: isPlayer ? 'player' : 'ai',
                                pressure: 0,
                                required: CONFIG.statePressure.required[defense] || 2
                            };
                        }
                        
                        const contest = gameState.contestedStates[state];
                        let pressureAdded = card.name.includes("Local") ? 1 : 
                                          card.name.includes("AREA 51") ? 4 : 
                                          card.name.includes("Flat Earth") ? 3 : 2;
                        
                        // Check for Nevada zone bonus
                        if (state === "Nevada" && gameState.playerStates.includes("Nevada")) {
                            pressureAdded += 1;
                        }
                        
                        // Add combo bonus
                        pressureAdded += Math.floor(comboBonus / 10);
                        
                        if (contest.attacker === (isPlayer ? 'player' : 'ai')) {
                            contest.pressure += pressureAdded;
                            addLog(`${state}: ${contest.pressure}/${contest.required} pressure`, 
                                   isPlayer ? "player" : "ai");
                            
                            if (contest.pressure >= contest.required) {
                                if (isPlayer) {
                                    gameState.playerStates.push(state);
                                    gameState.statistics.statesCaptured++;
                                } else {
                                    gameState.aiStates.push(state);
                                    gameState.statistics.statesLost++;
                                }
                                delete gameState.contestedStates[state];
                                addLog(`CAPTURED ${state}!`, isPlayer ? "player" : "ai");
                                
                                // Apply special state effects
                                if (CONFIG.specialStates[state]) {
                                    const special = CONFIG.specialStates[state];
                                    addLog(`${state} BONUS: ${special.bonus}!`, "special");
                                    applyStateBonus(state, isPlayer);
                                }
                                
                                // Check state alliances
                                checkStateAlliances(state, isPlayer);
                                
                                gameState.truthLevel += isPlayer ? -5 : 5;
                                gameState.truthLevel = Math.max(0, Math.min(100, gameState.truthLevel));
                                
                                // Update map
                                if (gameState.mapData) {
                                    initMap();
                                }
                            }
                        }
                    }
                    break;
                    
                case 'media':
                    if (gameState.bonuses.player.truthBlocked) {
                        addLog("Truth changes blocked this round!", "warning");
                        break;
                    }
                    const truthChange = parseInt(card.effect.match(/\d+/)?.[0] || 15) + comboBonus;
                    const direction = card.effect.includes('+') ? 1 : -1;
                    const oldTruth = gameState.truthLevel;
                    gameState.truthLevel += truthChange * direction * (isPlayer ? 1 : -1);
                    
                    // Apply New York media bonus
                    if (isPlayer && gameState.playerStates.includes("New York")) {
                        gameState.truthLevel += 5 * direction;
                    }
                    
                    gameState.truthLevel = Math.max(0, Math.min(100, gameState.truthLevel));
                    gameState.statistics.truthChanged += Math.abs(gameState.truthLevel - oldTruth);
                    addLog(`Truth: ${gameState.truthLevel}%`, "system");
                    updateTruthEffects();
                    break;
                    
                case 'development':
                    const ipGain = parseInt(card.effect.match(/\d+/)?.[0] || 10) + comboBonus;
                    if (card.effect.includes('per turn')) {
                        const effect = {
                            type: 'income',
                            value: ipGain,
                            source: card.name
                        };
                        if (isPlayer) {
                            gameState.persistentEffects.player.push(effect);
                        } else {
                            gameState.persistentEffects.ai.push(effect);
                        }
                        addLog(`+${ipGain} IP per turn!`, isPlayer ? "player" : "ai");
                    } else {
                        if (isPlayer) {
                            gameState.playerIP += ipGain;
                            gameState.statistics.ipGained += ipGain;
                            showFlyingText(document.body, `+${ipGain} IP`, false);
                            addLog(`+${ipGain} IP!`, "player");
                        } else {
                            gameState.aiIP += ipGain;
                        }
                    }
                    break;
                    
                case 'counter':
                    addLog("Ready to counter next card!", isPlayer ? "player" : "ai");
                    break;
                    
                case 'control':
                    if (gameState.bonuses.player.controlBlocked) {
                        addLog("Control cards blocked this round!", "warning");
                        break;
                    }
                    // Special control effects
                    if (card.name.includes("MK-ULTRA")) {
                        if (gameState.aiHand.length > 0 && isPlayer) {
                            const stolen = gameState.aiHand.pop();
                            gameState.playerHand.push(stolen);
                            addLog(`Stole ${stolen.name} from AI!`, "player");
                        }
                    }
                    break;
                    
                case 'tech':
                    // Tech cards with California bonus
                    if (isPlayer && gameState.playerStates.includes("California")) {
                        gameState.playerHand.push(drawCard());
                        addLog("California bonus: Drew extra card!", "special");
                    }
                    // Deep Web Access effect
                    if (card.id === "L004") {
                        for (let i = 0; i < 3; i++) {
                            if (isPlayer) gameState.playerHand.push(drawCard());
                            else gameState.aiHand.push(drawCard(true));
                        }
                    }
                    break;
                    
                case 'instant':
                    // Special legendary effects
                    if (card.id === "L001" || card.id === "GL001") { // Roswell Files or Lizard Summit
                        if (isPlayer) {
                            gameState.playerIP += 30;
                            const available = Object.entries(CONFIG.stateDefense)
                                .filter(([name]) => !gameState.playerStates.includes(name) && 
                                                   !gameState.aiStates.includes(name))
                                .sort(([,a], [,b]) => a - b)
                                .slice(0, card.id === "GL001" ? 3 : 2);
                            
                            available.forEach(([state]) => {
                                gameState.playerStates.push(state);
                                gameState.statistics.statesCaptured++;
                                addLog(`Captured ${state}!`, "player");
                            });
                        }
                    } else if (card.id === "OL001") { // Tinfoil Hat Revolution
                        if (isPlayer) {
                            gameState.playerIP += 30;
                            const available = Object.entries(CONFIG.stateDefense)
                                .filter(([name]) => !gameState.playerStates.includes(name) && 
                                                   !gameState.aiStates.includes(name))
                                .sort(([,a], [,b]) => a - b)
                                .slice(0, 2);
                            
                            available.forEach(([state]) => {
                                gameState.playerStates.push(state);
                                gameState.statistics.statesCaptured++;
                                addLog(`${state} awakened!`, "player");
                            });
                        }
                    }
                    break;
                    
                case 'defensive':
                    addLog("Protected this round!", isPlayer ? "player" : "ai");
                    if (card.name.includes("Essential Oil")) {
                        addLog("Smells like lavender and paranoia!", "special");
                    }
                    break;
            }
        }
        
        // Apply state bonus
        function applyStateBonus(state, isPlayer) {
            if (!CONFIG.specialStates[state]) return;
            const special = CONFIG.specialStates[state];
            
            switch(special.type) {
                case 'tech':
                    // Already handled in card effects
                    break;
                case 'oil':
                    if (isPlayer) {
                        gameState.bonuses.player.incomeBonus += 2;
                    } else {
                        gameState.bonuses.ai.incomeBonus += 2;
                    }
                    break;
                case 'media':
                    // Cost reduction handled in card selection
                    break;
                case 'defense':
                    // Immunity handled in attack effects
                    break;
                case 'zone':
                    // Pressure bonus handled in zone effects
                    break;
                case 'control':
                    // Truth bonus handled in media effects
                    break;
            }
        }
        
        // Check state alliances (neighboring states bonus)
        function checkStateAlliances(newState, isPlayer) {
            // Simplified neighbor check - states in same region get bonuses
            const regions = {
                westCoast: ["California", "Oregon", "Washington", "Nevada"],
                eastCoast: ["New York", "New Jersey", "Massachusetts", "Connecticut"],
                south: ["Texas", "Florida", "Georgia", "Louisiana"],
                midwest: ["Illinois", "Michigan", "Wisconsin", "Minnesota"]
            };
            
            for (const [regionName, states] of Object.entries(regions)) {
                if (states.includes(newState)) {
                    const controlled = states.filter(s => 
                        isPlayer ? gameState.playerStates.includes(s) : 
                        gameState.aiStates.includes(s)
                    );
                    
                    if (controlled.length >= 3) {
                        addLog(`REGIONAL DOMINANCE: ${regionName}!`, "special");
                        if (isPlayer) {
                            gameState.playerIP += 20;
                            showFlyingText(document.body, "+20 REGIONAL BONUS", false);
                        } else {
                            gameState.aiIP += 20;
                        }
                    }
                }
            }
        }

        // End player turn - ENHANCED
        function endPlayerTurn() {
            if (gameState.phase !== 'player') return;
            
            gameState.phase = 'ai';
            showPhaseIndicator('AI PLOTTING...');
            
            setTimeout(() => {
                aiTurn();
            }, 1500);
        }

        // AI turn - ENHANCED WITH PERSONALITIES
        function aiTurn() {
            gameState.aiThinking = true;
            gameState.replayBuffer = [];
            updateAIPanel();
            
            setTimeout(() => {
                if (gameState.aiHand.length === 0) {
                    gameState.aiThinking = false;
                    updateAIPanel();
                    endRound();
                    return;
                }
                
                const affordableCards = gameState.aiHand.filter(c => c.cost <= gameState.aiIP);
                
                if (affordableCards.length > 0) {
                    // AI strategy based on personality
                    affordableCards.sort((a, b) => {
                        let aScore = 0, bScore = 0;
                        
                        switch(gameState.aiPersonality) {
                            case 'aggressive':
                                if (a.type === 'attack') aScore += 15;
                                if (b.type === 'attack') bScore += 15;
                                if (a.type === 'zone') aScore += 10;
                                if (b.type === 'zone') bScore += 10;
                                break;
                                
                            case 'passive':
                                if (a.type === 'defensive') aScore += 15;
                                if (b.type === 'defensive') bScore += 15;
                                if (a.type === 'development') aScore += 10;
                                if (b.type === 'development') bScore += 10;
                                break;
                                
                            case 'balanced':
                                // Original balanced strategy
                                if (gameState.playerStates.length > gameState.aiStates.length) {
                                    if (a.type === 'zone') aScore += 10;
                                    if (b.type === 'zone') bScore += 10;
                                }
                                
                                if (gameState.playerIP > 50) {
                                    if (a.type === 'attack') aScore += 8;
                                    if (b.type === 'attack') bScore += 8;
                                }
                                break;
                        }
                        
                        // Universal strategy adjustments
                        if (gameState.truthLevel > 70 || gameState.truthLevel < 30) {
                            if (a.type === 'media') aScore += 7;
                            if (b.type === 'media') bScore += 7;
                        }
                        
                        // Consider cost efficiency
                        aScore += (10 - a.cost) * 0.5;
                        bScore += (10 - b.cost) * 0.5;
                        
                        return bScore - aScore;
                    });
                    
                    const card = affordableCards[0];
                    const cardIndex = gameState.aiHand.indexOf(card);
                    
                    gameState.aiIP -= card.cost;
                    
                    // Record for replay
                    gameState.replayBuffer.push({
                        card: card.name,
                        cost: card.cost,
                        type: card.type,
                        effect: card.effect
                    });
                    
                    if (card.type === 'zone') {
                        const targetStates = Object.entries(CONFIG.stateDefense)
                            .filter(([name]) => !gameState.aiStates.includes(name) && 
                                              !gameState.playerStates.includes(name))
                            .sort(([,a], [,b]) => a - b);
                        if (targetStates.length > 0) {
                            gameState.selectedState = targetStates[0][0];
                        }
                    }
                    
                    // Show card animation for AI
                    showCardPlayAnimation(card, 'ai');
                    
                    applyCardEffect(card, 'ai');
                    gameState.aiHand.splice(cardIndex, 1);
                    
                    addLog(`AI: ${card.name}!`, "ai");
                    
                    gameState.roundEvents.push({
                        cardName: card.name,
                        player: 'ai',
                        flavor: card.humor || card.flavor,
                        effect: card.effect
                    });
                    gameState.aiActions.push(card);
                } else {
                    addLog("AI passes", "ai");
                    gameState.replayBuffer.push({ action: "pass" });
                }
                
                gameState.aiThinking = false;
                updateAIPanel();
                updateReplay();
                checkWinConditions();
                
                setTimeout(() => {
                    endRound();
                }, 1000);
            }, settings.animSpeed === 'instant' ? 100 : settings.animSpeed === 'fast' ? 500 : 1500);
        }
        
        // Update replay viewer
        function updateReplay() {
            const content = document.getElementById('replayContent');
            content.innerHTML = gameState.replayBuffer.map(action => {
                if (action.action === "pass") {
                    return '<div class="replay-entry">AI Passed</div>';
                }
                return `<div class="replay-entry">
                    ${action.card} (${action.cost} IP)<br>
                    <small>${action.type}: ${action.effect}</small>
                </div>`;
            }).join('');
        }

        // End round - ENHANCED
        function endRound() {
            gameState.phase = 'newspaper';
            
            // Process contested states
            Object.entries(gameState.contestedStates).forEach(([state, contest]) => {
                // States can be captured mid-turn now
            });
            
            // Clear event effects
            gameState.bonuses.player.truthBlocked = false;
            gameState.bonuses.ai.truthBlocked = false;
            gameState.bonuses.player.costIncrease = 0;
            gameState.bonuses.ai.costIncrease = 0;
            gameState.bonuses.player.controlBlocked = false;
            gameState.bonuses.ai.controlBlocked = false;
            
            // Calculate income with state bonuses
            let playerIncome = CONFIG.baseIncome + gameState.bonuses.player.incomeBonus;
            let aiIncome = CONFIG.baseIncome + gameState.bonuses.ai.incomeBonus;
            
            // Add income from states based on their value
            gameState.playerStates.forEach(state => {
                const defense = CONFIG.stateDefense[state];
                playerIncome += CONFIG.stateIncome[defense] || 2;
                
                // Texas oil bonus
                if (state === "Texas") {
                    playerIncome += 2;
                }
            });
            
            gameState.aiStates.forEach(state => {
                const defense = CONFIG.stateDefense[state];
                aiIncome += CONFIG.stateIncome[defense] || 2;
                
                if (state === "Texas") {
                    aiIncome += 2;
                }
            });
            
            // Apply persistent effects
            gameState.persistentEffects.player.forEach(effect => {
                if (effect.type === 'income') {
                    playerIncome += effect.value;
                }
            });
            
            gameState.persistentEffects.ai.forEach(effect => {
                if (effect.type === 'income') {
                    aiIncome += effect.value;
                }
            });
            
            // Block income if event active
            if (gameState.currentEvent && gameState.currentEvent.type === 'economic') {
                playerIncome = 0;
                aiIncome = 0;
            }
            
            gameState.playerIP += playerIncome;
            gameState.aiIP += aiIncome;
            gameState.statistics.ipGained += playerIncome;
            
            showFlyingText(document.body, `+${playerIncome} IP`, false);
            addLog(`+${playerIncome} IP income`, "player");
            
            // Draw cards
            const cardsToDraw = 1 + gameState.bonuses.player.cardDraw;
            for (let i = 0; i < cardsToDraw && gameState.playerHand.length < CONFIG.maxHandSize; i++) {
                gameState.playerHand.push(drawCard());
            }
            
            const aiCardsToDraw = 1 + gameState.bonuses.ai.cardDraw;
            for (let i = 0; i < aiCardsToDraw && gameState.aiHand.length < CONFIG.maxHandSize; i++) {
                gameState.aiHand.push(drawCard(true));
            }
            
            // Show newspaper
            showNewspaper();
        }

        // Generate newspaper headlines - ENHANCED HUMOR
        function generateNewspaperContent() {
            const headlines = [];
            
            // Main headline based on game state
            if (gameState.truthLevel > 70) {
                headlines.push({
                    title: "MASSES AWAKENING TO REALITY, GOVERNMENT PANICS",
                    text: "Citizens everywhere are questioning why their tap water tastes like mind control. Local tinfoil sales up 9000%.",
                    breaking: true
                });
            } else if (gameState.truthLevel < 30) {
                headlines.push({
                    title: "EVERYTHING IS FINE, PLEASE CONTINUE CONSUMING",
                    text: "Government assures population that the strange humming sound is just 'freedom resonating'. Nothing to see here.",
                    breaking: true
                });
            } else {
                headlines.push({
                    title: "PUBLIC CONFUSION AT ALL-TIME HIGH",
                    text: "Citizens can't decide if birds are real, water turns frogs gay, or if the moon landing was filmed in Nevada. Experts suggest 'maybe all of the above.'",
                    breaking: true
                });
            }
            
            // Add round events
            gameState.roundEvents.forEach(event => {
                const faction = event.player === 'player' ? gameState.playerFaction : gameState.aiFaction;
                headlines.push({
                    title: generateHeadline(event.cardName, faction),
                    text: event.flavor || event.effect || "Witnesses were too confused to provide details."
                });
            });
            
            // State capture headlines
            const newStates = [...gameState.playerStates, ...gameState.aiStates].slice(-2);
            newStates.forEach(state => {
                const controller = gameState.playerStates.includes(state) ? gameState.playerFaction : gameState.aiFaction;
                const template = NEWS_TEMPLATES.stateCapture[Math.floor(Math.random() * NEWS_TEMPLATES.stateCapture.length)];
                const events = NEWS_TEMPLATES.events[controller];
                
                const headline = template
                    .replace('{state}', state)
                    .replace('{faction}', controller.toUpperCase())
                    .replace('{event}', events.event[Math.floor(Math.random() * events.event.length)])
                    .replace('{object}', events.object[Math.floor(Math.random() * events.object.length)])
                    .replace('{action}', events.action[Math.floor(Math.random() * events.action.length)])
                    .replace('{belief}', events.belief[Math.floor(Math.random() * events.belief.length)]);
                
                headlines.push({
                    title: headline,
                    text: `Local ${state} resident: "I for one welcome our new ${controller === 'government' ? 'reptilian' : 'crystal healing'} overlords."`
                });
            });
            
            // Random filler headlines
            for (let i = 0; i < 2; i++) {
                const template = NEWS_TEMPLATES.random[Math.floor(Math.random() * NEWS_TEMPLATES.random.length)];
                const fillers = NEWS_TEMPLATES.fillers;
                
                const headline = template
                    .replace('{discovery}', fillers.discovery[Math.floor(Math.random() * fillers.discovery.length)])
                    .replace('{phenomenon}', fillers.phenomenon[Math.floor(Math.random() * fillers.phenomenon.length)])
                    .replace('{celebrity}', fillers.celebrity[Math.floor(Math.random() * fillers.celebrity.length)])
                    .replace('{revelation}', fillers.revelation[Math.floor(Math.random() * fillers.revelation.length)])
                    .replace('{food}', fillers.food[Math.floor(Math.random() * fillers.food.length)])
                    .replace('{effect}', fillers.effect[Math.floor(Math.random() * fillers.effect.length)])
                    .replace('{source}', fillers.source[Math.floor(Math.random() * fillers.source.length)]);
                
                headlines.push({
                    title: headline,
                    text: "Experts are looking into it. Results expected never."
                });
            }
            
            return headlines;
        }

        // Generate dynamic headline
        function generateHeadline(cardName, faction) {
            const headlines = {
                "LIZARD PEOPLE SUMMIT": "World Leaders Caught Shedding Skin at UN Meeting",
                "BLACK HELICOPTER PARADE": "Mysterious Aircraft Form Question Mark Over Major Cities",
                "TINFOIL HAT REVOLUTION": "Aluminum Foil Shortage as Citizens 'Protect Their Thoughts'",
                "YOUTUBE UNIVERSITY PHD": "10-Hour Documentary Goes Viral, Changes Everything",
                "Weather Machine": "Tornado Appears in Suspicious Electoral Pattern",
                "Essential Oil Defense": "Lavender Prices Skyrocket as 'Natural Immunity' Trend Grows",
                "Karen Speaks to Manager": "Cosmic Customer Service Complaint Filed with Universe",
                "UFO False Flag": "Definitely Real Aliens Land, Ask About Extended Warranty",
                "MK-ULTRA 2.0": "WiFi Routers Now Include 'Mind Enhancement' Feature",
                "5G Tower Protest": "Protesters Live-Tweet Demonstration via 5G",
                "Facebook Research": "Study Conducted by Sharing Without Reading",
                "Crystal Healing": "Rocks Solve Problems, Scientists Hate This Trick"
            };
            
            return headlines[cardName] || `Strange ${faction} Activity Causes Mass Confusion`;
        }

        // Show newspaper - ENHANCED
        function showNewspaper() {
            const headlines = generateNewspaperContent();
            const newspaperHTML = `
                <div class="newspaper-overlay" id="newspaper-overlay">
                    <div class="newspaper">
                        <button class="newspaper-close" onclick="closeNewspaper()">CONTINUE ‚úï</button>
                        <div class="newspaper-price">$4.20</div>
                        <div class="newspaper-title">THE PARANOID TIMES</div>
                        <div class="newspaper-subtitle">"We're Not Saying It's Aliens, But..."</div>
                        <div class="newspaper-date">Round ${gameState.round} | Truth Level: ${gameState.truthLevel}%</div>
                        
                        <div class="headlines">
                            ${headlines.map(h => `
                                <div class="headline ${h.breaking ? 'breaking' : ''}">
                                    <div class="headline-title">${h.title}</div>
                                    <div class="headline-text">${h.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="newspaper-ad">
                            <div class="newspaper-ad-title">BUY GOLD! THE END IS NIGH!</div>
                            <div>Also available: Survival seeds, gas masks, and artisanal tinfoil hats</div>
                            <div style="font-size: 10px; margin-top: 5px;">*Not responsible for apocalypse not happening</div>
                        </div>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = newspaperHTML;
            document.body.appendChild(div.firstElementChild);
        }

        function closeNewspaper() {
            const overlay = document.getElementById('newspaper-overlay');
            if (overlay) overlay.remove();
            
            // Reset for new round
            gameState.round++;
            gameState.phase = 'player';
            gameState.roundEvents = [];
            gameState.playerActions = [];
            gameState.aiActions = [];
            gameState.combo.chain = 0;
            gameState.combo.lastType = null;
            
            // Check for random events
            triggerRandomEvent();
            
            if (gameState.truthCountdown !== null) {
                gameState.truthCountdown--;
                if (gameState.truthCountdown <= 0) {
                    endGame("TRUTH PREVAILS!", true);
                } else {
                    addLog(`COUNTDOWN: ${gameState.truthCountdown}!`, "warning");
                }
            }
            
            showPhaseIndicator('YOUR TURN');
            renderGame();
        }

        // Check win conditions - ENHANCED
        function checkWinConditions() {
            if (gameState.playerStates.length >= CONFIG.victory.states) {
                endGame("STATE DOMINATION! You control America!", true);
            } else if (gameState.aiStates.length >= CONFIG.victory.states) {
                endGame("DEFEATED! AI controls the nation!", false);
            }
            
            if (gameState.playerIP >= CONFIG.victory.ip) {
                endGame("ECONOMIC VICTORY! Money is power!", true);
            } else if (gameState.aiIP >= CONFIG.victory.ip) {
                endGame("ECONOMIC DEFEAT! AI bought everything!", false);
            }
            
            if (gameState.truthLevel >= CONFIG.victory.truthHigh) {
                if (gameState.playerFaction === 'opposition') {
                    endGame("TRUTH REVEALED! The sheeple are awake!", true);
                } else {
                    endGame("TRUTH EXPOSED! Your lies unravel!", false);
                }
            }
            
            if (gameState.truthLevel <= CONFIG.victory.truthLow) {
                if (gameState.playerFaction === 'government') {
                    endGame("TOTAL CONTROL! Reality is yours!", true);
                } else {
                    endGame("TRUTH SUPPRESSED! Darkness wins!", false);
                }
            }
            
            // Check secret agenda
            if (gameState.secretAgendaProgress >= 100) {
                endGame("SECRET AGENDA COMPLETE!", true);
            }
        }

        // End game
        function endGame(message, playerWon) {
            gameState.isGameOver = true;
            gameState.winner = message;
            
            if (playerWon) {
                gameState.totalWins++;
                gameState.winStreak++;
                createParticles(window.innerWidth / 2, window.innerHeight / 2, 50);
            } else {
                gameState.totalLosses++;
                gameState.winStreak = 0;
            }
            
            try {
                localStorage.setItem('shadowGovStats', JSON.stringify({
                    wins: gameState.totalWins,
                    losses: gameState.totalLosses,
                    winStreak: gameState.winStreak,
                    statistics: gameState.statistics
                }));
            } catch (error) {
            }
            
            renderGame();
        }

        // Toggle options menu
        function toggleOptions() {
            const menu = document.getElementById('optionsMenu');
            menu.classList.toggle('active');
        }

        // Load map data
        async function loadMapData() {
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
                const us = await response.json();
                gameState.mapData = us;
                initMap();
            } catch (error) {
                console.error("Map load failed:", error);
            }
        }

        // Initialize D3 map - ENHANCED
        function initMap() {
            if (!gameState.mapData) return;
            
            const container = document.getElementById('usa-map');
            if (!container) return;
            
            // Remove any existing pressure indicators and tooltips FIRST
            document.querySelectorAll('.state-pressure-indicator').forEach(el => el.remove());
            document.querySelectorAll('.state-tooltip').forEach(el => el.remove());
            document.querySelectorAll('.state-bonus-icon').forEach(el => el.remove());
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            d3.select("#usa-map").selectAll("*").remove();
            
            const svg = d3.select("#usa-map")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            
            const states = topojson.feature(gameState.mapData, gameState.mapData.objects.states);
            
            const projection = d3.geoAlbersUsa()
                .fitSize([width - 10, height - 10], states);
            
            const path = d3.geoPath()
                .projection(projection);
            
            svg.selectAll(".state")
                .data(states.features)
                .enter()
                .append("path")
                .attr("class", d => {
                    const name = d.properties.name;
                    let classes = "state";
                    if (gameState.playerStates.includes(name)) classes += " player-controlled";
                    else if (gameState.aiStates.includes(name)) classes += " ai-controlled";
                    else if (gameState.contestedStates[name]) classes += " contested";
                    if (gameState.selectedState === name) classes += " selected-state";
                    if (CONFIG.specialStates[name]) classes += " special-state";
                    return classes;
                })
                .attr("d", path)
                .attr("transform", "translate(5, 5)")
                .on("click", function(event, d) {
                    event.stopPropagation();
                    selectState(d.properties.name);
                })
                .on("mouseover", function(event, d) {
                    showTooltip(event, d.properties.name);
                })
                .on("mouseout", function() {
                    hideTooltip();
                });
            
            // Add pressure indicators for contested states
            Object.entries(gameState.contestedStates).forEach(([stateName, contest]) => {
                const stateData = states.features.find(f => f.properties.name === stateName);
                if (stateData && projection) {
                    const centroid = path.centroid(stateData);
                    if (!isNaN(centroid[0]) && !isNaN(centroid[1])) {
                        const indicator = document.createElement('div');
                        indicator.className = 'state-pressure-indicator';
                        indicator.style.left = centroid[0] + 'px';
                        indicator.style.top = centroid[1] + 'px';
                        indicator.textContent = `${contest.pressure}/${contest.required}`;
                        container.appendChild(indicator);
                    }
                }
            });
            
            // Add special state icons
            Object.entries(CONFIG.specialStates).forEach(([stateName, special]) => {
                const stateData = states.features.find(f => f.properties.name === stateName);
                if (stateData && projection) {
                    const centroid = path.centroid(stateData);
                    if (!isNaN(centroid[0]) && !isNaN(centroid[1])) {
                        const icon = document.createElement('div');
                        icon.className = 'state-bonus-icon';
                        icon.style.left = (centroid[0] + 20) + 'px';
                        icon.style.top = (centroid[1] - 10) + 'px';
                        icon.textContent = '‚òÖ';
                        container.appendChild(icon);
                    }
                }
            });
        }

        // Show state tooltip - ENHANCED
        function showTooltip(event, stateName) {
            // Clear any existing timer
            if (gameState.currentTooltipTimer) {
                clearTimeout(gameState.currentTooltipTimer);
            }
            
            // Remove any existing tooltips first
            hideTooltip();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'state-tooltip';
            tooltip.id = 'current-tooltip';
            
            let status = 'UNCONTROLLED';
            const defense = CONFIG.stateDefense[stateName];
            const income = CONFIG.stateIncome[defense] || 2;
            
            if (gameState.playerStates.includes(stateName)) {
                status = 'YOURS';
            } else if (gameState.aiStates.includes(stateName)) {
                status = 'AI CONTROLLED';
            } else if (gameState.contestedStates[stateName]) {
                const c = gameState.contestedStates[stateName];
                status = `CONTESTED ${c.pressure}/${c.required}`;
            }
            
            let specialText = '';
            if (CONFIG.specialStates[stateName]) {
                specialText = `<br>‚òÖ ${CONFIG.specialStates[stateName].bonus}`;
            }
            
            tooltip.innerHTML = `
                ${stateName}<br>
                Defense: ${defense} | Income: +${income}<br>
                ${status}
                ${specialText}
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            document.body.appendChild(tooltip);
        }

        // Hide tooltip
        function hideTooltip() {
            const tooltips = document.querySelectorAll('.state-tooltip');
            tooltips.forEach(tooltip => tooltip.remove());
        }

        // Show start screen
        function showStartScreen() {
            let stats = { wins: 0, losses: 0, winStreak: 0 };
            try {
                const saved = localStorage.getItem('shadowGovStats');
                if (saved) stats = JSON.parse(saved);
            } catch (error) {
            }
            
            gameState.totalWins = stats.wins || 0;
            gameState.totalLosses = stats.losses || 0;
            gameState.winStreak = stats.winStreak || 0;
            
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="start-screen">
                    <div class="start-content">
                        <div class="start-title">SHADOW GOVERNMENT</div>
                        <div class="start-subtitle">ULTIMATE HUMOR EDITION</div>
                        <div style="margin: 20px 0;">
                            <em>"Where conspiracy theories go to become policy"</em><br><br>
                            Control the narrative. Manipulate the truth.<br>
                            Convince people birds are real (or aren't).<br><br>
                            <strong style="color: red;">NOW WITH 420% MORE SATIRE!</strong><br><br>
                            <strong>Record:</strong> ${gameState.totalWins}W / ${gameState.totalLosses}L<br>
                            <strong>Win Streak:</strong> ${gameState.winStreak}<br>
                            <br>
                            <strong>HOTKEYS:</strong><br>
                            Space = End Turn | 1-7 = Select Card<br>
                            U = Upgrades | S = Stats | Q/L = Save/Load
                        </div>
                        <button class="start-button" onclick="startNewGame()">NEW GAME</button>
                        <button class="start-button" onclick="checkForExpansions().then(() => showExpansionManager())">
                            MANAGE EXPANSIONS
                        </button>
                        <button class="start-button" onclick="loadExternalNews()">LOAD CUSTOM NEWS</button>
                        <button class="start-button" onclick="quickLoad()">CONTINUE</button>
                        <button class="start-button" onclick="showCredits()">CREDITS</button>
                    </div>
                </div>
            `;
        }
        
        // Show expansion manager (works even without expansions)
        function showExpansionManager() {
            const root = document.getElementById('root');
            
            let expansionHTML = '';
            if (availableExpansions.length > 0) {
                expansionHTML = `
                    <div class="expansion-title">AVAILABLE EXPANSION PACKS</div>
                    <div class="expansion-list">
                        ${availableExpansions.map((exp, i) => `
                            <div class="expansion-item" onclick="toggleExpansion(${i})" id="expansion-${i}">
                                <input type="checkbox" class="expansion-checkbox" id="exp-check-${i}" 
                                       ${settings.expansionsEnabled.includes(exp.name) ? 'checked' : ''}
                                       onclick="event.stopPropagation(); toggleExpansion(${i})">
                                <span class="expansion-name">${exp.name}</span>
                                <div class="expansion-description">${exp.description} (${exp.cardCount} cards)</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                expansionHTML = `
                    <div class="expansion-title">EXPANSION PACK MANAGER</div>
                    <div class="no-expansions">
                        No expansion packs found in ./expansions/ folder<br><br>
                        <strong>To add expansions:</strong><br>
                        1. Create an 'expansions' folder in the game directory<br>
                        2. Add expansion files (tech-uprising.json, alien-agenda.json, etc.)<br>
                        3. Restart the game to detect new expansions<br><br>
                        <em>Expansions add new cards, mechanics, and conspiracy theories!</em>
                    </div>
                `;
            }
            
            root.innerHTML = `
                <div class="expansion-screen">
                    <div class="expansion-container">
                        ${expansionHTML}
                        <div class="expansion-buttons">
                            <button class="expansion-button" onclick="showStartScreen()">BACK TO MENU</button>
                            ${availableExpansions.length > 0 ? 
                                '<button class="expansion-button" onclick="saveExpansionSettings()">SAVE SETTINGS</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Save expansion settings
        function saveExpansionSettings() {
            settings.expansionsEnabled = [];
            for (let i = 0; i < availableExpansions.length; i++) {
                const checkbox = document.getElementById(`exp-check-${i}`);
                if (checkbox && checkbox.checked) {
                    settings.expansionsEnabled.push(availableExpansions[i].name);
                }
            }
            applyExpansionSettings();
        }

// Toggle expansion in options menu
function toggleExpansionInOptions(expName, checked) {
    if (checked && !settings.expansionsEnabled.includes(expName)) {
        settings.expansionsEnabled.push(expName);
    } else if (!checked) {
        settings.expansionsEnabled = settings.expansionsEnabled.filter(e => e !== expName);
    }
}

// Apply expansion settings and restart
function applyExpansionSettings() {
    try {
        localStorage.setItem('shadowGovExpansions', JSON.stringify(settings.expansionsEnabled));
    } catch (error) {
        // ignore persistence errors
    }
    // Load the selected expansions
    if (Array.isArray(settings.expansionsEnabled)) {
        settings.expansionsEnabled.forEach(expName => {
            const exp = (Array.isArray(availableExpansions) ? availableExpansions.find(e => e.name === expName) : null);
            if (exp && exp.data && typeof loadExpansionPack === 'function' && !EXPANSION_PACKS[expName]) {
                loadExpansionPack(expName, exp.data);
            }
        });
    }
    alert('Expansion settings applied! Returning to main menu...');
    if (typeof toggleOptions==='function') toggleOptions();
    if (typeof showStartScreen==='function') showStartScreen();
}

// Return to main menu
function returnToMainMenu() {
    if (window.gameState && gameState.gameStarted && !gameState.isGameOver) {
        if (confirm('Are you sure you want to abandon the current game and return to the main menu?')) {
            gameState.gameStarted = false;
            if (typeof toggleOptions==='function') toggleOptions();
            if (typeof showStartScreen==='function') showStartScreen();
        }
    } else {
        if (typeof toggleOptions==='function') toggleOptions();
        if (typeof showStartScreen==='function') showStartScreen();
    }
}
`);
                if (checkbox && checkbox.checked) {
                    settings.expansionsEnabled.push(availableExpansions[i].name);
                }
            }
            localStorage.setItem('shadowGovExpansions', JSON.stringify(settings.expansionsEnabled));
            showStartScreen();
        }
        
        // Load external news content
        function loadExternalNews() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.js,.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            // Try to parse as JSON first
                            const content = JSON.parse(event.target.result);
                            window.externalNewsContent = content.news || content;
                            alert(`Loaded ${window.externalNewsContent.length} custom news articles!`);
                        } catch (err) {
                            // If not JSON, try to evaluate as JS
                            try {
                                eval(event.target.result);
                                if (window.customNews) {
                                    window.externalNewsContent = window.customNews;
                                    alert(`Loaded ${window.externalNewsContent.length} custom news articles!`);
                                }
                            } catch (err2) {
                                alert('Could not load news file. Please check format.');
                            }
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // Show credits
        function showCredits() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="faction-screen">
                    <div class="draft-container">
                        <div class="draft-title">SHADOW GOVERNMENT CREDITS</div>
                        <div style="text-align: center; padding: 20px;">
                            <h3>Created by The Truth Seekers</h3>
                            <p style="margin: 20px 0;">
                                <strong>Game Design:</strong> Definitely Not The Illuminati<br>
                                <strong>Programming:</strong> A Very Smart AI (Trust Us)<br>
                                <strong>Humor Consultant:</strong> Your Conspiracy Theory Uncle<br>
                                <strong>Quality Assurance:</strong> Actual Lizard People<br>
                                <strong>Fact Checking:</strong> Nobody (Obviously)<br><br>
                                
                                <em>Special Thanks:</em><br>
                                The Birds (Government Drones Division)<br>
                                Big Pharma (For the Snacks)<br>
                                The Real Area 51 Gift Shop<br>
                                Karen from Facebook<br><br>
                                
                                <strong>Disclaimer:</strong><br>
                                This game is satire. Any resemblance to actual shadow governments,<br>
                                living or dead, or actual conspiracies, proven or unproven,<br>
                                is purely coincidental. Probably.<br><br>
                                
                                <em>No reptilians were harmed in the making of this game.</em>
                            </p>
                            <button class="draft-button" onclick="showStartScreen()">BACK</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function startNewGame() {
            checkForExpansions().then(() => {
                if (availableExpansions.length > 0) {
                    showExpansionSelection();
                } else {
                    startGame();
                }
            });
        }

        function startGame() {
            gameState = {
                ...gameState,
                phase: 'player',
                round: 1,
                playerFaction: null,
                aiFaction: null,
                playerIP: CONFIG.startingIP,
                aiIP: CONFIG.startingIP,
                truthLevel: 50,
                playerHand: [],
                aiHand: [],
                playerStates: [],
                aiStates: [],
                contestedStates: {},
                gameLog: [],
                selectedCard: null,
                selectedState: null,
                isGameOver: false,
                winner: null,
                roundEvents: [],
                truthCountdown: null,
                bonuses: {
                    player: { attackBonus: 0, cardDraw: 0, incomeBonus: 0 },
                    ai: { attackBonus: 0, cardDraw: 0, incomeBonus: 0 }
                },
                gameStarted: false,
                isDrafting: false,
                draftChoices: [],
                aiThinking: false,
                persistentEffects: {
                    player: [],
                    ai: []
                },
                combo: {
                    chain: 0,
                    lastType: null,
                    bonus: 0
                },
                deckTracker: {
                    played: [],
                    discarded: []
                },
                secretAgenda: null,
                secretAgendaProgress: 0,
                currentEvent: null,
                replayBuffer: [],
                statistics: {
                    cardsPlayed: 0,
                    ipGained: 0,
                    ipLost: 0,
                    statesCaptured: 0,
                    statesLost: 0,
                    truthChanged: 0,
                    combosAchieved: 0,
                    maxCombo: 0,
                    turnTime: []
                },
                playerActions: [],
                aiActions: []
            };
            
            showFactionSelection();
        }

        // Render game - COMPLETE VERSION WITH HUMOR
        function renderGame() {
            if (!gameState.gameStarted) {
                showStartScreen();
                return;
            }
            
            const root = document.getElementById('root');
            const playerIncome = CONFIG.baseIncome + gameState.bonuses.player.incomeBonus;
            
            root.innerHTML = `
                <div class="game-container">
                    <div class="game-newspaper">
                        <div class="newspaper-header">
                            <div class="newspaper-logo">THE PARANOID TIMES</div>
                            <div class="newspaper-tagline">Round ${gameState.round} | Phase: ${gameState.phase.toUpperCase()} | Combo: ${gameState.combo.chain}x</div>
                            <div class="faction-indicator ${gameState.playerFaction}">
                                ${gameState.playerFaction?.toUpperCase()} OPERATIVE
                            </div>
                        </div>
                        
                        <div class="stats-bar">
                            <div class="stat-item">
                                <div class="stat-label">Your IP</div>
                                <div class="stat-value">${gameState.playerIP}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Truth</div>
                                <div class="stat-value">${gameState.truthLevel}%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">States</div>
                                <div class="stat-value">${gameState.playerStates.length}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">AI IP</div>
                                <div class="stat-value">${gameState.aiIP}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Income</div>
                                <div class="stat-value">+${playerIncome}</div>
                            </div>
                        </div>
                        
                        <div class="game-content">
                            <div class="left-panel">
                                <div class="victory-box">
                                    <div class="victory-title">VICTORY CONDITIONS</div>
                                    <div class="victory-item">
                                        <div class="victory-progress">
                                            <span>States</span>
                                            <span>${gameState.playerStates.length}/${CONFIG.victory.states}</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${(gameState.playerStates.length/CONFIG.victory.states)*100}%"></div>
                                        </div>
                                    </div>
                                    <div class="victory-item">
                                        <div class="victory-progress">
                                            <span>Truth</span>
                                            <span>${gameState.truthLevel}%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${gameState.truthLevel}%"></div>
                                        </div>
                                    </div>
                                    <div class="victory-item">
                                        <div class="victory-progress">
                                            <span>IP</span>
                                            <span>${gameState.playerIP}/${CONFIG.victory.ip}</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${(gameState.playerIP/CONFIG.victory.ip)*100}%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="log-box">
                                    <div class="log-title">CLASSIFIED INTEL</div>
                                    ${gameState.gameLog.slice(0, 20).map(log => `
                                        <div class="log-entry ${log.type}">
                                            ${log.message}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="center-panel">
                                <div class="map-header">
                                    <div class="map-title">USA CONTROL MAP</div>
                                </div>
                                <div id="usa-map"></div>
                            </div>
                            
                            <div class="right-panel">
                                <div class="cards-box">
                                    <div class="cards-title">YOUR CONSPIRACIES (${gameState.playerHand.length}/${CONFIG.maxHandSize})</div>
                                    <div class="cards-grid">
                                        ${gameState.playerHand.map((card, i) => {
                                            const isUpgraded = gameState.upgradedCards.includes(card.id);
                                            const cost = isUpgraded ? Math.floor(card.cost * 0.75) : card.cost;
                                            const canAfford = gameState.playerIP >= cost;
                                            const rarity = getCardRarity(card);
                                            return `
                                                <div class="card-item ${rarity} ${gameState.selectedCard === i ? 'selected' : ''} ${isUpgraded ? 'upgraded' : ''}" 
                                                     onclick="selectCard(${i})"
                                                     style="${!canAfford ? 'opacity: 0.5' : ''}">
                                                    ${isUpgraded ? '<div class="card-upgrade-indicator">+</div>' : ''}
                                                    <div class="card-cost">${cost}</div>
                                                    <div class="card-name">${card.name}</div>
                                                    <div class="card-type">[${card.type.toUpperCase()}]</div>
                                                    <div class="card-effect">${card.effect}</div>
                                                    ${card.humor ? `<div class="card-humor">"${card.humor}"</div>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-bar">
                            <button class="action-btn" onclick="playCard()" 
                                    ${gameState.selectedCard === null || gameState.phase !== 'player' ? 'disabled' : ''}>
                                PLAY CARD
                            </button>
                            <button class="action-btn" onclick="endPlayerTurn()"
                                    ${gameState.phase !== 'player' ? 'disabled' : ''}>
                                END TURN [SPACE]
                            </button>
                            <button class="action-btn" onclick="showUpgradeMenu()">
                                UPGRADE [U]
                            </button>
                            <button class="action-btn" onclick="if(confirm('Abandon conspiracy?')) startGame()">
                                ABANDON
                            </button>
                        </div>
                        
                        <div class="news-ticker">
                            <span class="ticker-content">
                                üî¥ BREAKING: ${gameState.gameLog.slice(0, 3).map(log => log.message).join(' +++ ')} +++ THE TRUTH IS OUT THERE (MAYBE) +++
                            </span>
                        </div>
                    </div>
                </div>
                
                ${gameState.isGameOver ? `
                    <div class="faction-screen">
                        <div class="draft-container">
                            <div class="draft-title">${gameState.winner}</div>
                            <div style="text-align: center; padding: 20px;">
                                <p style="font-size: 24px; margin-bottom: 20px;">
                                    ${gameState.winner.includes('DEFEAT') || gameState.winner.includes('AI') ? 'DEFEAT!' : 'VICTORY!'}
                                </p>
                                <p>Rounds Survived: ${gameState.round}</p>
                                <p>States Controlled: ${gameState.playerStates.length}</p>
                                <p>Final IP: ${gameState.playerIP}</p>
                                <p>Truth Level: ${gameState.truthLevel}%</p>
                                <p>Max Combo: ${gameState.statistics.maxCombo}x</p>
                                <p>Win Streak: ${gameState.winStreak}</p>
                                <button class="draft-button" onclick="showStatistics()">VIEW FULL STATS</button>
                                <button class="draft-button" onclick="startGame()">NEW CONSPIRACY</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            if (document.getElementById('usa-map')) {
                if (gameState.mapData) {
                    initMap();
                }
            }
        }

        // Initialize
        
window.onload = function() {
    // Load saved expansion settings
    try {
        const savedExpansions = localStorage.getItem('shadowGovExpansions');
        if (savedExpansions) {
            settings.expansionsEnabled = JSON.parse(savedExpansions);
        }
    } catch (error) {
    }
    
    checkForExpansions().then(() => {
        // Auto-load previously selected expansions
        if (Array.isArray(settings.expansionsEnabled) && settings.expansionsEnabled.length > 0) {
            settings.expansionsEnabled.forEach(expName => {
                const exp = availableExpansions.find(e => e.name === expName);
                if (exp && exp.data) {
                    loadExpansionPack(expName, exp.data);
                }
            });
        }
        
        showStartScreen();
        loadMapData();
    });
};

    </script>
<script>
(function(){
  try{
    var sub=document.querySelector('.start-subtitle');
    if(sub && !sub.classList.contains('redacted')) sub.classList.add('redacted');
  }catch(e){}
})();
(function(){
  try{ if(location.protocol==='file:'){ window.__SG_FILE_PROTOCOL__=true; } }catch(e){}
})();
</script>
<script>
// === Paranoia Title/Masthead Glitch System (non-destructive add-on) ===
(function(){
  const BASE_NAME = "THE PARANOID TIMES";
  const MASTHEAD_ALT = [
    "THE ABSOLUTE TRUTH",
    "THE REDACTED REPORT",
    "PROBABLY TRUE",
    "OFFICIAL DENIAL",
    "ZERO TRUST HERALD",
    "CONSPIRACY COURIER",
    "UNSEEN OBSERVER",
    "WEEKLY WEIRD",
    "BUNKER BULLETIN",
    "DEEP STATE DAILY",
    "FALSE FLAG TRIBUNE",
    "MIND CONTROL MONTHLY",
    "BLACK HELICOPTER NEWS",
    "LIZARD PEOPLE POST",
    "AREA 51 LEDGER",
    "TINFOIL TIMES",
    "THE MAYBE TIMES",
    "IT'S ALL TRUE (MAYBE)"
  ];
  const SCREEN_ALT = [
    "YOU ARE BEING WATCHED",
    "NOTHING TO SEE HERE",
    "OPERATION: EYES ONLY",
    "TOP SECRET // NOFORN",
    "OBEY // CONSUME",
    "TRUST NO ONE",
    "COVER STORY ONLINE",
    "SUSPECT EVERYTHING"
  ];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function findMastheadNode(){
    let node = document.querySelector('#mastheadTitle, .start-title, .game-title, header h1');
    if (node && /paranoid/i.test(node.textContent)) return node;
    const headers = Array.from(document.querySelectorAll('h1,h2,.start-title,.game-title'));
    for (const el of headers){
      if (/paranoid/i.test(el.textContent)) { return el; }
    }
    const centerTop = document.elementFromPoint(window.innerWidth/2, 30);
    if (centerTop && (centerTop.tagName==='H1' || (centerTop.className||'').toLowerCase().includes('title'))) return centerTop;
    return null;
  }
  function setMasthead(text){
    const el = findMastheadNode();
    if (el) el.textContent = text;
    try { document.title = text; } catch(e){}
  }
  function revertMasthead(){ setMasthead(BASE_NAME); }
  const ParanoiaGlitch = {
    mastheadTimer: null, screenTimer: null, mastheadActive: false, screenActive: false,
    start(){
      if (this.mastheadTimer) return;
      this.mastheadTimer = setInterval(()=>{
        if (this.mastheadActive) return;
        if (Math.random() < 0.30){
          this.mastheadActive = true;
          const name = pick(MASTHEAD_ALT);
          setMasthead(name);
          setTimeout(()=>{ this.mastheadActive = false; revertMasthead(); }, 6000 + Math.random()*4000);
        }
      }, 18000);
      this.screenTimer = setInterval(()=>{
        if (this.screenActive) return;
        if (Math.random() < 0.06){
          this.screenActive = true;
          const name = pick(SCREEN_ALT);
          setMasthead(name);
          setTimeout(()=>{ this.screenActive = false; revertMasthead(); }, 10000 + Math.random()*10000);
        }
      }, 60000);
      revertMasthead();
    }
  };
  window.ParanoiaGlitch = ParanoiaGlitch;
  const _origShowStart = window.showStartScreen;
  window.showStartScreen = function(){
    try { if (typeof _origShowStart === 'function') _origShowStart.apply(this, arguments); } catch(e){}
    try { ParanoiaGlitch.start(); } catch(e){}
  };
  document.addEventListener('DOMContentLoaded', function(){
    try { ParanoiaGlitch.start(); } catch(e){}
  });
})();
</script>
<script>
// === Paranoia Glitch V3: one-shot, gentle, never blocks buttons ===
(function(){
  // Kill-switch
  window.PARANOIA_GLITCH_ENABLED = true;

  const BASE_NEWSPAPER = "THE PARANOID TIMES";
  const NEWSPAPER_ALTS = [
    "THE REDACTED REPORT","THE ABSOLUTE TRUTH","OFFICIAL DENIAL",
    "DEEP STATE DAILY","BUNKER BULLETIN","FALSE FLAG TRIBUNE",
    "TINFOIL TIMES","AREA 51 LEDGER","BLACK HELICOPTER NEWS",
    "UNSEEN OBSERVER","CONSPIRACY COURIER","ZERO TRUST HERALD"
  ];
  const GLOBAL_ALTS = [
    "YOU ARE BEING WATCHED","NOTHING TO SEE HERE","OBEY // CONSUME",
    "TOP SECRET // NOFORN","TRUST NO ONE","OPERATION: EYES ONLY",
    "SUSPECT EVERYTHING"
  ];

  // Style: minimal, doesn't touch pointer-events
  if (!document.getElementById('paranoia-glitch-style-v3')) {
    const s = document.createElement('style');
    s.id = 'paranoia-glitch-style-v3';
    s.textContent = `
      .pg3-flicker { text-shadow: 0 0 1px rgba(0,0,0,.25); }
    `;
    document.head.appendChild(s);
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function q(sel){ return document.querySelector(sel); }

  const state = { newsOpen:false, lock:false };

  function findNewspaperTitle(){ return q('.newspaper-title'); }
  function findStartTitle(){ return q('.start-title'); }

  function glitchNewspaperOnce(){
    if (state.lock || !window.PARANOIA_GLITCH_ENABLED) return;
    const el = findNewspaperTitle();
    if (!el) return;
    state.lock = true; // one-shot per open
    const original = el.textContent || BASE_NEWSPAPER;
    const alt = pick(NEWSPAPER_ALTS);
    el.textContent = alt;
    el.classList.add('pg3-flicker');
    // Revert after short time
    setTimeout(()=>{
      const cur = findNewspaperTitle();
      if (cur){ cur.textContent = original; cur.classList.remove('pg3-flicker'); }
      state.lock = false;
    }, 3000 + Math.random()*2000);
  }

  // Observe when newspaper overlay appears/disappears
  const obs = new MutationObserver(()=>{
    const exists = !!findNewspaperTitle();
    if (exists && !state.newsOpen){
      state.newsOpen = true;
      // 40% chance, one-shot per open
      setTimeout(()=>{ if (Math.random() < 0.4) glitchNewspaperOnce(); }, 300);
    } else if (!exists && state.newsOpen){
      state.newsOpen = false;
      state.lock = false;
    }
  });
  obs.observe(document.body, {childList:true, subtree:true});

  // Global start-screen glitch: very rare, no timers; only on showing start screen
  const _origShowStart = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart && _origShowStart.apply(this, arguments);
    try {
      const el = findStartTitle();
      if (el && window.PARANOIA_GLITCH_ENABLED && Math.random() < 0.12){ // 12% chance on each visit
        const base = el.textContent;
        const alt = pick(GLOBAL_ALTS);
        el.textContent = alt;
        el.classList.add('pg3-flicker');
        setTimeout(()=>{ el.textContent = base; el.classList.remove('pg3-flicker'); }, 2500 + Math.random()*1500);
      }
    } catch(e){}
    return r;
  };

  // Debug helpers
  window.ParanoiaGlitchV3 = {
    disable(){ window.PARANOIA_GLITCH_ENABLED = false; },
    enable(){ window.PARANOIA_GLITCH_ENABLED = true; },
    forceNewspaper(){ glitchNewspaperOnce(); }
  };
})();
</script>
<script>
// --- Start Screen Auto-Fit ---
(function(){
  function fitStartScreen(){
    try{
      const box = document.querySelector('.start-screen .start-content');
      if(!box) return;
      // Reset zoom to 1 then measure
      document.documentElement.style.setProperty('--start-zoom', '1');
      // Force a reflow
      void box.offsetHeight;
      const avail = Math.max(320, window.innerHeight - 20);
      const rect = box.getBoundingClientRect();
      let zoom = Math.min(1, (avail / (rect.height + 10)));
      // Hard floor to avoid too tiny UI
      if (zoom < 0.6) zoom = 0.6;
      document.documentElement.style.setProperty('--start-zoom', String(zoom));
    }catch(e){ console.warn('fitStartScreen error', e); }
  }
  window.addEventListener('resize', fitStartScreen);

  // Hook showStartScreen non-destructively
  const _origShowStart_forFit = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart_forFit && _origShowStart_forFit.apply(this, arguments);
    setTimeout(fitStartScreen, 50);
    return r;
  };
  // If start screen is already present (e.g. from load), attempt fit
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(fitStartScreen, 60));
})();
</script>
<script>
// --- Start Screen Auto-Fit v2 (fits width & height, centered) ---
(function(){
  function fitStartScreenBetter(){
    try{
      const box = document.querySelector('.start-screen .start-content');
      if(!box) return;
      // Reset zoom and measure
      document.documentElement.style.setProperty('--start-zoom', '1');
      void box.offsetHeight; // reflow
      const rect = box.getBoundingClientRect();
      const pad = 24; // matches CSS clamp upper bound
      const availW = Math.max(320, window.innerWidth - pad*2);
      const availH = Math.max(320, window.innerHeight - pad*2);
      const zW = availW / rect.width;
      const zH = availH / rect.height;
      let zoom = Math.min(1, zW, zH);
      if (zoom < 0.6) zoom = 0.6; // floor
      document.documentElement.style.setProperty('--start-zoom', String(zoom));
    }catch(e){ console.warn('fitStartScreenBetter error', e); }
  }
  window.addEventListener('resize', fitStartScreenBetter);
  // Hook showStartScreen non-destructively (keep existing hook if any)
  const _origShowStart_forFit2 = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart_forFit2 && _origShowStart_forFit2.apply(this, arguments);
    setTimeout(fitStartScreenBetter, 50);
    return r;
  };
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(fitStartScreenBetter, 80));
})();
</script>
<!-- How To Play Modal + Hidden Folder Picker -->
<div aria-hidden="true" class="h2p-backdrop" id="h2pBackdrop">
<div aria-labelledby="h2pTitle" aria-modal="true" class="h2p-modal" role="dialog">
<h2 id="h2pTitle">HOW TO PLAY</h2>
<div class="subtitle">A quick primer for new operatives</div>
<div class="h2p-grid">
<div>
<strong>Goal</strong>
<p>Win by controlling <b>10 states</b> <i>or</i> reaching <b>200 IP</b> (Influence Points) <i>or</i> reaching <b>90% Truth</b> <i>or</i> reducing the opponent's Truth to <b>10%</b>.</p>
<div class="h2p-hr"></div>
<strong>Turn Flow</strong>
<ol>
<li>Play 1‚Äì2 cards from your hand to gain IP, flip states, or disrupt the opponent.</li>
<li>Optional: Use <b>Upgrades</b> to improve economy/defense.</li>
<li>Press <span class="h2p-kbd">Space</span> to end turn.</li>
</ol>
</div>
<div>
<strong>Key Systems</strong>
<ul>
<li><b>Truth %</b>: Public belief. H√∏yere = flere kort som treffer hardere.</li>
<li><b>Defense</b>: Stopp effekter &amp; blokker motangrep.</li>
<li><b>Combos</b>: Spill relaterte kort etter hverandre for bonus.</li>
<li><b>Secret Agenda</b>: Skjult seierbetingelse ‚Äì kan vippe spillet.</li>
</ul>
<div class="h2p-hr"></div>
<strong>Hotkeys</strong>
<p>
<span class="h2p-kbd">1‚Äì7</span> = velg kort
          <span class="h2p-kbd">U</span> = Upgrades
          <span class="h2p-kbd">S</span> = Stats
          <span class="h2p-kbd">Q/L</span> = Quick Save/Load
        </p>
</div>
</div>
<div class="h2p-hr"></div>
<p><small>Tips: bruk <b>Media</b> for √• √∏ke <b>Truth</b>, <b>Control</b> for √• stjele stater, og <b>Defensive</b> for √• blokkere AI.</small></p>
<button class="h2p-close" id="h2pCloseBtn">CLOSE</button>
</div>
</div>
<input accept=".json" id="expFolderPicker" multiple="" style="display:none" type="file" webkitdirectory=""/>
<script>
// --- How To Play + Expansion Folder Loader (non-destructive) ---
(function(){
  // Safe helpers
  function $(sel,root){ return (root||document).querySelector(sel); }
  function on(el,ev,fn){ if(el) el.addEventListener(ev,fn); }

  // 3.1 Append HOW TO PLAY button to start screen once rendered
  function ensureHowToPlayButton(){
    try{
      const container = document.querySelector('.start-screen .start-content');
      if(!container) return;
      if(container.querySelector('.h2p-btn')) return; // already added
      // Try to place after MANAGE EXPANSIONS; else append at end
      const expansionsBtn = Array.from(container.querySelectorAll('.start-button'))
        .find(b => /manage expansions/i.test(b.textContent));
      const btn = document.createElement('button');
      btn.className = 'start-button h2p-btn';
      btn.textContent = 'HOW TO PLAY';
      btn.onclick = openHowToPlayModalSG;
      if (expansionsBtn && expansionsBtn.parentNode){
        expansionsBtn.parentNode.insertBefore(btn, expansionsBtn.nextSibling);
      } else {
        container.appendChild(btn);
      }
    }catch(e){ console.warn('ensureHowToPlayButton', e); }
  }

  // 3.2 Modal open/close
  const backdrop = $('#h2pBackdrop');
  const closeBtn = $('#h2pCloseBtn');
  function openHowToPlayModalSG(){ if(backdrop){ backdrop.classList.add('h2p-active'); backdrop.setAttribute('aria-hidden','false'); } } }
  function closeHowToPlayModalSG(){ if(backdrop){ backdrop.classList.remove('h2p-active'); backdrop.setAttribute('aria-hidden','true'); } } }
  on(closeBtn,'click', closeHowToPlayModalSG);
  on(backdrop,'click', (e)=>{ if(e.target===backdrop) closeHowToPlayModalSG(); });
  window.openHowToPlayModalSG = openHowToPlayModalSG;

  // Hook start screen rendering
  const _origShowStart_h2p = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart_h2p && _origShowStart_h2p.apply(this, arguments);
    setTimeout(ensureHowToPlayButton, 30);
    return r;
  };
  // Also try on DOM ready (in case start is already visible)
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(ensureHowToPlayButton, 60));

  // 3.3 Manage Expansions: folder picker loader
  const picker = $('#expFolderPicker');
  window.openExpansionFolderPicker = function(){
    if (picker) picker.click();
  };
  if (picker){
    picker.addEventListener('change', async (evt)=>{
      const files = Array.from(evt.target.files || []);
      if (!files.length) return;
      const jsonFiles = files.filter(f => f.name.toLowerCase().endswith('.json'));
      for (const file of jsonFiles){
        try {
          const txt = await file.text();
          const data = JSON.parse(txt);
          if (!window.availableExpansions) window.availableExpansions = [];
          if (!window.EXPANSION_PACKS) window.EXPANSION_PACKS = {};
          // Use name field if present; otherwise derive from filename
          const expName = (data && (data.name || data.title)) ? (data.name || data.title) : (file.name.replace(/\.json$/i,''));
          // Store
          const exists = availableExpansions.find(e => e.name === expName);
          const entry = { name: expName, data, cardCount: (data.cards && data.cards.length) ? data.cards.length : 0 };
          if (exists){
            Object.assign(exists, entry);
          } else {
            availableExpansions.push(entry);
          }
          // Preload pack in memory (optional)
          if (typeof loadExpansionPack === 'function'){
            try { loadExpansionPack(expName, data); } catch(e){}
          } else {
            EXPANSION_PACKS[expName] = data;
          }
        } catch(err){
          console.warn('Failed to load expansion JSON:', file.name, err);
        }
      }
      // Persist selected expansions list if using the options menu system
      try {
        const names = (availableExpansions||[]).map(e=>e.name);
        localStorage.setItem('shadowGovExpansionsAvailable', JSON.stringify(names));
      } catch(e){}
      // If options menu is open, trigger a refresh so checkboxes list updates
      if (typeof updateOptionsMenu === 'function') { try { updateOptionsMenu(); } catch(e){} }
      alert('Expansions loaded from folder.');
    });
  }

  // 3.4 Add a "Load From Folder" button into the Expansion Manager if it exists
  // We patch on opening the manager by monkey-patching showExpansionManager()
  const _origShowExpMgr = window.showExpansionManager;
  window.showExpansionManager = function(){
    const r = _origShowExpMgr && _origShowExpMgr.apply(this, arguments);
    try {
      const modal = document.querySelector('#expansionManagerModal, .expansion-modal, .modal-content');
      if(modal && !modal.querySelector('.exp-load-folder')){
        const btn = document.createElement('button');
        btn.textContent = 'LOAD FROM FOLDER‚Ä¶';
        btn.className = 'expansion-button exp-load-folder';
        btn.style.marginTop = '10px';
        btn.onclick = ()=> window.openExpansionFolderPicker();
        modal.appendChild(btn);
      }
    } catch(e){}
    return r;
  };
})();
</script>
<script>
// --- Robust expansions scanner: parses directory index at ./expansions/ for any *.json ---
(function(){
  async function fetchDirectoryJSONList(dirUrl){
    try{
      const res = await fetch(dirUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('dir index fetch failed');
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, 'text/html');
      const hrefs = Array.from(doc.querySelectorAll('a'))
        .map(a => a.getAttribute('href')||'')
        .filter(h => /\.json$/i.test(h));
      const files = hrefs.map(h => h.startsWith('http') ? h : (dirUrl.replace(/\/+$/,'') + '/' + h.replace(/^\//,'')));
      return files;
    }catch(e){
      return [];
    }
  }
  function displayNameFromFile(fileUrl, jsonObj){
    const u = fileUrl.split('/').pop();
    if (jsonObj && (jsonObj.name || jsonObj.title)) return (jsonObj.name || jsonObj.title);
    const base = u.replace(/\.json$/i,'');
    const pretty = base.replace(/^expansion-?/i,'').replace(/[-_]+/g,' ').replace(/\s+/g,' ').trim();
    return pretty ? pretty.replace(/\b\w/g, m=>m.toUpperCase()) : base;
  }
  async function addExpansionFromURL(fileUrl){
    try{
      const res = await fetch(fileUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('json fetch failed');
      const data = await res.json();
      if (!window.availableExpansions) window.availableExpansions = [];
      if (!window.EXPANSION_PACKS) window.EXPANSION_PACKS = {};
      const name = displayNameFromFile(fileUrl, data);
      const entry = { name, data, cardCount: (data.cards && data.cards.length) ? data.cards.length : 0, url: fileUrl };
      const ex = availableExpansions.find(e=>e.name===name);
      ex ? Object.assign(ex, entry) : availableExpansions.push(entry);
      window.EXPANSION_PACKS[name] = data;
      return true;
    }catch(err){
      console.warn('Failed to load expansion:', fileUrl, err);
      return false;
    }
  }
  window.checkForExpansions = async function(){
    if (!window.availableExpansions) window.availableExpansions = [];
    let found = await fetchDirectoryJSONList('./expansions/');
    if (!found.length){
      const fallbacks = ['tech-uprising.json','alien-agenda.json','deep-state.json','gov-ops-pack.json','opposition-pack.json']
        .map(n => './expansions/' + n);
      found = fallbacks;
    }
    const seen = new Set();
    for (const url of found){
      const key = url.split('/').pop().toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      await addExpansionFromURL(url);
    }
    try{
      localStorage.setItem('shadowGovExpansionsAvailable', JSON.stringify((availableExpansions||[]).map(e=>e.name)));
    }catch(e){}
    if (typeof updateOptionsMenu==='function'){ try{ updateOptionsMenu(); }catch(e){} }
  };
})();
</script>
<script>
(function(){
  function ensureH2P(){
    try{
      const container = document.querySelector('.start-screen .start-content');
      if(!container) return;
      if(container.querySelector('.h2p-btn')) return;
      const btn = document.createElement('button');
      btn.className = 'start-button h2p-btn';
      btn.textContent = 'HOW TO PLAY';
      btn.onclick = (window.openHowToPlayModalSG || window.openHowToPlay || function(){});
      const match = Array.from(container.querySelectorAll('.start-button')).find(b=>/manage expansions/i.test(b.textContent));
      (match && match.parentNode) ? match.parentNode.insertBefore(btn, match.nextSibling) : container.appendChild(btn);
    }catch(e){ console.warn('ensureH2P error', e); }
  }
  const _origShowStart = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart && _origShowStart.apply(this, arguments);
    setTimeout(ensureH2P, 30);
    return r;
  };
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(ensureH2P, 80));
})();
</script>
<!-- === PATCH: H2P button on start, robust expansion manager with file picker, active-exp display, and working Main Menu === -->
<script>
(function(){
  // --- State shared by patch ---
  window.availableExpansions = window.availableExpansions || [];
  window.EXPANSION_PACKS = window.EXPANSION_PACKS || {};
  const EXP_STORAGE_KEY = 'shadowGovExpansions';
  const EXP_FILES_CACHE = 'shadowGovExpFiles'; // for manual file picker persistence

  function readSavedExpansions(){
    try{ return JSON.parse(localStorage.getItem(EXP_STORAGE_KEY) || '[]'); }
    catch(e){ return []; }
  }
  window.readSavedExpansions = readSavedExpansions;

  // Utility: prettify from filename
  function prettyName(filename){
    const base = filename.replace(/\.json$/i, '');
    const stripped = base.replace(/^expansion-?/i,'').replace(/[-_]+/g,' ').trim();
    return stripped ? stripped.replace(/\b\w/g, m => m.toUpperCase()) : base;
  }

  // ---- HOW TO PLAY button on Start Screen (idempotent) ----
  const _origShowStart = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart ? _origShowStart.apply(this, arguments) : undefined;
    try{
      // Add H2P button if missing
      const container = document.querySelector('.start-screen .start-content');
      if(container && !container.querySelector('.h2p-btn')){
        const btn = document.createElement('button');
        btn.className = 'start-button h2p-btn';
        btn.textContent = 'HOW TO PLAY';
        btn.onclick = window.showHowToPlay || window.openHowToPlay || function(){};
        // Insert after MANAGE EXPANSIONS if present
        const allBtns = Array.from(container.querySelectorAll('.start-button'));
        const after = allBtns.find(b => /manage expansions/i.test(b.textContent));
        (after && after.parentNode) ? after.parentNode.insertBefore(btn, after.nextSibling) : container.appendChild(btn);
      }
      // Show ACTIVE EXPANSIONS under the subtitle
      const subtitle = container && container.querySelector('.start-subtitle');
      if(subtitle){
        let chipRow = container.querySelector('#active-expansions-row');
        const saved = readSavedExpansions();
        if(saved.length){
          if(!chipRow){
            chipRow = document.createElement('div');
            chipRow.id = 'active-expansions-row';
            chipRow.style.margin = '10px 0 0 0';
            chipRow.style.display = 'flex';
            chipRow.style.flexWrap = 'wrap';
            chipRow.style.gap = '6px';
            chipRow.style.justifyContent = 'center';
            subtitle.insertAdjacentElement('afterend', chipRow);
          }
          chipRow.innerHTML = saved.map(n => `<span style="background:#111;color:#fff;border:2px solid #000;padding:3px 8px;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;">${n}</span>`).join('');
        }else if(chipRow){ chipRow.remove(); }
      }
    }catch(e){ console.warn('StartScreen patch error', e); }
    return r;
  };

  // ---- Working Return To Main Menu ----
  window.returnToMainMenu = function(){
    try{
      if (window.gameState && gameState.gameStarted && !gameState.isGameOver){
        if (!confirm('Abandon current game and return to Main Menu?')) return;
      }
    }catch(e){}
    try{ const m = document.getElementById('optionsMenu'); m && m.classList.remove('active'); }catch(e){}
    // Close overlays if any
    ['statsOverlay','newspaper-overlay','randomEventOverlay','upgradeOverlay'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.remove();
    });
    if (typeof window.showStartScreen === 'function') window.showStartScreen();
  };

  // ---- Robust expansion detection: directory scan + manual cache ----
  async function fetchDirIndexJSONs(dir){
    try{
      const res = await fetch(dir, {cache:'no-store'});
      if(!res.ok) throw 0;
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, 'text/html');
      const hrefs = Array.from(doc.querySelectorAll('a')).map(a => a.getAttribute('href')||'').filter(h=>/\.json$/i.test(h));
      return hrefs.map(h => h.startsWith('http') ? h : (dir.replace(/\/+$/,'') + '/' + h.replace(/^\//,'')));
    }catch(e){
      return [];
    }
  }

  async function loadExpansionFromURL(url){
    try{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw 0;
      const data = await res.json();
      const name = data.name || data.title || prettyName(url.split('/').pop());
      const entry = {name, description: data.description || '', cardCount: (data.cards||[]).length, file:url};
      // update/insert
      const i = availableExpansions.findIndex(e=>e.name===name);
      if(i>=0) availableExpansions[i]=entry; else availableExpansions.push(entry);
      window.EXPANSION_PACKS[name] = data;
      return entry;
    }catch(e){ console.warn('loadExpansionFromURL failed', url, e); return null; }
  }

  // PUBLIC: override checkForExpansions()
  window.checkForExpansions = async function(){
    availableExpansions = availableExpansions || [];
    // 1) directory scan
    const urls = await fetchDirIndexJSONs('./expansions/');
    // 2) fallback filenames (compat)
    const fallbacks = ['tech-uprising.json','alien-agenda.json','deep-state.json','gov-ops-pack.json','opposition-pack.json']
      .map(n => './expansions/'+n);
    const candidates = urls.length ? urls : fallbacks;
    const seen = new Set();
    for(const u of candidates){
      const key = u.split('/').pop().toLowerCase();
      if(seen.has(key)) continue; seen.add(key);
      await loadExpansionFromURL(u);
    }
    // 3) include manually loaded cache (file picker)
    try{
      const manual = JSON.parse(localStorage.getItem(EXP_FILES_CACHE) || '[]');
      manual.forEach(m => {
        const name = m.name || prettyName(m.filename||'expansion');
        const entry = {name, description: m.description||'', cardCount:(m.cards||[]).length, file: '(local) '+(m.filename||'')};
        const idx = availableExpansions.findIndex(e=>e.name===name);
        if(idx>=0) availableExpansions[idx]=entry; else availableExpansions.push(entry);
        window.EXPANSION_PACKS[name] = m;
      });
    }catch(e){}
  };

  // ---- Expansion Manager UI with File Picker ----
  window.showExpansionManager = function(){
    const root = document.getElementById('root');
    const list = (availableExpansions||[]).map((exp,i)=>{
      const checked = readSavedExpansions().includes(exp.name);
      return `
        <div class="expansion-item ${checked?'selected':''}" onclick="document.getElementById('exp-check-${i}').click()">
          <input id="exp-check-${i}" type="checkbox" class="expansion-checkbox" ${checked?'checked':''}
                 onchange="(function(cb){ const item=cb.closest('.expansion-item'); cb.checked?item.classList.add('selected'):item.classList.remove('selected'); })(this)">
          <span class="expansion-name">${exp.name}</span>
          <div class="expansion-description">${exp.description || ''} (${exp.cardCount||0} cards)</div>
        </div>`;
    }).join('') || `<div class="no-expansions">No expansion packs found in ./expansions/ folder</div>`;

    root.innerHTML = `
      <div class="expansion-screen">
        <div class="expansion-container">
          <div class="expansion-title">EXPANSION PACK MANAGER</div>
          <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
            <button class="expansion-button" onclick="document.getElementById('expFolder').click()">LOAD FROM FOLDER‚Ä¶</button>
            <button class="expansion-button" onclick="document.getElementById('expFiles').click()">LOAD .JSON FILES‚Ä¶</button>
          </div>
          <input id="expFolder" type="file" webkitdirectory directory multiple style="display:none" accept=".json">
          <input id="expFiles" type="file" multiple style="display:none" accept=".json">
          <div class="expansion-list" id="exp-list">${list}</div>
          <div class="expansion-buttons">
            <button class="expansion-button" onclick="returnToMainMenu()">BACK TO MENU</button>
            <button class="expansion-button" onclick="(window.applyExpansionSettings||function(){})()">APPLY & RESTART</button>
          </div>
        </div>
      </div>`;

    // Hook inputs
    const readFiles = async (files) => {
      const arr = Array.from(files || []);
      const loaded = [];
      for(const f of arr){
        if(!/\.json$/i.test(f.name)) continue;
        try{
          const text = await f.text();
          const data = JSON.parse(text);
          const name = data.name || data.title || prettyName(f.name);
          const entry = {name, description: data.description||'', cardCount:(data.cards||[]).length, file:'(local) '+f.name};
          const i = availableExpansions.findIndex(e=>e.name===name);
          if(i>=0) availableExpansions[i]=entry; else availableExpansions.push(entry);
          window.EXPANSION_PACKS[name] = data;
          loaded.push({filename:f.name, ...data});
        }catch(e){ console.warn('Failed to parse', f.name, e); }
      }
      if(loaded.length){
        try{
          const prev = JSON.parse(localStorage.getItem(EXP_FILES_CACHE) || '[]');
          // merge unique by filename+name
          const merged = [...prev];
          loaded.forEach(n => {
            const key = (n.filename||'') + '|' + (n.name||n.title||'');
            const idx = merged.findIndex(x => ((x.filename||'')+'|'+(x.name||x.title||''))===key);
            if(idx>=0) merged[idx]=n; else merged.push(n);
          });
          localStorage.setItem(EXP_FILES_CACHE, JSON.stringify(merged));
        }catch(e){}
        // refresh list
        showExpansionManager();
      }
    };

    document.getElementById('expFolder').addEventListener('change', e => readFiles(e.target.files));
    document.getElementById('expFiles').addEventListener('change', e => readFiles(e.target.files));
  };

  // ---- Apply & persist selections, show on Start Screen ----
  window.applyExpansionSettings = function(){
    const checks = Array.from(document.querySelectorAll('.expansion-list .expansion-item input[type=checkbox]'));
    const enabled = checks.filter(c => c.checked).map(c => c.parentElement.querySelector('.expansion-name').textContent.trim());
    try{ localStorage.setItem(EXP_STORAGE_KEY, JSON.stringify(enabled)); }catch(e){}
    window.settings = window.settings || {};
    window.settings.expansionsEnabled = enabled;
    alert(`Applied ${enabled.length} expansion(s). Returning to main menu‚Ä¶`);
    returnToMainMenu();
  };

  // ---- Auto-load enabled expansions at boot ----
  const _origOnload = window.onload;
  window.onload = function(){
    const saved = readSavedExpansions();
    window.settings = window.settings || {}; 
    window.settings.expansionsEnabled = saved;
    (async ()=>{
      try{ await (window.checkForExpansions && window.checkForExpansions()); }catch(e){}
      // Already put JSONs into EXPANSION_PACKS via scanner/picker; nothing else to do here.
      if(typeof _origOnload === 'function') _origOnload();
      // Ensure start screen shows chips if we're already there
      setTimeout(()=>{
        if(document.querySelector('.start-screen')) window.showStartScreen();
      }, 60);
    })();
  };
})();
</script>
<script>
(function(){
  function ensureBackdrop(){
    let b = document.getElementById('h2p-backdrop') || document.getElementById('h2pBackdrop');
    if(!b){ b = document.createElement('div'); b.id='h2p-backdrop'; b.className='h2p-backdrop'; document.body.appendChild(b); }
    return b;
  }
  function buildH2P(){
    return `
      <div class="h2p-modal" role="dialog" aria-modal="true" aria-label="How To Play">
        <h2>HOW TO PLAY</h2>
        <div class="subtitle">A quick primer for new operatives</div>
        <div class="h2p-hr"></div>
        <div class="h2p-grid">
          <div>
            <strong>Goal</strong>
            <p>Win by controlling <b>10 states</b> <i>or</i> reaching <b>200 IP</b>, <i>or</i> reaching <b>90% Truth</b>, <i>or</i> reducing the opponent's Truth to <b>10%</b>.</p>
            <div class="h2p-hr"></div>
            <strong>Turn Flow</strong>
            <ol>
              <li>Play 1‚Äì2 cards from your hand to gain IP, flip states, or disrupt the opponent.</li>
              <li>Optional: Use <b>Upgrades</b> to improve economy/defense.</li>
              <li>Press <span class="h2p-kbd">Space</span> to end turn.</li>
            </ol>
          </div>
          <div>
            <strong>Key Systems</strong>
            <ul>
              <li><b>Truth %</b>: Public belief. H√∏yere = flere kort som treffer hardere.</li>
              <li><b>Defense</b>: Stopp effekter & blokker motangrep.</li>
              <li><b>Combos</b>: Spill relaterte kort etter hverandre for bonus.</li>
              <li><b>Secret Agenda</b>: Skjult seierbetingelse ‚Äì kan vippe spillet.</li>
            </ul>
            <div class="h2p-hr"></div>
            <strong>Hotkeys</strong>
            <p>
              <span class="h2p-kbd">1‚Äì7</span> = velg kort
              <span class="h2p-kbd">U</span> = Upgrades
              <span class="h2p-kbd">S</span> = Stats
              <span class="h2p-kbd">Q/L</span> = Quick Save/Load
            </p>
          </div>
        </div>
        <div class="h2p-hr"></div>
        <p><small>Tips: bruk <b>Media</b> for √• √∏ke <b>Truth</b>, <b>Control</b> for √• stjele stater, og <b>Defensive</b> for √• blokkere AI.</small></p>
        <button class="h2p-close" onclick="closeHowToPlayModalSG()">CLOSE</button>
      </div>`;
  }
  window.openHowToPlayModalSG = function(){
    const b = ensureBackdrop();
    b.innerHTML = buildH2P();
    b.onclick = (e)=>{ if(e.target===b) closeHowToPlayModalSG(); };
    b.classList.add('h2p-active'); b.setAttribute('aria-hidden','false');
  };
  window.closeHowToPlayModalSG = function(){
    const b = ensureBackdrop();
    b.classList.remove('h2p-active'); b.setAttribute('aria-hidden','true'); b.innerHTML='';
  };
  window.showHowToPlay = openHowToPlayModalSG;
  window.openHowToPlay = openHowToPlayModalSG;

  const _origShowStart = window.showStartScreen;
  window.showStartScreen = function(){
    const r = _origShowStart ? _origShowStart.apply(this, arguments) : undefined;
    try{
      const container = document.querySelector('.start-screen .start-content');
      if(container){
        Array.from(container.querySelectorAll('.start-button')).forEach(btn=>{ if(/load\s+custom/i.test(btn.textContent)) btn.remove(); });
        if(!container.querySelector('.start-button.h2p-btn')){
          const btn = document.createElement('button');
          btn.className = 'start-button h2p-btn';
          btn.textContent = 'HOW TO PLAY';
          btn.onclick = openHowToPlayModalSG;
          const after = Array.from(container.querySelectorAll('.start-button')).find(b=>/manage expansions/i.test(b.textContent));
          (after && after.parentNode) ? after.parentNode.insertBefore(btn, after.nextSibling) : container.appendChild(btn);
        }
      }
    }catch(e){}
    return r;
  };

  window.returnToMainMenu = function(){
    try{ if(window.gameState && gameState.gameStarted && !gameState.isGameOver){ if(!confirm('Abandon current game and return to Main Menu?')) return; } }catch(e){}
    try{ const m=document.getElementById('optionsMenu'); m && m.classList.remove('active'); }catch(e){}
    ['statsOverlay','newspaper-overlay','randomEventOverlay','upgradeOverlay'].forEach(id=>{ const el=document.getElementById(id); if(el) el.remove(); });
    if(typeof window.showStartScreen==='function') window.showStartScreen();
  };
})();
</script>
<script>
(function(){
  function $(s,r){return (r||document).querySelector(s);}
  if(!document.getElementById('expFolder')){const f1=document.createElement('input');f1.type='file';f1.id='expFolder';f1.multiple=true;f1.webkitdirectory=true;f1.style.display='none';f1.accept='.json';document.body.appendChild(f1);}
  if(!document.getElementById('expFiles')){const f2=document.createElement('input');f2.type='file';f2.id='expFiles';f2.multiple=true;f2.style.display='none';f2.accept='.json';document.body.appendChild(f2);}
  async function handleFiles(list){
    const files=Array.from(list||[]); if(!files.length) return;
    window.availableExpansions=window.availableExpansions||[]; window.EXPANSION_PACKS=window.EXPANSION_PACKS||{};
    for(const file of files){
      if(!/\.json$/i.test(file.name)) continue;
      try{ const txt=await file.text(); const data=JSON.parse(txt);
        const name=(data && (data.name||data.title))?(data.name||data.title):file.name.replace(/\.json$/i,'');
        const entry={name,description:data.description||'',cardCount:(data.cards||[]).length,file:'(local) '+file.name};
        const idx=availableExpansions.findIndex(e=>e.name===name);
        if(idx>=0) availableExpansions[idx]=entry; else availableExpansions.push(entry);
        EXPANSION_PACKS[name]=data;
      }catch(e){ console.warn('Bad expansion', file.name, e); }
    }
    if (typeof showExpansionManager==='function') showExpansionManager();
  }
  window.openExpansionFolderPicker=function(){const el=$('#expFolder'); if(el){ el.onchange=e=>handleFiles(e.target.files); el.click(); }};
  window.openExpansionFilesPicker=function(){const el=$('#expFiles'); if(el){ el.onchange=e=>handleFiles(e.target.files); el.click(); }};

  const EXP_STORAGE_KEY='shadowGovExpansions';
  const _origShowMgr = window.showExpansionManager;
  window.showExpansionManager = function(){
    const root=document.getElementById('root');
    const list=(window.availableExpansions||[]).map((exp,i)=>{
      const enabled = readSavedExpansions().includes(exp.name);
      return `<div class="expansion-item ${enabled?'selected':''}" onclick="document.getElementById('exp-check-${i}').click()">
        <input id="exp-check-${i}" type="checkbox" ${enabled?'checked':''}
               onchange="(function(cb){const it=cb.closest('.expansion-item'); cb.checked?it.classList.add('selected'):it.classList.remove('selected');})(this)">
        <span class="expansion-name">${exp.name}</span>
        <div class="expansion-description">${exp.description||''} (${exp.cardCount||0} cards)</div>
      </div>`;
    }).join('') || `<div class="no-expansions">No expansion packs found in ./expansions/ folder</div>`;

    root.innerHTML = `<div class="expansion-screen"><div class="expansion-container">
      <div class="expansion-title">EXPANSION PACK MANAGER</div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
        <button class="expansion-button" onclick="openExpansionFolderPicker()">LOAD FROM FOLDER‚Ä¶</button>
        <button class="expansion-button" onclick="openExpansionFilesPicker()">LOAD .JSON FILES‚Ä¶</button>
      </div>
      <div class="expansion-list">${list}</div>
      <div class="expansion-buttons">
        <button class="expansion-button" onclick="returnToMainMenu()">BACK TO MENU</button>
        <button class="expansion-button" onclick="(window.applyExpansionSettings?applyExpansionSettings:(function(){const c=[...document.querySelectorAll('.expansion-list input[type=checkbox]')];const en=c.filter(x=>x.checked).map(x=>x.parentElement.querySelector('.expansion-name').textContent.trim());try{localStorage.setItem('shadowGovExpansions',JSON.stringify(en));}catch(e){};window.settings=window.settings||{};window.settings.expansionsEnabled=en;alert('Applied '+en.length+' expansion(s). Returning to main menu‚Ä¶');returnToMainMenu();}))()">APPLY & RESTART</button>
      </div>
    </div></div>`;
  };
})();
</script>
<!-- Embedded base expansion JSON (fallback so manager is never empty) -->
<script id="govOpsJson" type="application/json">{"name": "GOVERNMENT OPS PACK", "description": "Faction-specific cards for Government Operatives.", "cards": []}</script>
<script id="oppJson" type="application/json">{"name": "OPPOSITION PACK", "description": "Faction-specific cards for the Opposition.", "cards": []}</script>
<!-- EXPANSION MANAGER + ACTIVE BADGES FIX (non-destructive) -->
<script>
(function(){
  const EXP_KEY='sg.activeExpansions.v1';
  const REG={list:[],byId:Object.create(null)};

  // Expose register hook if not present
  window.registerExpansionPack = window.registerExpansionPack || function(id, pack){
    if(!id||!pack||REG.byId[id]) return;
    REG.byId[id]=pack; REG.list.push({id, ...pack});
    if (document.querySelector('#expList')) renderExpansionList();
  };

  function getActive(){ try{return JSON.parse(localStorage.getItem(EXP_KEY))||[];}catch{return [];} }
  function setActive(ids){ localStorage.setItem(EXP_KEY, JSON.stringify(ids||[])); drawActiveBadges(); }

  // Draw "ACTIVE EXPANSIONS" badges (fixed + optional inline)
  function drawActiveBadges(){
    const ids = getActive().filter(id=>REG.byId[id]);
    // fixed
    let fixed=document.getElementById('activeExpBadges');
    if(!fixed){
      fixed=document.createElement('div'); fixed.id='activeExpBadges';
      fixed.style.cssText='position:fixed;top:10px;left:10px;z-index:99999;font-family:Bebas Neue,system-ui,sans-serif';
      document.body.appendChild(fixed);
    }
    fixed.innerHTML='';
    if(ids.length){
      const t=document.createElement('div');
      t.textContent='ACTIVE EXPANSIONS';
      t.style.cssText='display:inline-block;background:#ff0;border:2px solid #000;padding:2px 6px;font-weight:700;transform:rotate(-2deg);margin-bottom:6px';
      fixed.appendChild(t);
      const row=document.createElement('div');
      ids.forEach(id=>{
        const s=document.createElement('span');
        s.textContent=(REG.byId[id].displayName||REG.byId[id].name||id);
        s.style.cssText='margin:4px 6px 0 0;padding:4px 8px;background:#000;color:#fff;border:2px solid #fff;display:inline-block;transform:rotate(-2deg)';
        row.appendChild(s);
      });
      fixed.appendChild(row);
    }
    // inline (if start screen uses inline container)
    const inline = document.getElementById('inlineBadges');
    if(inline){
      inline.innerHTML='';
      ids.forEach(id=>{
        const s=document.createElement('span');
        s.textContent=(REG.byId[id].displayName||REG.byId[id].name||id);
        s.style.cssText='margin:4px 6px 0 0;padding:4px 8px;background:#000;color:#fff;border:2px solid #fff;display:inline-block;transform:rotate(-2deg)';
        inline.appendChild(s);
      });
    }
  }

  // Build/refresh list inside manager
  function renderExpansionList(){
    const host = document.querySelector('#expList');
    if(!host) return;
    const active = new Set(getActive());
    host.innerHTML='';
    if(!REG.list.length){
      // use embedded JSON as fallback
      try{
        const g=JSON.parse(document.getElementById('govOpsJson').textContent);
        const o=JSON.parse(document.getElementById('oppJson').textContent);
        window.registerExpansionPack('GovOpsPack', {displayName:g.name||'GOV OPS', description:`${g.description||''} (${(g.cards||[]).length} cards)`, cards:g.cards||[]});
        window.registerExpansionPack('OppositionPack', {displayName:o.name||'OPPOSITION', description:`${o.description||''} (${(o.cards||[]).length} cards)`, cards:o.cards||[]});
      }catch(e){}
    }
    REG.list.forEach(p=>{
      const card=document.createElement('div');
      card.className='expansion-item';
      card.style.cssText='background:#fff;border:2px solid #000;padding:12px;margin:10px 0';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.className='expansion-checkbox'; cb.checked=active.has(p.id); cb.style.transform='scale(1.4)';
      cb.addEventListener('change',()=>{ if(cb.checked) active.add(p.id); else active.delete(p.id); setActive([...active]); });
      const name=document.createElement('span'); name.className='expansion-name'; name.textContent=p.displayName||p.name||p.id; name.style.cssText='font-family:Bebas Neue,system-ui,sans-serif;font-size:22px;margin-left:6px';
      const desc=document.createElement('div'); desc.className='expansion-description'; desc.textContent=p.description||''; desc.style.cssText='font-size:12px;color:#555;margin-left:32px;margin-top:4px';
      card.appendChild(cb); card.appendChild(name); card.appendChild(desc);
      host.appendChild(card);
    });
  }

  // File helpers
  async function loadJsonText(file){ try{ const txt=await file.text(); return JSON.parse(txt);}catch(e){ return null;} }
  async function onPickJsonFiles(){
    const input=document.createElement('input'); input.type='file'; input.accept='.json'; input.multiple=true;
    input.onchange=async ()=>{
      for(const f of input.files){
        const data=await loadJsonText(f); if(!data) continue;
        const id=(data.id||data.name||f.name).replace(/\W+/g,'_');
        window.registerExpansionPack(id, {displayName:data.displayName||data.name||id, description:data.description||'', cards:data.cards||[]});
      }
      renderExpansionList();
    };
    input.click();
  }
  async function onPickFolder(){
    if(!window.showDirectoryPicker){ alert('Folder picker not supported. Use "Load .JSON files‚Ä¶" instead.'); return; }
    try{
      const dir=await window.showDirectoryPicker({mode:'read'});
      for await (const entry of dir.values()){
        if(entry.kind==='file' && /\.json$/i.test(entry.name)){
          const file=await entry.getFile();
          const data=await loadJsonText(file); if(!data) continue;
          const id=(data.id||data.name||entry.name).replace(/\W+/g,'_');
          window.registerExpansionPack(id, {displayName:data.displayName||data.name||id, description:data.description||'', cards:data.cards||[]});
        }
      }
      renderExpansionList();
    }catch(e){ console.warn('folder pick failed', e); }
  }

  // Wire manager (works with existing DOM; creates anchors if missing)
  function wireManager(){
    const modal = document.querySelector('.expansion-screen') || document.getElementById('expModal');
    if(!modal) return;
    // ensure toolbar buttons and list exist
    let list = modal.querySelector('#expList');
    if(!list){
      list = document.createElement('div'); list.id='expList'; list.className='expansion-list';
      const container = modal.querySelector('.expansion-container') || modal;
      container.appendChild(list);
    }
    // buttons
    let btnFolder = modal.querySelector('#btnLoadFolder') || modal.querySelector('#pickFolder');
    if(!btnFolder){
      btnFolder=document.createElement('button'); btnFolder.id='btnLoadFolder'; btnFolder.className='expansion-button'; btnFolder.textContent='LOAD FROM FOLDER...';
      const cont = modal.querySelector('.expansion-container') || modal;
      cont.insertBefore(Object.assign(document.createElement('div'),{className:'expansion-buttons'}), cont.firstChild)
      cont.querySelector('.expansion-buttons').appendChild(btnFolder);
    }
    let btnJson = modal.querySelector('#btnLoadJson') || modal.querySelector('#pickJson');
    if(!btnJson){
      btnJson=document.createElement('button'); btnJson.id='btnLoadJson'; btnJson.className='expansion-button'; btnJson.textContent='LOAD .JSON FILES...';
      modal.querySelector('.expansion-buttons').appendChild(btnJson);
    }
    let btnApply = modal.querySelector('#btnApplyExp') || modal.querySelector('#expApply');
    if(!btnApply){
      btnApply=document.createElement('button'); btnApply.id='btnApplyExp'; btnApply.className='expansion-button'; btnApply.textContent='APPLY & RESTART';
      const bottom = modal.querySelector('.expansion-buttons:last-of-type') || modal.querySelector('.expansion-buttons');
      if(bottom) bottom.appendChild(btnApply);
    }

    // wire once
    if(!btnJson._wired){ btnJson._wired=true; btnJson.addEventListener('click', onPickJsonFiles); }
    if(!btnFolder._wired){ btnFolder._wired=true; btnFolder.addEventListener('click', onPickFolder); }
    if(!btnApply._wired){ btnApply._wired=true; btnApply.addEventListener('click',()=>{
      drawActiveBadges();
      if(typeof window.restartGame==='function') window.restartGame();
      // close modal
      modal.style.display='none';
    }); }
    renderExpansionList();
  }

  // Bootstrap
  document.addEventListener('DOMContentLoaded', () => {
    try{
      // Register embedded packs immediately (fallback)
      const g=JSON.parse(document.getElementById('govOpsJson').textContent);
      const o=JSON.parse(document.getElementById('oppJson').textContent);
      window.registerExpansionPack('GovOpsPack', {displayName:g.name||'GOV OPS', description:`${g.description||''} (${(g.cards||[]).length} cards)`, cards:g.cards||[]});
      window.registerExpansionPack('OppositionPack', {displayName:o.name||'OPPOSITION', description:`${o.description||''} (${(o.cards||[]).length} cards)`, cards:o.cards||[]});
    }catch(e){}
    // Wire manager when opened (and also now, if it's visible)
    wireManager();
    drawActiveBadges();
  });

  // Optional: expose a helper to force-refresh from other parts of the game
  window.refreshExpansionBadges = drawActiveBadges;
  window.refreshExpansionList = renderExpansionList;
})();
</script>
<script>
// H2P safety alias so the start-screen button always opens the rules popup:
(function(){
  if (typeof window.openHowToPlay === 'undefined') {
    if (typeof window.showHowToPlay === 'function') window.openHowToPlay = window.showHowToPlay;
    else if (typeof window.showH2P === 'function') window.openHowToPlay = window.showH2P;
  }
  // Bind any button with id="btnH2P" if it's not wired by the main code
  document.addEventListener('DOMContentLoaded', function(){
    var b = document.getElementById('btnH2P');
    if (b && !b._wired) {
      b._wired = true;
      b.addEventListener('click', function(e){
        e.preventDefault();
        if (typeof window.openHowToPlay === 'function') window.openHowToPlay();
        else alert('How To Play is not available on this screen.');
      });
    }
  });
})();
</script>
<!-- ===== Shadow Gov: Unified Patch ‚Äî Options + Agenda/Tracker + Extra Events + Rule Engine ===== -->
<style>
  .opt-row{margin:8px 0; font-size:14px}
  .opt-row label{display:flex; align-items:center; gap:8px}
  .opt-section{border-top:2px solid #000; margin-top:10px; padding-top:10px}
  .newspaper-ad{border:2px solid #000;background:#fff;padding:8px;margin-top:8px}
  .newspaper-ad-title{font-weight:700;margin-bottom:4px}
</style>
<script>
(function(){
  if (window.__SG_UNIFIED_PATCH__) return; window.__SG_UNIFIED_PATCH__ = true;

  // window.toggleOptions defined earlier
  function buildOptionsMenu(){
    var m = document.getElementById('optionsMenu'); if(!m) return;
    m.innerHTML = "";
    var sec1 = document.createElement('div'); sec1.className='opt-section';
    sec1.innerHTML = "<div class='option-label'>UI</div>";
    sec1.appendChild(makeToggle('Show Deck Tracker', 'sg.showDeckTracker', true, function(v){
      var el = document.getElementById('deckTracker'); if (el) el.style.display = v? 'block':'none';
    }));
    sec1.appendChild(makeToggle('Show Secret Agenda', 'sg.showSecretAgenda', true, function(v){
      var el = document.getElementById('secretAgenda'); if (el) el.style.display = v? 'block':'none';
    }));
    sec1.appendChild(makeToggle('FX Overlays', 'sg.fxOverlays', true));
    sec1.appendChild(makeToggle('News Popups', 'sg.newsPopups', true));
    m.appendChild(sec1);

    var sec2 = document.createElement('div'); sec2.className='opt-section';
    sec2.innerHTML = "<div class='option-label'>Gameplay</div>";
    sec2.appendChild(makeToggle('Random Non-Aggression Pacts', 'sg.randomPacts', true, function(v){
      window.SG_RANDOM_PACT = !!v;
    }));
    sec2.appendChild(makeToggle('Hard Rules (enforce card effects)', 'sg.hardRules', true, function(v){
      window.SG_HARD_RULES = !!v;
    }));
    m.appendChild(sec2);

    var sec3 = document.createElement('div'); sec3.className='opt-section';
    sec3.innerHTML = "<div class='option-label'>Events Enabled</div>";
    ['meteor','blackout','court_order'].forEach(function(k){
      sec3.appendChild(makeToggle(' '+k.replace('_',' ').toUpperCase(), 'sg.event.'+k, true));
    });
    m.appendChild(sec3);
  }
  function makeToggle(label, key, def, onchange){
    var row = document.createElement('div'); row.className='opt-row';
    var id = 'opt-'+key.replace(/\W/g,'_');
    var v = loadOpt(key, def);
    row.innerHTML = "<label><input type='checkbox' id='"+id+"' "+(v?'checked':'')+">"+label+"</label>";
    setTimeout(function(){
      var cb = document.getElementById(id);
      if (!cb) return;
      cb.addEventListener('change', function(){
        saveOpt(key, cb.checked);
        try{ onchange && onchange(cb.checked); }catch(e){}
      });
    });
    return row;
  }
  function saveOpt(k,v){ try{ localStorage.setItem(k, JSON.stringify(!!v)); }catch(e){} }
  function loadOpt(k, def){ try{ var v = localStorage.getItem(k); return v===null? def : JSON.parse(v); }catch(e){ return def; } }
  document.addEventListener('DOMContentLoaded', function(){
    var deck = document.getElementById('deckTracker'); if (deck) deck.style.display = loadOpt('sg.showDeckTracker', true)? 'block':'none';
    var ag = document.getElementById('secretAgenda'); if (ag) ag.style.display = loadOpt('sg.showSecretAgenda', true)? 'block':'none';
    window.SG_RANDOM_PACT = loadOpt('sg.randomPacts', true);
    window.SG_HARD_RULES = loadOpt('sg.hardRules', true);
  });

  window.SG_EX_EVENTS = window.SG_EX_EVENTS || [
    { key:'meteor',   title:'METEOR SHOWER', text:'Random states take damage. Defense -1 this round.', apply: function(G){
        var victims = pickRandomStates(3);
        victims.forEach(function(s){ modStateDefense(s, -1, 1); });
        overlay('meteor');
      }},
    { key:'blackout', title:'NATIONWIDE BLACKOUT', text:'Truth cannot change this round. Media effects 0.', apply: function(G){
        window.SG_MEDIA_MOD = {mult:0, rounds:1};
        G._truthLocked = 1;
        overlay('blackout');
      }},
    { key:'court_order', title:'COURT ORDER', text:'Next Control card is cancelled for both players.', apply: function(G){
        G._banControl = 1; setTimeout(function(){ G._banControl = 0; }, 0);
        overlay('court order');
      }}
  ];
  function pickRandomStates(n){
    var list = (window.getAllStates && getAllStates()) || Object.keys((window.CONFIG && CONFIG.stateDefense)||{});
    list = list.slice();
    var out=[]; while(out.length<n && list.length){ out.push(list.splice((Math.random()*list.length)|0,1)[0]); }
    return out;
  }
  function modStateDefense(state, delta, rounds){
    window.__defMods = window.__defMods||{};
    window.__defMods[state] = (window.__defMods[state]||0) + delta;
    if (!rounds) return;
    window.__defExp = window.__defExp||[];
    window.__defExp.push({state:state, delta:-delta, rounds:rounds});
  }
  function overlay(label){
    if (!loadOpt('sg.fxOverlays', true)) return;
    if (window.SGFX) SGFX.overlay(label, 1400);
  }
  if (typeof window.maybeRandomEvent === 'function' && !window.maybeRandomEvent.__sg_extra_wrapped__){
    const _oldRE = window.maybeRandomEvent;
    window.maybeRandomEvent = function(){
      _oldRE();
      try{
        var G = window.gameState || {};
        if (!G.round) return;
        if (G.round % 4 === 0){
          var pool = window.SG_EX_EVENTS.filter(e=>loadOpt('sg.event.'+e.key, true));
          if (pool.length && Math.random()<0.6){
            var ev = pool[(Math.random()*pool.length)|0];
            if (window.Log && Log.news) Log.news(ev.title+" ‚Äî "+ev.text);
            ev.apply(G);
          }
        }
      }catch(e){}
    };
    window.maybeRandomEvent.__sg_extra_wrapped__ = true;
  }

  window.__sg_updateDeckTracker = window.__sg_updateDeckTracker || function(action, card){
    try{
      var el = document.getElementById('deckTrackerContent'); if(!el) return;
      var line = (action==='play'?'‚ñ∂':'‚úñ')+" "+(card?.name||card?.id||'Card');
      el.innerHTML = (el.innerHTML || "") + "<div class='deck-tracker-item'>" + line + "</div>";
    }catch(e){}
  };
  window.__sg_setSecretAgenda = window.__sg_setSecretAgenda || function(name, progressPct, subtitle){
    try{
      var box = document.getElementById('secretAgenda'); if(!box) return;
      var t = document.getElementById('secretAgendaText'); if (t) t.textContent = (subtitle||name||"");
      var f = document.getElementById('secretAgendaFill'); if (f) f.style.width = (progressPct||0)+"%";
      box.style.display = loadOpt('sg.showSecretAgenda', true)? 'block':'none';
    }catch(e){}
  };
  ['playCard','applyCardEffect'].forEach(function(fn){
    if (typeof window[fn] === 'function' && !window[fn].__sg_track_wrapped__){
      var _orig = window[fn];
      window[fn] = function(card){
        try{ window.__sg_updateDeckTracker('play', card); }catch(e){}
        return _orig.apply(this, arguments);
      };
      window[fn].__sg_track_wrapped__ = true;
    }
  });

  window.CardRules = window.CardRules || { handlers:{}, keywords:{}, register:function(id,fn){this.handlers[id]=fn;}, registerKeyword:function(kw,fn){this.keywords[kw]=fn;} };
  function grantStateToPlayer(state, who){
    var G = window.gameState||{};
    if (!G.playerStates || !G.aiStates) return;
    G.playerStates = (G.playerStates||[]).filter(s=>s!==state);
    G.aiStates = (G.aiStates||[]).filter(s=>s!==state);
    if (who==='player') G.playerStates.push(state); else G.aiStates.push(state);
    if (window.Log && Log.special) Log.special((who==='player'?'You':'AI')+" captured "+state);
    if (window.renderGame) window.renderGame();
  }
  function adjacentStatesOf(state){
    const adj={'Florida':['Georgia','Alabama'],'Georgia':['Florida','Alabama','South Carolina','Tennessee'],'Alabama':['Florida','Georgia','Mississippi','Tennessee'],'Nevada':['California','Arizona','Utah','Oregon','Idaho']};
    return adj[state]||[];
  }
  function enforceTruthLock(delta){ var G=window.gameState||{}; if (G && G._truthLocked) return 0; return delta; }
  CardRules.register('L003', function(card, ctx){ grantStateToPlayer('Florida', ctx.who||'player'); adjacentStatesOf('Florida').forEach(s=>grantStateToPlayer(s, ctx.who||'player')); return true; });
  CardRules.register('L002', function(card, ctx){ var G=window.gameState||{}; G._controlOpponentTurns = 2; if (window.Log&&Log.warning) Log.warning('Opponent will be controlled for 2 turns.'); return true; });
  CardRules.register('C005', function(card, ctx){ try{ var G=window.gameState||{}; var st = ctx.state || G.selectedState || null; if (st && typeof window.addPressure==='function'){ window.addPressure(st, 1, ctx.who||'player'); return true; } }catch(e){} return false; });
  CardRules.registerKeyword('mediaTruth', function(delta){
    var G = window.gameState||{}; var d = enforceTruthLock(delta);
    if (d===0){ if (window.Log && Log.warning) Log.warning('Truth is locked by BLACKOUT!'); }
    else { G.truthLevel = Math.max(0, Math.min(100, (G.truthLevel||50)+d)); }
    if (window.renderGame) window.renderGame(); return true;
  });
  window.registerExpansionRules = window.registerExpansionRules || function(ruleMap){
    try{ Object.keys(ruleMap||{}).forEach(function(id){ var fnBody=ruleMap[id], fn=null; try{ fn=new Function('card','ctx',fnBody);}catch(e){console.warn('Invalid rule for',id,e);} if(typeof fn==='function') CardRules.register(id, fn); }); }catch(e){}
  };
  if (typeof window.applyCardEffect === 'function' && !window.applyCardEffect.__sg_rules_wrapped__){
    const _apply = window.applyCardEffect;
    window.applyCardEffect = function(card, context){
      context = context || {}; context.who = context.who || (window.gameState?.phase==='player'?'player':'ai');
      if ((card?.type||'').toLowerCase()==='control' && (window.gameState?._banControl)){
        if (window.Log && Log.warning) Log.warning('Court Order cancels CONTROL card.'); return false;
      }
      if (window.SG_HARD_RULES !== false){
        if (card && CardRules.handlers[card.id]){
          var handled=false; try{ handled = CardRules.handlers[card.id](card, context);}catch(e){console.warn(e);} if (handled) return true;
        }
        if (card && /facebook research/i.test(card.name)) return CardRules.keywords.mediaTruth(+8);
        if (card && /disinformation/i.test(card.name)) return CardRules.keywords.mediaTruth(-10);
        if (card && /moon landing/i.test(card.name)) return CardRules.keywords.mediaTruth(+15);
      }
      return _apply.apply(this, arguments);
    };
    window.applyCardEffect.__sg_rules_wrapped__ = true;
  }
  if (typeof window.aiTakeTurn === 'function' && !window.aiTakeTurn.__sg_control_wrapped__){
    const _ai = window.aiTakeTurn;
    window.aiTakeTurn = function(){
      var G = window.gameState||{};
      if (G._controlOpponentTurns>0){
        G._controlOpponentTurns--;
        if (window.Log && Log.warning) Log.warning('AI turn skipped (mind control). '+G._controlOpponentTurns+' left.');
        if (typeof window.endRound==='function') return endRound();
        return;
      }
      return _ai.apply(this, arguments);
    };
    window.aiTakeTurn.__sg_control_wrapped__ = true;
  }
  if (typeof window.endRound === 'function' && !window.endRound.__sg_defmod_wrapped__){
    const _end = window.endRound;
    window.endRound = function(){
      var r = _end.apply(this, arguments);
      try{
        if (Array.isArray(window.__defExp)){
          window.__defExp.forEach(function(e){ e.rounds--; if (e.rounds<=0) modStateDefense(e.state, e.delta, 0); });
          window.__defExp = window.__defExp.filter(e=>e.rounds>0);
        }
      }catch(e){}
      return r;
    };
    window.endRound.__sg_defmod_wrapped__ = true;
  }
  window.claimState = window.claimState || grantStateToPlayer;
  window.adjacentStatesOf = window.adjacentStatesOf || adjacentStatesOf;
})(); 
</script>
<script>
        (function(){
          if(window.ShadowAudio){ return; }
          const state = {
            enabled: true,
            category: 'Theme',
            idx: 1,
            audio: new Audio(),
          };
          const menuEl = document.getElementById('optionsMenu');
          function log(...a){ }
          function srcFor(cat, idx){ return `muzak/${cat}-${idx}.mp3`; }
          function play(category){
            state.category = category || state.category || 'Theme';
            state.idx = 1;
            try{ state.audio.pause(); state.audio.currentTime = 0; }catch(e){}
            state.audio.src = srcFor(state.category, state.idx);
            if(!state.enabled){ return; }
            const p = state.audio.play();
            if(p && p.catch){ p.catch(err=>log('autoplay blocked', err)); }
          }
          function next(){
            state.idx++;
            state.audio.src = srcFor(state.category, state.idx);
            const p = state.audio.play();
            if(p && p.catch){
              // reset to 1 if next file missing or blocked
              state.idx = 1;
              state.audio.src = srcFor(state.category, state.idx);
              state.audio.play().catch(err=>log('loop fallback', err));
            }
          }
          state.audio.addEventListener('ended', next);
          state.audio.addEventListener('error', function(){
            if(state.idx !== 1){
              state.idx = 1;
              state.audio.src = srcFor(state.category, state.idx);
              state.audio.play().catch(()=>{});
            } else {
              log('missing file', state.audio.src);
            }
          });
          function ensureOptionsUI(){
            const m = document.getElementById('optionsMenu');
            if(!m) return;
            if(m.dataset.audioWired) return;
            m.dataset.audioWired = '1';
            const wrap = document.createElement('div');
            wrap.className = 'option-item';
            wrap.innerHTML = `
              <label class="option-label" style="display:block;font-weight:700;margin-bottom:6px">Audio</label>
              <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
                <input type="checkbox" id="opt-audio-enabled" ${state.enabled ? 'checked':''}>
                <span>Enable Music & SFX</span>
              </label>
              <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
                <span style="font-weight:700">Music Set:</span>
                <select id="opt-audio-category">
                  <option value="Theme">Theme (Menu/General)</option>
                  <option value="Government">Government</option>
                  <option value="Truth">Truth Seekers</option>
                </select>
                <button id="opt-audio-restart">‚ñ∂ Play</button>
              </div>
            `;
            m.appendChild(wrap);
            const chk = wrap.querySelector('#opt-audio-enabled');
            const sel = wrap.querySelector('#opt-audio-category');
            const btn = wrap.querySelector('#opt-audio-restart');
            sel.value = state.category;
            chk.addEventListener('change', e=>{
              state.enabled = !!e.target.checked;
              if(!state.enabled){ try{ state.audio.pause(); }catch(e){} }
              else { play(state.category); }
            });
            sel.addEventListener('change', e=>{
              state.category = e.target.value;
              play(state.category);
            });
            btn.addEventListener('click', ()=>play(state.category));
          }
          function toggleOptions(){
            const el = document.getElementById('optionsMenu');
            if(!el) return;
            el.classList.toggle('active');
            if(el.classList.contains('active')) ensureOptionsUI();
          }
          function detectStartScreenAndAddButton(){
            const start = document.querySelector('.start-screen .start-content');
            if(!start || start.dataset.audioPatched){ return; }
            start.dataset.audioPatched = '1';
            // add Options button if not already present
            const hasBtn = Array.from(start.querySelectorAll('button')).some(b=>/options/i.test(b.textContent));
            if(!hasBtn){
              const btn = document.createElement('button');
              btn.className = 'start-button';
              btn.textContent = 'OPTIONS';
              btn.addEventListener('click', toggleOptions);
              start.appendChild(btn);
            }
            // Start menu music
            play('Theme');
          }
          // Public SFX API
          function playSFX(name){
            if(!state.enabled) return;
            if(!name) return;
            try{
              const a = new Audio(`sfx/${name}`);
              a.play().catch(()=>{});
            }catch(e){}
          }
          // Expose a few helpers
          window.ShadowAudio = {
            playCategory: play,
            setCategory: c=>{ state.category=c; },
            currentCategory: ()=>state.category,
            setEnabled: v=>{ state.enabled=!!v; if(!v){ try{state.audio.pause();}catch(e){} } },
            toggleOptions,
            ensureOptionsUI,
            startScreenButtonPatch: detectStartScreenAndAddButton,
            playSFX
          };
          // Try to hook common faction selection if present
          const W = window;
          const origSelect = W.selectFaction;
          if(typeof origSelect === 'function'){
            W.selectFaction = function(faction){
              try{
                if(String(faction).toLowerCase().includes('gov')) play('Government');
                else play('Truth');
              }catch(e){}
              return origSelect.apply(this, arguments);
            }
          }
          // Observe DOM to patch start screen when it appears
          const mo = new MutationObserver(()=>detectStartScreenAndAddButton());
          mo.observe(document.documentElement, {childList:true, subtree:true});
          // Also run once after load
          if(document.readyState === 'complete' || document.readyState === 'interactive'){
            setTimeout(()=>{ detectStartScreenAndAddButton(); ensureOptionsUI(); }, 50);
          }else{
            document.addEventListener('DOMContentLoaded', ()=>{
              setTimeout(()=>{ detectStartScreenAndAddButton(); ensureOptionsUI(); }, 50);
            });
          }
        })();
        </script>
<script>
(function(){
  // Robust, unified Options UI manager that works on start screen and in-game
  if (window.OptionsUI) return;
  const has = (x)=> typeof x !== 'undefined' && x !== null;
  const byId = (id)=> document.getElementById(id);
  const settings = window.settings || (window.settings = { expansionsEnabled: [], difficulty:'normal' });
  const audioAPI = (function(){
    // Prefer ShadowAudio if present
    if (window.ShadowAudio){
      return {
        enabled: true,
        category: (window.ShadowAudio.currentCategory && window.ShadowAudio.currentCategory()) || 'Theme',
        setEnabled(v){ this.enabled=!!v; window.ShadowAudio.setEnabled(!!v); },
        setCategory(c){ this.category=c; window.ShadowAudio.setCategory(c); window.ShadowAudio.playCategory(c); },
        play(){ window.ShadowAudio.playCategory(this.category); }
      }
    }
    // Fallback simple audio
    const a = new Audio();
    const api = {
      enabled: true,
      category: 'Theme',
      idx: 1,
      setEnabled(v){ this.enabled = !!v; if(!v) try{ a.pause(); }catch(e){} else this.play(); },
      setCategory(c){ this.category = c; this.idx = 1; this.play(); },
      play(){
        if(!this.enabled) return;
        a.src = `muzak/${this.category}-1.mp3`;
        a.play().catch(()=>{});
      }
    };
    a.addEventListener('ended', ()=>{
      api.idx++;
      a.src = `muzak/${api.category}-${api.idx}.mp3`;
      a.play().catch(()=>{
        api.idx = 1; a.src = `muzak/${api.category}-1.mp3`; a.play().catch(()=>{});
      });
    });
    return api;
  })();

  function listExpansions(){
    try{
      if (Array.isArray(window.availableExpansions)) return window.availableExpansions;
    }catch(e){}
    return []; // none detected
  }
  function isChecked(name){ return Array.isArray(settings.expansionsEnabled) && settings.expansionsEnabled.includes(name); }
  function toggleExp(name, flag){
    if (!Array.isArray(settings.expansionsEnabled)) settings.expansionsEnabled = [];
    if (flag){
      if (!settings.expansionsEnabled.includes(name)) settings.expansionsEnabled.push(name);
    } else {
      settings.expansionsEnabled = settings.expansionsEnabled.filter(n => n !== name);
    }
  }
  function applyExpansions(){
    // Persist if possible
    try{ localStorage.setItem('shadowGovExpansions', JSON.stringify(settings.expansionsEnabled)); }catch(e){}
    if (typeof window.applyExpansionSettings === 'function') { window.applyExpansionSettings(); return; }
    if (typeof window.showStartScreen === 'function') window.showStartScreen();
  }

  const OptionsUI = {
    open(){
      const menu = byId('optionsMenu');
      if (!menu) return;
      menu.classList.add('active');
      this.render();
    },
    close(){
      const menu = byId('optionsMenu');
      if (!menu) return;
      menu.classList.remove('active');
    },
    toggle(){
      const menu = byId('optionsMenu');
      if (!menu) return;
      menu.classList.toggle('active');
      if (menu.classList.contains('active')) this.render();
    },
    render(){
      const menu = byId('optionsMenu');
      if (!menu) return;
      const exps = listExpansions();
      const expHTML = exps.length ? `
        <div class="option-item">
          <label class="option-label">Expansions</label>
          ${exps.map(e => `
            <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
              <input type="checkbox" ${isChecked(e.name) ? 'checked':''} onchange="OptionsUI._toggleExp('${e.name}', this.checked)">
              <span>${e.name}</span><small style="opacity:.7">(${e.cardCount||0} cards)</small>
            </label>
          `).join('')}
          <div style="margin-top:8px">
            <button class="expansion-button" onclick="OptionsUI._applyExp()">APPLY & RESTART</button>
          </div>
        </div>`
      : `<div class="option-item"><label class="option-label">Expansions</label><div class="no-expansions">No expansions detected.</div></div>`;

      const mainMenuBtn = (typeof window.returnToMainMenu === 'function' || typeof window.showStartScreen === 'function')
        ? `<button class="expansion-button" onclick="(window.returnToMainMenu||window.showStartScreen)()">üè† MAIN MENU</button>`
        : ``;

      menu.innerHTML = `
        <div class="option-item">
          <label class="option-label" style="display:block">Audio</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0">
            <input type="checkbox" id="opt-audio-enabled" ${audioAPI.enabled ? 'checked':''}>
            <span>Enable Music & SFX</span>
          </label>
          <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
            <span style="font-weight:700">Music Set:</span>
            <select id="opt-audio-category">
              <option value="Theme">Theme (Menu/General)</option>
              <option value="Government">Government</option>
              <option value="Truth">Truth Seekers</option>
            </select>
            <button id="opt-audio-play">‚ñ∂ Play</button>
          </div>
        </div>
        ${expHTML}
        <div class="option-item" style="border-top:2px solid #111;padding-top:10px;display:flex;gap:10px;justify-content:space-between">
          ${mainMenuBtn}
          <button class="expansion-button" onclick="OptionsUI.close()">CLOSE</button>
        </div>
      `;
      const sel = byId('opt-audio-category'); if (sel) sel.value = audioAPI.category || 'Theme';
      const en = byId('opt-audio-enabled'); if (en) en.onchange = (e)=> audioAPI.setEnabled(!!e.target.checked);
      const btn = byId('opt-audio-play'); if (btn) btn.onclick = ()=> audioAPI.play();
      if (sel) sel.onchange = (e)=> audioAPI.setCategory(e.target.value);
    },
    _toggleExp(name, flag){ toggleExp(name, flag); },
    _applyExp(){ applyExpansions(); }
  };
  window.OptionsUI = OptionsUI;
  // Provide global compat helpers
  window.updateOptionsMenu = ()=> OptionsUI.render();

  // Rewire any existing "OPTIONS" buttons to use OptionsUI
  function wireStartOptions(){
    document.querySelectorAll('.start-screen .start-content button').forEach(b=>{
      if (/options/i.test(b.textContent) && !b.dataset.wiredOptions){
        b.dataset.wiredOptions = '1';
        b.onclick = ()=> OptionsUI.toggle();
      }
    });
  }
  // Observe DOM for start screen
  const mo = new MutationObserver(wireStartOptions);
  mo.observe(document.documentElement, {childList:true, subtree:true});
  // Also try immediately
  wireStartOptions();

  // Ensure gear button (if present) also opens our menu
  document.querySelectorAll('.options-button').forEach(btn=>{
    if(!btn.dataset.wiredOptions){
      btn.dataset.wiredOptions = '1';
      btn.onclick = ()=> OptionsUI.toggle();
    }
  });
})();
</script>

<script>
// ===== R5 OPTIONS START+FULL CONTROLS PATCH =====
(function(){
  // Ensure a single global OptionsUI we can extend
  var OptionsUI = window.OptionsUI || (window.OptionsUI = {
    toggle: function(){
      var m = document.getElementById('optionsMenu');
      if(!m){ m = document.createElement('div'); m.id='optionsMenu'; m.className='options-menu'; document.body.appendChild(m); }
      m.classList.toggle('active');
      if(m.classList.contains('active')) this.render();
    },
    close: function(){ var m=document.getElementById('optionsMenu'); if(m) m.classList.remove('active'); },
    render: function(){
      var m = document.getElementById('optionsMenu'); if(!m) return;
      // Build sections: Core toggles area which may already exist. We'll prepend our controls if missing.
      var top = document.createElement('div');
      top.className = 'option-item';
      top.innerHTML = `
        <label class="option-label">Game</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="expansion-button" id="optViewStats">View Stats</button>
          <button class="expansion-button" id="optQuickSave">Quick Save</button>
          <button class="expansion-button" id="optQuickLoad">Quick Load</button>
          <button class="expansion-button" id="optHowToPlay2">How to Play</button>
        </div>
      `;
      // If not already injected, place at top
      if(!m.querySelector('#optViewStats')){
        m.insertBefore(top, m.firstChild);
      }
      // wire
      var qs = function(sel){ return m.querySelector(sel); };
      var callOrToast = function(fnNames, fallbackMsg){
        for (var i=0;i<fnNames.length;i++){
          var fn = window[fnNames[i]];
          if (typeof fn === 'function'){ try{ fn(); }catch(e){ console.warn(e);} return; }
        }
        alert(fallbackMsg || 'This feature is not available in this build.');
      };
      qs('#optViewStats') && (qs('#optViewStats').onclick = function(){ callOrToast(['showStats','showStatsScreen','openStatsScreen'], 'Stats screen not available.'); });
      qs('#optQuickSave') && (qs('#optQuickSave').onclick = function(){ callOrToast(['quickSave','quickSaveGame','saveGame','doQuickSave'], 'Quick Save not available.'); });
      qs('#optQuickLoad') && (qs('#optQuickLoad').onclick = function(){ callOrToast(['quickLoad','quickLoadGame','loadGame','doQuickLoad'], 'Quick Load not available.'); });
      qs('#optHowToPlay2') && (qs('#optHowToPlay2').onclick = function(){ callOrToast(['openH2PModal'], 'How To Play not available.'); });
      
      // Keep any prior buildOptionsMenu sections (audio/expansions) by calling it after ours
      if(typeof window.buildOptionsMenu === 'function'){
        try{ window.buildOptionsMenu(); }catch(e){ console.warn(e); }
      }
      // Footer with main menu + close
      if(!m.querySelector('#optFooterControls')){
        var foot = document.createElement('div');
        foot.id = 'optFooterControls';
        foot.className = 'option-item';
        foot.style.display = 'flex';
        foot.style.gap = '10px';
        foot.style.justifyContent = 'space-between';
        foot.innerHTML = `
          <button class="expansion-button" id="optMainMenu">üè† MAIN MENU</button>
          <button class="expansion-button" id="optClose">CLOSE</button>
        `;
        m.appendChild(foot);
        var goMain = window.returnToMainMenu || window.showStartScreen;
        m.querySelector('#optMainMenu').onclick = function(){ if(typeof goMain === 'function') goMain(); };
        m.querySelector('#optClose').onclick = function(){ OptionsUI.close(); };
      }
    }
  });
  window.OptionsUI = OptionsUI;
  // Wire any visible start-screen OPTIONS button to toggle
  function wireStartOptions(){
    document.querySelectorAll('.start-screen .start-content button').forEach(function(b){
      if(/options/i.test(b.textContent||'') && !b.dataset.wiredOptions){
        b.dataset.wiredOptions = '1';
        b.onclick = function(e){ e.preventDefault(); OptionsUI.toggle(); };
      }
    });
  }
  // If there is no button, inject one next to START
  function ensureStartButton(){
    var box = document.querySelector('.start-screen .start-content');
    if(!box) return;
    var has = Array.from(box.querySelectorAll('button')).some(function(b){ return /options/i.test((b.textContent||'')); });
    if(!has){
      var btn = document.createElement('button');
      btn.className = 'start-button';
      btn.textContent = 'OPTIONS';
      btn.onclick = function(){ OptionsUI.toggle(); };
      box.appendChild(btn);
    }
  }
  // Observe DOM for start screen
  var mo = new MutationObserver(function(){
    wireStartOptions();
    ensureStartButton();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
  // Run now too
  wireStartOptions();
  ensureStartButton();
  // Also make the top-right gear (if present) call our menu
  document.querySelectorAll('.options-button').forEach(function(btn){
    if(!btn.dataset.wiredOptions){
      btn.dataset.wiredOptions = '1';
      btn.onclick = function(){ OptionsUI.toggle(); };
    }
  });
})();
</script>

<!-- ===== UNIFIED IN-GAME OPTIONS (Gear + ESC) ===== -->
<style>
  #optionsModalUnified.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:35000;}
  #optionsModalUnified .panel{width:min(880px,92vw);background:#0f1318;color:#f5f5f5;border:5px solid #000;padding:16px;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,.6),inset 0 0 0 1px rgba(255,255,255,.05);}
  #optionsModalUnified h2{margin:0 0 10px;font-family:'Anton',sans-serif;letter-spacing:.5px}
  #optionsModalUnified .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  #optionsModalUnified .group{background:#11161c;border:1px solid #2a2f37;border-radius:12px;padding:12px}
  #optionsModalUnified .group h3{margin:0 0 8px;font-size:14px;text-transform:uppercase;letter-spacing:.6px;opacity:.85}
  #optionsModalUnified .optbtn{width:100%;background:#18212b;color:#fff;border:1px solid #263240;padding:12px;border-radius:10px;text-align:left;font-weight:700}
  #optionsModalUnified .optbtn:hover{background:#1b2733}
  #optionsModalUnified .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
  #optionsModalUnified .slider{width:100%}
  #optionsModalUnified .footer{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
  #optionsModalUnified .danger{background:linear-gradient(180deg,#8f2222,#6d1a1a);border-color:#b04343}
  #optionsModalUnified .ok{background:linear-gradient(180deg,#244a18,#1e3b13);border-color:#3e7b2b}
  #optionsModalUnified .sub{display:none;margin-top:10px;border-top:1px dashed #2b3340;padding-top:10px}
  #optionsModalUnified .list{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  #optionsModalUnified .pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #2a2f37;border-radius:10px;background:#0f141a}
  @media (max-width:720px){#optionsModalUnified .grid{grid-template-columns:1fr}}
</style>

<div id="optionsModalUnified" class="overlay" aria-modal="true" role="dialog" aria-label="Options">
  <div class="panel">
    <h2>Options</h2>
    <div class="grid">
      <div class="group">
        <h3>Top Actions</h3>
        <div class="row"><button class="optbtn" id="uoptStats">üìä Statistics</button></div>
        <div class="row"><button class="optbtn" id="uoptQSave">üíæ Quick Save</button></div>
        <div class="row"><button class="optbtn" id="uoptQLoad">üìÇ Quick Load</button></div>
        <div class="row"><button class="optbtn" id="uoptH2P">‚ùì How to Play</button></div>
      </div>
      <div class="group">
        <h3>More</h3>
        <div class="row"><button class="optbtn" id="uoptAudioShow">üîä Audio Settings</button></div>
        <div class="row"><button class="optbtn" id="uoptExpShow">üß© Manage Expansions</button></div>
        <div class="row"><button class="optbtn danger" id="uoptMainMenu">üè† Main Menu</button></div>
      </div>
    </div>

    <div class="sub" id="uAudio">
      <h3>Audio</h3>
      <div class="row"><label>Music</label><input id="uMusicOn" type="checkbox"></div>
      <div class="row"><label>Music Volume</label><input id="uMusicVol" class="slider" type="range" min="0" max="1" step="0.01"></div>
      <div class="row"><label>SFX</label><input id="uSfxOn" type="checkbox"></div>
      <div class="row"><label>SFX Volume</label><input id="uSfxVol" class="slider" type="range" min="0" max="1" step="0.01"></div>
      <div class="row"><label>Now Playing</label><span id="uNowPlayingText" style="opacity:.8">‚Äî</span></div>
      <div class="row"><label>Crossfade</label><input id="uCrossfade" class="slider" type="range" min="0" max="8" step="0.1"></div>
      <div class="row"><label>Shuffle</label><input id="uShuffle" type="checkbox"></div>
      <div class="row"><label>Loop</label><input id="uLoop" type="checkbox"></div>
      <hr style="opacity:.2;margin:8px 0">
      <div class="row"><label>High Contrast</label><input id="uHighContrast" type="checkbox"></div>
      <div class="row"><label>Text Size</label>
        <select id="uTextSize">
          <option value="small">S</option>
          <option value="medium" selected>M</option>
          <option value="large">L</option>
        </select>
      </div>
    </div>

    <div class="sub" id="uExp">
      <h3>Expansions</h3>
      <div class="list" id="uExpList"></div>
      <p style="opacity:.7;font-size:12px;margin-top:6px">Saved in your browser.</p>
    </div>

    <div class="footer">
      <button class="optbtn ok" id="uoptClose">‚úñ Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const modal = $("#optionsModalUnified");

  function show(){ modal.style.display = "flex"; }
  function hide(){ modal.style.display = "none"; }
  function isOpen(){ return getComputedStyle(modal).display !== "none"; }

  function bindGear(){
    const gear = document.querySelector(".options-button, #optionsButton, .gear-button, .options-btn");
    if(gear){ gear.addEventListener("click", ()=>{ openOptionsModalUnified(); }); }
  }

  let _escAt=0;
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const now = performance.now();
      if(now - _escAt < 180) return;
      _escAt = now;
      isOpen() ? hide() : openOptionsModalUnified();
    }
  });

  function call(fn, fallback){
    if (typeof window[fn] === "function") return window[fn]();
    if (fallback) return fallback();
  }

  function toast(msg){
    let t = $("#uToast");
    if(!t){
      t = document.createElement("div");
      t.id = "uToast";
      t.style.cssText = "position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#10161f;border:1px solid #2b3340;padding:10px 14px;border-radius:10px;color:#fff;z-index:40000";
      document.body.appendChild(t);
    }
    t.textContent = msg; t.style.display="block";
    clearTimeout(t._h); t._h = setTimeout(()=> t.style.display="none", 1200);
  }

  // Settings storage
  const SettingsKey = "sg_settings_unified";
  function readSet(){ try{ return JSON.parse(localStorage.getItem(SettingsKey)||'{}'); }catch(e){ return {}; } }
  function writeSet(s){ try{ localStorage.setItem(SettingsKey, JSON.stringify(s)); }catch(e){} }

  function refreshAudioBasics(){
    const s = readSet();
    $("#uMusicOn").checked = s.music !== false;
    $("#uSfxOn").checked   = s.sfx   !== false;
    $("#uMusicVol").value  = s.musicVol ?? 0.6;
    $("#uSfxVol").value    = s.sfxVol   ?? 0.8;
  }

  function applyAudioBasics(){
    const s = readSet();
    s.music   = $("#uMusicOn").checked;
    s.sfx     = $("#uSfxOn").checked;
    s.musicVol= +$("#uMusicVol").value;
    s.sfxVol  = +$("#uSfxVol").value;
    writeSet(s);
    if(window.AudioSys){
      if(AudioSys.setMusicVolume) AudioSys.setMusicVolume(s.music ? s.musicVol : 0);
      if(AudioSys.setSFXVolume)   AudioSys.setSFXVolume(s.sfx ? s.sfxVol : 0);
    }
  }

  ["#uMusicOn","#uSfxOn","#uMusicVol","#uSfxVol"].forEach(sel=>{
    document.addEventListener("input", e=>{ if(e.target.matches(sel)) applyAudioBasics(); }, true);
  });

  function applyAudioAdvanced(s){
    if(window.AudioSys){
      if(typeof AudioSys.setCrossfadeSeconds === 'function') AudioSys.setCrossfadeSeconds(+s.crossfade||0);
      if(typeof AudioSys.setShuffle === 'function') AudioSys.setShuffle(!!s.shuffle);
      if(typeof AudioSys.setLoop === 'function') AudioSys.setLoop(!!s.loop);
    }
  }

  function ensureNowPlaying(){
    const span = document.getElementById('uNowPlayingText');
    const name = (window.AudioSys && (AudioSys.currentTrackName || (AudioSys.getCurrentTrackName && AudioSys.getCurrentTrackName()))) || '';
    span.textContent = (typeof name === 'function') ? name() : (name||'‚Äî');
  }

  // Expansions
  function getSavedFlags(){ try{ return JSON.parse(localStorage.getItem('sg_selected_packs')||'{}'); }catch(e){ return {}; } }
  function setSavedFlags(flags){ try{ localStorage.setItem('sg_selected_packs', JSON.stringify(flags||{})); }catch(e){} }
  function collectPacks(){
    const packs = [];
    const add = (p)=>{ if(p && p.name && !packs.find(x=>x.name===p.name)) packs.push(p); };
    (window.availableExpansions||[]).forEach(add);
    (window.EXPANSION_REGISTRY||[]).forEach(add);
    (window.expansions||[]).forEach(add);
    ['govOpsJson','oppJson','floridaManJson','coldWarJson','probingTimeJson'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return;
      try{ add(JSON.parse(el.textContent||'{}')); }catch(e){}
    });
    return packs;
  }
  function renderExpansions(){
    const list = document.getElementById('uExpList');
    const packs = collectPacks();
    const flags = getSavedFlags();
    list.innerHTML = "";
    if(!packs.length){ list.innerHTML = '<div class="pill" style="opacity:.7">No expansions found</div>'; return; }
    packs.forEach(p=>{
      const row = document.createElement("label"); row.className = "pill";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = flags[p.name] !== false;
      const sp = document.createElement("span"); sp.textContent = (p.icon||"üÉè")+" "+p.name;
      row.appendChild(cb); row.appendChild(sp); list.appendChild(row);
      cb.addEventListener("change", ()=>{
        flags[p.name] = !!cb.checked; setSavedFlags(flags);
        if(typeof window.setExpansionEnabled === "function") window.setExpansionEnabled(p.name, !!cb.checked);
      });
    });
  }

  // A11y & Advanced audio controls
  function applyTextSize(val){
    document.body.classList.remove('text-small','text-medium','text-large');
    const map = {small:'text-small', medium:'text-medium', large:'text-large'};
    document.body.classList.add(map[val] || 'text-medium');
  }
  function applyHighContrast(on){
    document.body.classList.toggle('theme-high-contrast', !!on);
  }

  function bindA11yAndAudioAdv(){
    const textSel = document.getElementById('uTextSize');
    const hc = document.getElementById('uHighContrast');
    const cf = document.getElementById('uCrossfade');
    const sh = document.getElementById('uShuffle');
    const lp = document.getElementById('uLoop');

    if(textSel){
      textSel.addEventListener('change', ()=>{
        const s = readSet(); s.textSize = textSel.value; writeSet(s); applyTextSize(s.textSize);
      });
    }
    if(hc){
      hc.addEventListener('change', ()=>{
        const s = readSet(); s.highContrast = hc.checked; writeSet(s); applyHighContrast(s.highContrast);
      });
    }
    if(cf){
      const upd = ()=>{ const s = readSet(); s.crossfade = +cf.value; writeSet(s); applyAudioAdvanced(s); };
      cf.addEventListener('input', upd); cf.addEventListener('change', upd);
    }
    if(sh){
      sh.addEventListener('change', ()=>{ const s = readSet(); s.shuffle = sh.checked; writeSet(s); applyAudioAdvanced(s); });
    }
    if(lp){
      lp.addEventListener('change', ()=>{ const s = readSet(); s.loop = lp.checked; writeSet(s); applyAudioAdvanced(s); });
    }
  }

  // Autoduck while options open
  let prevVol = null, ducking = false;
  function startDuck(){
    if(!window.AudioSys || typeof AudioSys.setMusicVolume !== 'function') return;
    const s = readSet();
    const current = ('musicVol' in s)? s.musicVol : 0.6;
    if(ducking) return;
    ducking = true;
    prevVol = current;
    const newVol = Math.max(0, Math.min(1, current * 0.75));
    try{ AudioSys.setMusicVolume(s.music===false ? 0 : newVol); }catch(e){}
  }
  function endDuck(){
    if(!window.AudioSys || typeof AudioSys.setMusicVolume !== 'function') return;
    if(prevVol==null) return;
    const s = readSet();
    try{ AudioSys.setMusicVolume(s.music===false ? 0 : prevVol); }catch(e){}
    ducking = false; prevVol = null;
  }

  // Open unified modal
  window.openOptionsModalUnified = function(){
    // Hide any old menu
    const legacy = document.getElementById("optionsMenu");
    if(legacy) legacy.classList.remove("active");

    // populate basic + advanced audio
    refreshAudioBasics();
    const s = readSet();
    if(!('textSize' in s)) s.textSize='medium';
    if(!('highContrast' in s)) s.highContrast=false;
    if(!('crossfade' in s)) s.crossfade=0;
    if(!('shuffle' in s)) s.shuffle=false;
    if(!('loop' in s)) s.loop=false;
    const textSel = document.getElementById('uTextSize'); if(textSel) textSel.value = s.textSize;
    const hc = document.getElementById('uHighContrast'); if(hc) hc.checked = !!s.highContrast;
    const cf = document.getElementById('uCrossfade'); if(cf) cf.value = s.crossfade;
    const sh = document.getElementById('uShuffle'); if(sh) sh.checked = !!s.shuffle;
    const lp = document.getElementById('uLoop'); if(lp) lp.checked = !!s.loop;
    applyTextSize(s.textSize);
    applyHighContrast(s.highContrast);
    applyAudioAdvanced(s);

    ensureNowPlaying();
    renderExpansions();
    show();
    startDuck();
  };

  // Close controls
  document.getElementById('uoptClose').addEventListener('click', hide);
  document.getElementById('uoptStats').addEventListener('click', ()=>{ hide(); call("openStats", ()=>toast("Stats screen")); });
  document.getElementById('uoptQSave').addEventListener('click', ()=>{ call("quickSaveGame", ()=>{ try{ localStorage.setItem('sg_save_stub', JSON.stringify({t:Date.now()})); }catch(e){} toast("Saved"); }); });
  document.getElementById('uoptQLoad').addEventListener('click', ()=>{ call("quickLoadGame", ()=>{ toast("Loaded"); }); });
  document.getElementById('uoptH2P').addEventListener('click', ()=>{ hide(); call("openHowToPlayModalSG") || call("openH2PModal") || toast("How to Play"); });

  document.getElementById('uoptAudioShow').addEventListener('click', ()=>{
    document.getElementById('uAudio').style.display="block";
    document.getElementById('uExp').style.display="none";
    ensureNowPlaying();
  });
  document.getElementById('uoptExpShow').addEventListener('click', ()=>{
    document.getElementById('uAudio').style.display="none";
    document.getElementById('uExp').style.display="block";
    renderExpansions();
  });
  document.getElementById('uoptMainMenu').addEventListener('click', (ev)=>{
    const inRun = !!(window.gameState && (window.gameState.turn || window.gameState.inProgress));
    if(inRun && !confirm('Return to Main Menu?\nUnsaved progress may be lost.')) return;
    hide();
    const start = document.querySelector('.start-screen'); const game = document.querySelector('.game-container');
    if(start) start.style.display = 'flex';
    if(game)  game.style.display  = 'none';
  });

  // Observe modal display to restore ducking on close
  const obs = new MutationObserver(()=>{
    const open = getComputedStyle(modal).display !== 'none';
    if(!open) endDuck();
  });
  obs.observe(modal, { attributes:true, attributeFilter:['style','class'] });

  bindA11yAndAudioAdv();
  bindGear();
})();
</script>

</body>
</html>